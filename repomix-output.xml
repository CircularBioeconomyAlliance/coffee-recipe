This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: *.prompts.md, */.archive/**, docs
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
.python-version
agentcore-cba/cbaindicatoragent/.bedrock_agentcore.yaml
agentcore-cba/cbaindicatoragent/.dockerignore
agentcore-cba/cbaindicatoragent/.gitignore
agentcore-cba/cbaindicatoragent/cdk/.gitignore
agentcore-cba/cbaindicatoragent/cdk/.npmignore
agentcore-cba/cbaindicatoragent/cdk/bin/cdk.ts
agentcore-cba/cbaindicatoragent/cdk/cdk.json
agentcore-cba/cbaindicatoragent/cdk/jest.config.js
agentcore-cba/cbaindicatoragent/cdk/package.json
agentcore-cba/cbaindicatoragent/cdk/README
agentcore-cba/cbaindicatoragent/cdk/tsconfig.json
agentcore-cba/cbaindicatoragent/Dockerfile
agentcore-cba/cbaindicatoragent/mcp/lambda/handler.py
agentcore-cba/cbaindicatoragent/mcp/lambda/requirements.txt
agentcore-cba/cbaindicatoragent/pyproject.toml
agentcore-cba/cbaindicatoragent/README.md
agentcore-cba/cbaindicatoragent/src/kb_tool.py
agentcore-cba/cbaindicatoragent/src/main.py
agentcore-cba/cbaindicatoragent/src/mcp_client/client.py
agentcore-cba/cbaindicatoragent/src/model/load.py
agentcore-cba/cbaindicatoragent/test/__init__.py
agentcore-cba/cbaindicatoragent/test/test_main.py
ARCHITECTURE.md
cba_inputs/CBA ME Background.pdf
cba_inputs/CBA ME Indicators List.xlsx
cba_inputs/cba_logo_blue.png
cba_inputs/cba_logo_white.png
cba_inputs/Indicators for Use Case Regenerative Cotton in Chad.xlsx
cba_inputs/Use Case Coffee Brazil.pdf
cba_inputs/Use Case Regenerative Cotton in Chad.pdf
cba-frontend/app/chat/page.tsx
cba-frontend/app/compare/page.tsx
cba-frontend/app/globals.css
cba-frontend/app/layout.tsx
cba-frontend/app/page.tsx
cba-frontend/app/results/page.tsx
cba-frontend/app/upload/page.tsx
cba-frontend/lib/api.ts
cba-frontend/next-env.d.ts
cba-frontend/next.config.js
cba-frontend/package.json
cba-frontend/postcss.config.js
cba-frontend/QUICKSTART.md
cba-frontend/README.md
cba-frontend/tailwind.config.ts
cba-frontend/tsconfig.json
CLAUDE.md
CODE_REVIEW.md
DEPLOYMENT.md
lambda_function.py
lambda_requirements.txt
PRESENTER_GUIDE.md
pyproject.toml
README.md
scripts/build_lambda_layer.ps1
scripts/build_lambda_layer.sh
src/__init__.py
src/agent.py
src/app.py
src/config.py
src/prompts/prompt_original.txt
src/prompts/system.txt
tests/__init__.py
tests/test_cba_ui.py
tests/test_chat_app.py
tests/test_functions.py
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".python-version">
3.12
</file>

<file path="agentcore-cba/cbaindicatoragent/.bedrock_agentcore.yaml">
default_agent: cbaindicatoragent_Agent
agents:
  cbaindicatoragent_Agent:
    name: cbaindicatoragent_Agent
    entrypoint: /Users/nityans/Documents/VSCode-Backup/CBA-ME/agentcore-cba/cbaindicatoragent/src/main.py
    deployment_type: direct_code_deploy
    runtime_type: PYTHON_3_12
    platform: linux/arm64
    container_runtime: null
    source_path: /Users/nityans/Documents/VSCode-Backup/CBA-ME/agentcore-cba/cbaindicatoragent
    aws:
      execution_role: arn:aws:iam::687995992314:role/BedrockAgentCoreExecutionRole
      execution_role_auto_create: true
      account: '687995992314'
      region: us-west-2
      ecr_repository: null
      ecr_auto_create: false
      s3_path: s3://bedrock-agentcore-codebuild-sources-687995992314-us-west-2
      s3_auto_create: false
      network_configuration:
        network_mode: PUBLIC
        network_mode_config: null
      protocol_configuration:
        server_protocol: HTTP
      observability:
        enabled: true
      lifecycle_configuration:
        idle_runtime_session_timeout: null
        max_lifetime: null
    bedrock_agentcore:
      agent_id: cbaindicatoragent_Agent-buoE288RIT
      agent_arn: arn:aws:bedrock-agentcore:us-west-2:687995992314:runtime/cbaindicatoragent_Agent-buoE288RIT
      agent_session_id: 2bb45fa1-b12a-40c3-a478-a037f4591c6b
    codebuild:
      project_name: null
      execution_role: null
      source_bucket: null
    memory:
      mode: STM_ONLY
      memory_id: cbaindicatoragent_Agent_mem-QAtl509ABJ
      memory_arn: arn:aws:bedrock-agentcore:us-west-2:687995992314:memory/cbaindicatoragent_Agent_mem-QAtl509ABJ
      memory_name: cbaindicatoragent_Agent_mem
      event_expiry_days: 30
      first_invoke_memory_check_done: true
      was_created_by_toolkit: false
    identity:
      credential_providers: []
      workload: null
    aws_jwt:
      enabled: false
      audiences: []
      signing_algorithm: ES384
      issuer_url: null
      duration_seconds: 300
    authorizer_configuration: null
    request_header_configuration: null
    oauth_configuration: null
    api_key_env_var_name: null
    api_key_credential_provider_name: null
    is_generated_by_agentcore_create: true
</file>

<file path="agentcore-cba/cbaindicatoragent/.dockerignore">
# Build artifacts
build/
dist/
*.egg-info/
*.egg

# Python cache
__pycache__/
__pycache__*
*.py[cod]
*$py.class
*.so
.Python

# Virtual environments
.venv/
.env
venv/
env/
ENV/

# Testing
.pytest_cache/
.coverage
.coverage*
htmlcov/
.tox/
*.cover
.hypothesis/
.mypy_cache/
.ruff_cache/

# Development
*.log
*.bak
*.swp
*.swo
*~
.DS_Store

# IDEs
.vscode/
.idea/

# Version control
.git/
.gitignore
.gitattributes

# Documentation
docs/

# CI/CD
.github/
.gitlab-ci.yml
.travis.yml

# Project specific
tests/

# Bedrock AgentCore specific - keep config but exclude runtime files
.bedrock_agentcore.yaml
.dockerignore
.bedrock_agentcore/

# Keep wheelhouse for offline installations
# wheelhouse/

# Monorepo directories
cdk/
terraform/
mcp/lambda/
</file>

<file path="agentcore-cba/cbaindicatoragent/.gitignore">
# Environment variables
.env
.env.local

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Virtual environments
venv/
ENV/
env/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/.gitignore">
*.js
!jest.config.js
*.d.ts
node_modules

# CDK asset staging directory
.cdk.staging
cdk.out
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/.npmignore">
*.ts
!*.d.ts

# CDK asset staging directory
.cdk.staging
cdk.out
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/bin/cdk.ts">
#!/usr/bin/env node
import * as cdk from 'aws-cdk-lib';
import { BaseStackProps } from '../lib/types';
import {
  DockerImageStack,
  AgentCoreStack
} from '../lib/stacks';

const app = new cdk.App();
const deploymentProps: BaseStackProps = {
  appName: "cbaindicatoragent",
  /* If you don't specify 'env', this stack will be environment-agnostic.
   * Account/Region-dependent features and context lookups will not work,
   * but a single synthesized template can be deployed anywhere. */

  /* Uncomment the next line to specialize this stack for the AWS Account
   * and Region that are implied by the current CLI configuration. */
  // env: { account: process.env.CDK_DEFAULT_ACCOUNT, region: process.env.CDK_DEFAULT_REGION },

  /* Uncomment the next line if you know exactly what Account and Region you
   * want to deploy the stack to. */
  // env: { account: '123456789012', region: 'us-east-1' },

  /* For more information, see https://docs.aws.amazon.com/cdk/latest/guide/environments.html */
}
const dockerImageStack = new DockerImageStack(app, `cbaindicatoragent-DockerImageStack`, deploymentProps);
const agentCoreStack = new AgentCoreStack(app, `cbaindicatoragent-AgentCoreStack`, {
  ...deploymentProps,
  imageUri: dockerImageStack.imageUri
});
agentCoreStack.addDependency(dockerImageStack);
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/cdk.json">
{
  "app": "npx ts-node --prefer-ts-exts bin/cdk.ts",
  "watch": {
    "include": [
      "**"
    ],
    "exclude": [
      "README.md",
      "cdk*.json",
      "**/*.d.ts",
      "**/*.js",
      "tsconfig.json",
      "package*.json",
      "yarn.lock",
      "node_modules",
      "test"
    ]
  },
  "context": {
    "@aws-cdk/aws-lambda:recognizeLayerVersion": true,
    "@aws-cdk/core:checkSecretUsage": true,
    "@aws-cdk/core:target-partitions": [
      "aws",
      "aws-cn"
    ],
    "@aws-cdk-containers/ecs-service-extensions:enableDefaultLogDriver": true,
    "@aws-cdk/aws-ec2:uniqueImdsv2TemplateName": true,
    "@aws-cdk/aws-ecs:arnFormatIncludesClusterName": true,
    "@aws-cdk/aws-iam:minimizePolicies": true,
    "@aws-cdk/core:validateSnapshotRemovalPolicy": true,
    "@aws-cdk/aws-codepipeline:crossAccountKeyAliasStackSafeResourceName": true,
    "@aws-cdk/aws-s3:createDefaultLoggingPolicy": true,
    "@aws-cdk/aws-sns-subscriptions:restrictSqsDescryption": true,
    "@aws-cdk/aws-apigateway:disableCloudWatchRole": true,
    "@aws-cdk/core:enablePartitionLiterals": true,
    "@aws-cdk/aws-events:eventsTargetQueueSameAccount": true,
    "@aws-cdk/aws-ecs:disableExplicitDeploymentControllerForCircuitBreaker": true,
    "@aws-cdk/aws-iam:importedRoleStackSafeDefaultPolicyName": true,
    "@aws-cdk/aws-s3:serverAccessLogsUseBucketPolicy": true,
    "@aws-cdk/aws-route53-patters:useCertificate": true,
    "@aws-cdk/customresources:installLatestAwsSdkDefault": false,
    "@aws-cdk/aws-rds:databaseProxyUniqueResourceName": true,
    "@aws-cdk/aws-codedeploy:removeAlarmsFromDeploymentGroup": true,
    "@aws-cdk/aws-apigateway:authorizerChangeDeploymentLogicalId": true,
    "@aws-cdk/aws-ec2:launchTemplateDefaultUserData": true,
    "@aws-cdk/aws-secretsmanager:useAttachedSecretResourcePolicyForSecretTargetAttachments": true,
    "@aws-cdk/aws-redshift:columnId": true,
    "@aws-cdk/aws-stepfunctions-tasks:enableEmrServicePolicyV2": true,
    "@aws-cdk/aws-ec2:restrictDefaultSecurityGroup": true,
    "@aws-cdk/aws-apigateway:requestValidatorUniqueId": true,
    "@aws-cdk/aws-kms:aliasNameRef": true,
    "@aws-cdk/aws-autoscaling:generateLaunchTemplateInsteadOfLaunchConfig": true,
    "@aws-cdk/core:includePrefixInUniqueNameGeneration": true,
    "@aws-cdk/aws-efs:denyAnonymousAccess": true,
    "@aws-cdk/aws-opensearchservice:enableOpensearchMultiAzWithStandby": true,
    "@aws-cdk/aws-lambda-nodejs:useLatestRuntimeVersion": true,
    "@aws-cdk/aws-efs:mountTargetOrderInsensitiveLogicalId": true,
    "@aws-cdk/aws-rds:auroraClusterChangeScopeOfInstanceParameterGroupWithEachParameters": true,
    "@aws-cdk/aws-appsync:useArnForSourceApiAssociationIdentifier": true,
    "@aws-cdk/aws-rds:preventRenderingDeprecatedCredentials": true,
    "@aws-cdk/aws-codepipeline-actions:useNewDefaultBranchForCodeCommitSource": true,
    "@aws-cdk/aws-cloudwatch-actions:changeLambdaPermissionLogicalIdForLambdaAction": true,
    "@aws-cdk/aws-codepipeline:crossAccountKeysDefaultValueToFalse": true,
    "@aws-cdk/aws-codepipeline:defaultPipelineTypeToV2": true,
    "@aws-cdk/aws-kms:reduceCrossAccountRegionPolicyScope": true,
    "@aws-cdk/aws-eks:nodegroupNameAttribute": true,
    "@aws-cdk/aws-ec2:ebsDefaultGp3Volume": true,
    "@aws-cdk/aws-ecs:removeDefaultDeploymentAlarm": true,
    "@aws-cdk/custom-resources:logApiResponseDataPropertyTrueDefault": false,
    "@aws-cdk/aws-s3:keepNotificationInImportedBucket": false,
    "@aws-cdk/aws-ecs:enableImdsBlockingDeprecatedFeature": false,
    "@aws-cdk/aws-ecs:disableEcsImdsBlocking": true,
    "@aws-cdk/aws-ecs:reduceEc2FargateCloudWatchPermissions": true,
    "@aws-cdk/aws-dynamodb:resourcePolicyPerReplica": true,
    "@aws-cdk/aws-ec2:ec2SumTImeoutEnabled": true,
    "@aws-cdk/aws-appsync:appSyncGraphQLAPIScopeLambdaPermission": true,
    "@aws-cdk/aws-rds:setCorrectValueForDatabaseInstanceReadReplicaInstanceResourceId": true,
    "@aws-cdk/core:cfnIncludeRejectComplexResourceUpdateCreatePolicyIntrinsics": true,
    "@aws-cdk/aws-lambda-nodejs:sdkV3ExcludeSmithyPackages": true,
    "@aws-cdk/aws-stepfunctions-tasks:fixRunEcsTaskPolicy": true,
    "@aws-cdk/aws-ec2:bastionHostUseAmazonLinux2023ByDefault": true,
    "@aws-cdk/aws-route53-targets:userPoolDomainNameMethodWithoutCustomResource": true,
    "@aws-cdk/aws-elasticloadbalancingV2:albDualstackWithoutPublicIpv4SecurityGroupRulesDefault": true,
    "@aws-cdk/aws-iam:oidcRejectUnauthorizedConnections": true
  }
}
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/jest.config.js">
module.exports = {
  testEnvironment: 'node',
  roots: ['<rootDir>/test'],
  testMatch: ['**/*.test.ts'],
  transform: {
    '^.+\\.tsx?$': 'ts-jest'
  }
};
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/package.json">
{
  "name": "cdk",
  "version": "0.1.0",
  "bin": {
    "cdk": "bin/cdk.js"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk",
    "cdk:deploy": "cdk deploy --all",
    "cdk:deploy:ci": "cdk deploy --all --require-approval never"
  },
  "devDependencies": {
    "@types/jest": "^29.5.14",
    "@types/node": "22.7.9",
    "aws-cdk": "^2.1031.1",
    "jest": "^29.7.0",
    "ts-jest": "^29.2.5",
    "ts-node": "^10.9.2",
    "typescript": "~5.6.3"
  },
  "dependencies": {
    "aws-cdk-lib": "^2.226.0",
    "constructs": "^10.4.3"
  }
}
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/README">
# Welcome to your CDK TypeScript project

This is a blank project for CDK development with TypeScript.

The `cdk.json` file tells the CDK Toolkit how to execute your app.

## Useful commands

* `npm run build`   compile typescript to js
* `npm run watch`   watch for changes and compile
* `npm run test`    perform the jest unit tests
* `npx cdk deploy`  deploy this stack to your default AWS account/region
* `npx cdk diff`    compare deployed stack with current state
* `npx cdk synth`   emits the synthesized CloudFormation template
</file>

<file path="agentcore-cba/cbaindicatoragent/cdk/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": [
      "es2020",
      "dom"
    ],
    "declaration": true,
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "noImplicitThis": true,
    "alwaysStrict": true,
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": false,
    "inlineSourceMap": true,
    "inlineSources": true,
    "experimentalDecorators": true,
    "strictPropertyInitialization": false,
    "typeRoots": [
      "./node_modules/@types"
    ]
  },
  "exclude": [
    "node_modules",
    "cdk.out"
  ]
}
</file>

<file path="agentcore-cba/cbaindicatoragent/Dockerfile">
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim
WORKDIR /app

# All environment variables in one layer
ENV UV_SYSTEM_PYTHON=1 \
    UV_COMPILE_BYTECODE=1 \
    UV_NO_PROGRESS=1 \
    PYTHONUNBUFFERED=1 \
    DOCKER_CONTAINER=1



COPY pyproject.toml pyproject.toml
# Install from requirements file
RUN uv pip install -r pyproject.toml




RUN uv pip install aws-opentelemetry-distro==0.12.2


# Signal that this is running in Docker for host binding logic
ENV DOCKER_CONTAINER=1

# Create non-root user
RUN useradd -m -u 1000 bedrock_agentcore
USER bedrock_agentcore

EXPOSE 9000
EXPOSE 8000
EXPOSE 8080

# Copy entire project (respecting .dockerignore)
COPY . .

# Use the full module path

CMD ["opentelemetry-instrument", "python", "-m", "src.main"]
</file>

<file path="agentcore-cba/cbaindicatoragent/mcp/lambda/handler.py">
import json
from typing import Any, Dict


def lambda_handler(event, context):
    """
    Generic Lambda handler for Bedrock AgentCore Gateway placeholder tool.

    Expected input:
        event: {
            # optional tool arguments
            "param_0": val0,
            "param_1": val1,
            ...
        }

    Context should contain:
        context.client_context.custom["bedrockAgentCoreToolName"]
        â†’ e.g. "LambdaTarget___placeholder_tool"
    """
    try:
        extended_name = context.client_context.custom.get("bedrockAgentCoreToolName")
        tool_name = None

        # handle agentcore gateway tool naming convention
        # https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-tool-naming.html
        if extended_name and "___" in extended_name:
            tool_name = extended_name.split("___", 1)[1]

        if not tool_name:
            return _response(400, {"error": "Missing tool name"})

        if tool_name != "placeholder_tool":
            return _response(400, {"error": f"Unknown tool '{tool_name}'"})

        result = placeholder_tool(event)
        return _response(200, {"result": result})

    except Exception as e:
        return _response(500, {"system_error": str(e)})


def _response(status_code: int, body: Dict[str, Any]):
    """Consistent JSON response wrapper."""
    return {"statusCode": status_code, "body": json.dumps(body)}


def placeholder_tool(event: Dict[str, Any]):
    """
    no-op placeholder tool.

    Demonstrates argument passing from AgentCore Gateway.
    """
    return {
        "message": "Placeholder tool executed.",
        "string_param": event.get("string_param"),
        "int_param": event.get("int_param"),
        "float_array_param": event.get("float_array_param"),
        "event_args_received": event,
    }
</file>

<file path="agentcore-cba/cbaindicatoragent/mcp/lambda/requirements.txt">
# Add requirements needed for the lambda handler. For example boto3
</file>

<file path="agentcore-cba/cbaindicatoragent/README.md">
This is a monorepo generated by the agentcore create --template production CLI tool!

# Production Ready Checklist

Before using your generated project in a production environment, consult the following checklist:

- [ ] **Security:** Ensure secrets and API keys are properly handled. AgentCore Identity or AWS Secrets Manager are secure managed solutions.
- [ ] **Build Environment:** Confirm Docker builds are being executed in the desired environment. This template uses local Docker builds by default. Consider AWS CodeBuild.
- [ ] **Observability:** After deploying, [enable AgentCore observability](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/observability-configure.html#observability-configure-builtin) to allow OpenTelemetry span data to be published to AWS CloudWatch.
- [ ] **CI/CD:** Build your new project into a CI/CD pipeline to achieve automated builds, rollbacks, and multiple deployment environments. Consider AWS CodePipeline.
- [ ] **Access Control:** Configure access for clients to call into your AgentCore Runtime. Take advantage of the multiple endpoints (DEFAULT, PROD, DEV) created by this template.
- [ ] **Testing** Write unit tests in the generated `test/` directory. Implement E2E tests for further coverage.
- [ ] **Error Handling** Implement graceful and consistent error handling logic throughout your code.

# Layout

There are three main directories created in this project: `src`, `mcp`, and `cdk`. In a monorepo setup all of the codeâ€”source, test, and IaC for deploymentâ€”is contained in one repository. Everything needed to
define runtime code and deploy it into your AWS account is contained in this project.

The `cdk` directory models all of the Bedrock AgentCore and related resources. There are direct references between `cdk` and the runtime `src/`. For example, the IaC code expects to find the
Dockerfile at a specific relative path.

## src/

The `src/` directory is where you will find the runtime code.

Start with main entrypoint to the generated app, `src/main.py`. This file defines an agent using Strands and defines an entrypoint method with the Bedrock AgentCore SDK:

```
@app.entrypoint
def invoke(payload):
    # assume payload input is structured as { "prompt": "<user input>" }
```

Next there is the `src/mcp_client` directory. Here you will find `client.py`. This file defines an MCP client from the chosen Strands library. That client points to the
gateway URL for the AgentCore gateway that is modeled in the `cdk` directory. Behind that gateway is a custom MCP tool modeled as a Lambda function (see below `mcp/` section for more details).
The authorizer for the gateway is a Cognito app client that is modeled in the `cdk` directory. A call using
the client_credentials flow is defined in `_get_access_token()`.

## mcp/

The `mcp/` directory defines a simple Python tool that meets the MCP specification called `placeholder_tool`. The specification for the tool's inputs is defined in the inline schema in the modeled
`cdk` directory. When replacing the dummy implementation in `mcp/lambda/handler.py`, make sure to update the corresponding Lambda target schema to reflect the changes before re-deploying.
The `placeholder_tool` implementation demonstrates the tool name and input payload conventions of a Lambda behind the gateway. The gateway supports [flexible target types](https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/gateway-add-target-api.html).

## cdk/

This directory contains a CDK project that models AgentCore and related AWS resources.

First check that Node version is >= 18:
- `node -v` â†’ example output: `v18.19.0`
- [nvm](https://github.com/nvm-sh/nvm) is a helpful tool to manage Node versions

Make sure you have AWS credentials with sufficient permissions in your environment.

To deploy your project:

- shorthand: `cd cdk && npm install && npm run cdk synth && npm run cdk:deploy`
- navigate to the `cdk` directory: `cd cdk`
- install dependencies: `npm install`
- synth the CDK project: `npm run cdk synth`
- deploy all stacks: `npm run cdk:deploy`

# `agentcore create` output

Primarily, `agentcore create` outputs the directory that this `README.md` file is contained in. Nothing is deployed into AWS automatically.
Execute the appropriate deployment commands in the `cdk` directory to deploy.

There is also a `.bedrock_agentcore.yaml` file output in the `cbaindicatoragent` directory. This file contains a minimal definition with your agent name when it is created. After deploying the project, when running
`agentcore invoke` or `agentcore status`, the command updates `.bedrock_agentcore.yaml` with the ID and ARN of your runtime so the CLI can successfully call the runtime using boto3.

# Invoking the deployed Runtime

The two easiest ways to invoke your runtime after deploying:

1. `agentcore invoke`
   Example:
   ```
   agentcore invoke '{"prompt": "what can you do?"}'
   ```

2. Navigate to the â€œTest Consoleâ€ page in the Bedrock AgentCore AWS console. Select your runtime and the `DEFAULT` version. Provide an input.
   Example:
   ```
   {"prompt": "what can you do?"}
   ```
</file>

<file path="agentcore-cba/cbaindicatoragent/src/kb_tool.py">
"""Knowledge Base retrieval tool for CBA Indicator Selection"""
import os
import boto3
from strands import tool

KNOWLEDGE_BASE_ID = os.getenv("KNOWLEDGE_BASE_ID", "0ZQBMXEKDI")
REGION = os.getenv("AWS_REGION", "us-west-2")

# Initialize bedrock-agent-runtime client
bedrock_agent_runtime = boto3.client(
    'bedrock-agent-runtime',
    region_name=REGION
)

@tool
def search_cba_indicators(query: str, max_results: int = 10) -> str:
    """
    Search the CBA M&E Framework Knowledge Base for relevant indicators and methods.
    
    Args:
        query: Natural language query about indicators, methods, or project requirements
        max_results: Maximum number of results to return (default: 10)
    
    Returns:
        Formatted string with relevant indicators and methods from the knowledge base
    """
    try:
        response = bedrock_agent_runtime.retrieve(
            knowledgeBaseId=KNOWLEDGE_BASE_ID,
            retrievalQuery={
                'text': query
            },
            retrievalConfiguration={
                'vectorSearchConfiguration': {
                    'numberOfResults': max_results
                }
            }
        )
        
        # Format the results
        results = []
        for idx, result in enumerate(response.get('retrievalResults', []), 1):
            content = result.get('content', {}).get('text', '')
            score = result.get('score', 0)
            
            # Get metadata if available
            metadata = result.get('metadata', {})
            source = metadata.get('source', 'Unknown')
            
            results.append(f"""
Result {idx} (Relevance: {score:.2f}):
Source: {source}
Content: {content}
---
""")
        
        if not results:
            return "No relevant indicators or methods found for this query."
        
        return "\n".join(results)
        
    except Exception as e:
        return f"Error searching knowledge base: {str(e)}"


@tool
def search_indicators_by_outcome(outcome: str) -> str:
    """
    Search for indicators specifically aligned with a desired project outcome.
    
    Args:
        outcome: The desired project outcome (e.g., "reduce waste", "increase income")
    
    Returns:
        Indicators that measure progress toward this outcome
    """
    query = f"indicators that measure {outcome} in circular bioeconomy projects"
    return search_cba_indicators(query, max_results=5)


@tool
def search_methods_by_budget(budget_range: str, commodity: str = "") -> str:
    """
    Search for measurement methods appropriate for a given budget range.
    
    Args:
        budget_range: Budget range (e.g., "low", "medium", "high", "$0-10k", "$10k-50k")
        commodity: Optional commodity/product type to filter methods
    
    Returns:
        Methods that fit within the specified budget
    """
    commodity_filter = f"for {commodity} " if commodity else ""
    query = f"measurement methods {commodity_filter}with {budget_range} budget cost-effective affordable"
    return search_cba_indicators(query, max_results=5)


@tool
def search_location_specific_indicators(location: str, commodity: str = "") -> str:
    """
    Search for indicators and considerations specific to a geographic location.
    
    Args:
        location: Geographic location or region
        commodity: Optional commodity/product type
    
    Returns:
        Location-specific indicators and implementation considerations
    """
    commodity_filter = f"{commodity} " if commodity else ""
    query = f"{commodity_filter}indicators and methods for {location} region location-specific considerations"
    return search_cba_indicators(query, max_results=5)
</file>

<file path="agentcore-cba/cbaindicatoragent/src/mcp_client/client.py">
import os
from mcp.client.streamable_http import streamablehttp_client
from strands.tools.mcp.mcp_client import MCPClient
import requests

COGNITO_TOKEN_URL = os.getenv("COGNITO_TOKEN_URL")
COGNITO_CLIENT_ID = os.getenv("COGNITO_CLIENT_ID")
COGNITO_CLIENT_SECRET = os.getenv("COGNITO_CLIENT_SECRET")
COGNITO_SCOPE = os.getenv("COGNITO_SCOPE")

def _get_access_token():
    """
    Make a POST request to the Cognito OAuth token URL using client credentials.
    """
    response = requests.post(
        COGNITO_TOKEN_URL,
        auth=(COGNITO_CLIENT_ID, COGNITO_CLIENT_SECRET),
        data={
            "grant_type": "client_credentials",
            "scope": COGNITO_SCOPE,
        },
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )
    return response.json()["access_token"]


def get_streamable_http_mcp_client() -> MCPClient:
    """
    Returns an MCP Client for AgentCore Gateway compatible with Strands
    """
    gateway_url = os.getenv("GATEWAY_URL")
    if not gateway_url:
        raise RuntimeError("Missing required environment variable: GATEWAY_URL")
    access_token = _get_access_token()
    return MCPClient(lambda: streamablehttp_client(gateway_url, headers={"Authorization": f"Bearer {access_token}"}))
</file>

<file path="agentcore-cba/cbaindicatoragent/src/model/load.py">
from strands.models import BedrockModel

# Uses global inference profile for Claude Sonnet 4.5
# https://docs.aws.amazon.com/bedrock/latest/userguide/inference-profiles-support.html
MODEL_ID = "global.anthropic.claude-sonnet-4-5-20250929-v1:0"

def load_model() -> BedrockModel:
    """
    Get Bedrock model client.
    Uses IAM authentication via the execution role.
    """
    return BedrockModel(model_id=MODEL_ID)
</file>

<file path="agentcore-cba/cbaindicatoragent/test/__init__.py">
# Test package
</file>

<file path="agentcore-cba/cbaindicatoragent/test/test_main.py">
# import pytest
# from unittest.mock import Mock, patch, AsyncMock, MagicMock
# import sys
# from pathlib import Path

# # Add src to path for imports
# sys.path.insert(0, str(Path(__file__).parent.parent / "src"))
# # Mock MCP client to prevent Gateway connection attempts
# mock_mcp_client = Mock()
# mock_mcp_client.list_tools_sync.return_value = []
# mock_mcp_client.__enter__ = Mock(return_value=mock_mcp_client)
# mock_mcp_client.__exit__ = Mock(return_value=False)
# with patch('mcp_client.client.get_streamable_http_mcp_client', return_value=mock_mcp_client):
#     from main import app, invoke

# class TestAgent:

#     @patch('main.model')
#     @patch('main.Agent')
#     def test_invoke_with_prompt(self, mock_agent_class, mock_model):
#         """Test invoke function with user prompt"""
#         mock_agent = Mock()
#         mock_agent.return_value = "Test response"
#         mock_agent_class.return_value = mock_agent

#         payload = {"prompt": "Hello, how are you?"}
#         result = invoke(payload)

#         mock_agent.assert_called_once_with("Hello, how are you?")
#         assert result == {"response": "Test response"}

# class TestBedrockAgentCoreApp:
#     def test_app_initialization(self):
#         """Test that BedrockAgentCoreApp is properly initialized"""
#         assert app is not None
#         assert hasattr(app, 'entrypoint')

#     def test_entrypoint_decorator(self):
#         """Test that entrypoint function is properly decorated"""

#         assert hasattr(invoke, '__name__')
#         assert invoke.__name__ == 'invoke'
</file>

<file path="cba-frontend/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    @apply bg-cba-navy text-white;
  }
}

@layer utilities {
  .text-gradient {
    @apply bg-gradient-to-r from-cba-gold to-cba-gold-light bg-clip-text text-transparent;
  }
  
  .card-glow {
    box-shadow: 0 0 20px rgba(251, 173, 23, 0.1);
  }
  
  .card-glow-hover:hover {
    box-shadow: 0 0 30px rgba(251, 173, 23, 0.2);
  }
}
</file>

<file path="cba-frontend/app/layout.tsx">
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "CBA Indicator Selection | Circular Bioeconomy Alliance",
  description: "AI-powered indicator recommendation for sustainable agriculture monitoring",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  );
}
</file>

<file path="cba-frontend/next-env.d.ts">
/// <reference types="next" />
/// <reference types="next/image-types/global" />
/// <reference path="./.next/types/routes.d.ts" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
</file>

<file path="cba-frontend/next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',
  images: {
    unoptimized: true
  }
}

module.exports = nextConfig
</file>

<file path="cba-frontend/package.json">
{
  "name": "cba-frontend",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "^15.1.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "framer-motion": "^11.15.0",
    "lucide-react": "^0.468.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "tailwind-merge": "^2.6.0"
  },
  "devDependencies": {
    "@types/node": "^22",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "typescript": "^5.7",
    "tailwindcss": "^3.4.17",
    "postcss": "^8.4.49",
    "autoprefixer": "^10.4.20",
    "eslint": "^9",
    "eslint-config-next": "^15.1.0"
  }
}
</file>

<file path="cba-frontend/postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="cba-frontend/QUICKSTART.md">
# ğŸš€ Quick Start Guide

## Run the Frontend

```bash
cd cba-frontend
npm run dev
```

Open **http://localhost:3000**

## What's Built

### âœ… Pages

1. **Landing Page** (`/`)
   - Professional hero section
   - Two entry point cards
   - Smooth animations
   - CBA branding

2. **Chat Interface** (`/chat`)
   - Real-time chat with AI
   - Live project profile sidebar
   - Progress tracking
   - Smooth message animations
   - Simulated AI responses

3. **File Upload** (`/upload`)
   - Drag & drop file upload
   - File analysis simulation
   - Missing info detection
   - Completion flow

### ğŸ¨ Design Features

- **Colors**: Navy (#031f35) + Gold (#FBAD17)
- **Animations**: Framer Motion
- **Icons**: Lucide React
- **Typography**: Inter font
- **Effects**: Card glows, gradients, smooth transitions

### ğŸ“± Responsive

- Mobile-friendly
- Tablet optimized
- Desktop enhanced

## Next Steps

1. **Backend Integration**
   - Connect to Bedrock Agent API
   - Real file parsing
   - Actual KB search

2. **Additional Pages**
   - Results/Indicators page
   - Comparison view
   - Export functionality

3. **Components**
   - Indicator cards
   - Method selector
   - Filter sidebar

## Tech Stack

- Next.js 15
- React 19
- TypeScript
- Tailwind CSS
- Framer Motion
- Lucide Icons
</file>

<file path="cba-frontend/README.md">
# CBA Indicator Selection - Frontend

Modern, professional web application for CBA Monitoring & Evaluation indicator selection.

## Tech Stack

- **Next.js 15** - React framework with App Router
- **React 19** - Latest React with improved performance
- **TypeScript** - Type safety
- **Tailwind CSS** - Utility-first styling
- **Framer Motion** - Smooth animations
- **Lucide React** - Beautiful icons

## Design System

### Colors
- **Navy**: `#031f35` (Primary background)
- **Gold**: `#FBAD17` (Accent/CTA)
- **Navy Light**: `#0a2a42` (Cards)
- **Navy Dark**: `#011628` (Header)

### Features
- Responsive design
- Smooth animations
- Card-based layout with glow effects
- Gradient text effects
- Professional typography

## Development

```bash
# Install dependencies
npm install

# Run dev server
npm run dev

# Build for production
npm run build

# Start production server
npm start
```

Open [http://localhost:3000](http://localhost:3000)

## Project Structure

```
cba-frontend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ layout.tsx       # Root layout
â”‚   â”œâ”€â”€ page.tsx         # Landing page
â”‚   â””â”€â”€ globals.css      # Global styles
â”œâ”€â”€ components/          # Reusable components (to be added)
â”œâ”€â”€ lib/                 # Utilities (to be added)
â””â”€â”€ public/              # Static assets
```

## Next Steps

1. âœ… Landing page with dual entry points
2. âœ… Chat interface component
3. âœ… File upload component
4. âœ… Indicator cards component
5. âœ… Comparison view
6. ğŸ”„ Backend API integration
7. ğŸ”„ Export functionality (PDF/CSV)
</file>

<file path="cba-frontend/tailwind.config.ts">
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      colors: {
        cba: {
          navy: "#031f35",
          gold: "#FBAD17",
          "navy-light": "#0a2a42",
          "navy-dark": "#011628",
          "gold-light": "#ffc04d",
          "gold-dark": "#e09a00",
        },
      },
      animation: {
        "fade-in": "fadeIn 0.5s ease-in-out",
        "slide-up": "slideUp 0.5s ease-out",
        "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
      },
      keyframes: {
        fadeIn: {
          "0%": { opacity: "0" },
          "100%": { opacity: "1" },
        },
        slideUp: {
          "0%": { transform: "translateY(20px)", opacity: "0" },
          "100%": { transform: "translateY(0)", opacity: "1" },
        },
      },
    },
  },
  plugins: [],
};
export default config;
</file>

<file path="cba-frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
</file>

<file path="DEPLOYMENT.md">
# CBA Indicator Selection Assistant - Deployment Guide

This guide covers deploying the CBA Indicator Selection Assistant.

## Table of Contents

- [Hackathon Quick Start](#hackathon-quick-start) - **Start here for demos**
- [Prerequisites](#prerequisites)
- [Architecture Overview](#architecture-overview)
- [1. Local Development](#1-local-development)
- [2. AgentCore Deployment (CDK)](#2-agentcore-deployment-cdk)
- [3. Lambda Function Deployment](#3-lambda-function-deployment)
- [4. Frontend Deployment](#4-frontend-deployment)
- [5. Environment Variables Reference](#5-environment-variables-reference)
- [6. Post-Deployment Verification](#6-post-deployment-verification)
- [7. Troubleshooting](#7-troubleshooting)

---

## Hackathon Quick Start

**Goal:** Run the frontend locally on your laptop using the pre-deployed AWS backend.  
**You do NOT need AWS credentials for this section.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HACKATHON SETUP                                     â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚   LAPTOP     â”‚                      â”‚           AWS CLOUD             â”‚ â”‚
â”‚   â”‚              â”‚                      â”‚                                 â”‚ â”‚
â”‚   â”‚  Next.js     â”‚  â”€â”€â”€â”€â”€ HTTPS â”€â”€â”€â”€â”€â–º  â”‚  API Gateway â†’ Lambda â†’        â”‚ â”‚
â”‚   â”‚  Frontend    â”‚                      â”‚  AgentCore â†’ Knowledge Base    â”‚ â”‚
â”‚   â”‚  (localhost) â”‚  â—„â”€â”€â”€â”€ JSON â”€â”€â”€â”€â”€â”€   â”‚                                 â”‚ â”‚
â”‚   â”‚              â”‚                      â”‚                                 â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Step 0: Check Node.js

```bash
node -v
```

You must see **v18.18+** (or v20+). If not, install/update Node.js first.

### Step 1: Clone the Repository (skip if already cloned)

```bash
git clone https://github.com/CircularBioeconomyAlliance/coffee-recipe.git
cd coffee-recipe
```

### Step 2: Install Frontend Dependencies

```bash
cd cba-frontend
npm install
```

### Step 3: Run the Frontend

```bash
npm run dev
```

**Open:** http://localhost:3000  
You should see the landing page within 5-10 seconds.

**Default backend URL (pre-deployed):**  
`https://pjuuem2fn8.execute-api.us-west-2.amazonaws.com/prod`

### If Chat Shows "Sorry, I encountered an error"

This means the backend is **not responding** or the API URL is wrong.

Quick check:
```bash
curl -X POST https://pjuuem2fn8.execute-api.us-west-2.amazonaws.com/prod/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"hello"}'
```

If this fails, the AWS backend is down or not deployed.

### Whatâ€™s Running Where?

| Component | Location | URL |
|-----------|----------|-----|
| **Frontend** | Your laptop | http://localhost:3000 |
| **API Gateway** | AWS | https://pjuuem2fn8.execute-api.us-west-2.amazonaws.com/prod |
| **Lambda** | AWS | Handles `/chat`, `/upload`, `/recommendations` |
| **AgentCore** | AWS | Strands agent with Claude Sonnet |
| **Knowledge Base** | AWS | 801 methods, 224 indicators |

### Demo Flow

1. **Landing Page** â†’ Choose "Chat" or "Upload Document"
2. **Chat** â†’ Answer 4 questions (location, commodity, budget, outcomes)
3. **Results** â†’ View recommended indicators and methods
4. **Compare** â†’ Compare indicators side-by-side

**Upload note:** PDF only (max 10MB).

### Using Your Own Backend (Optional)

Set the API URL before running:

**macOS/Linux:**
```bash
export NEXT_PUBLIC_API_URL=https://your-api-id.execute-api.us-west-2.amazonaws.com/prod
npm run dev
```

**Windows PowerShell:**
```powershell
$env:NEXT_PUBLIC_API_URL="https://your-api-id.execute-api.us-west-2.amazonaws.com/prod"
npm run dev
```

**Windows CMD:**
```cmd
set NEXT_PUBLIC_API_URL=https://your-api-id.execute-api.us-west-2.amazonaws.com/prod
npm run dev
```

---

## Prerequisites

### Required Tools

| Tool | Version | Purpose |
|------|---------|---------|
| Python | 3.12+ | Backend runtime |
| Node.js | 18.18+ | Frontend and CDK |
| Docker | Latest | AgentCore container builds |
| AWS CLI | 2.x | AWS deployments |
| uv | Latest | Python package management |

**If you are only doing Hackathon Quick Start:** you only need **Node.js**.

### Verify Tools Are Installed (copy/paste)

```bash
node -v
npm -v
python --version
aws --version
docker --version
uv --version
```

If any command says **"not found"**, install that tool before continuing.

### AWS Access Requirements

You need an AWS account with access to:

- **Amazon Bedrock** - Claude model access (request via AWS Console)
- **Amazon Bedrock AgentCore** - Agent runtime
- **Amazon Bedrock Knowledge Base** - CBA indicators KB (ID: `0ZQBMXEKDI`)
- **Amazon S3** - File upload storage
- **AWS Lambda** - API handlers
- **Amazon API Gateway** - HTTP endpoints
- **Amazon ECR** - Docker image registry

**Set your default region (recommended):**
```bash
aws configure set region us-west-2
```

### Request Bedrock Model Access

Before deploying, ensure you have access to Claude models:

1. Open the [Amazon Bedrock Console](https://console.aws.amazon.com/bedrock)
2. Navigate to **Model access** in the sidebar
3. Click **Manage model access**
4. Select **Anthropic Claude** models (Claude Sonnet 4)
5. Click **Request model access**

### Confirm AWS Credentials (Required for Deployment)

```bash
aws sts get-caller-identity
```

You must see your AWS account ID. If this fails, **stop and fix credentials** before proceeding.

---

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js       â”‚â”€â”€â”€â”€â–¶â”‚   API Gateway    â”‚â”€â”€â”€â”€â–¶â”‚   Lambda Function  â”‚
â”‚   Frontend      â”‚     â”‚   (HTTP API)     â”‚     â”‚   (Router)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                                  â”‚              â”‚
                        â–¼                                  â–¼              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ AgentCore       â”‚              â”‚   S3         â”‚   â”‚ Bedrock  â”‚
              â”‚ Runtime         â”‚              â”‚   (Uploads)  â”‚   â”‚ (Claude) â”‚
              â”‚ (Strands Agent) â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Knowledge Base  â”‚
              â”‚ (Indicators)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Local Development

### Streamlit App (Development UI)

```bash
# Clone the repository
git clone https://github.com/CircularBioeconomyAlliance/coffee-recipe.git
cd coffee-recipe

# Install Python dependencies
uv sync

# Set AWS credentials
export AWS_DEFAULT_REGION=us-west-2
export AWS_ACCESS_KEY_ID=<your-access-key>
export AWS_SECRET_ACCESS_KEY=<your-secret-key>
export AWS_SESSION_TOKEN=<your-session-token>  # If using temporary credentials

# Run Streamlit app
uv run streamlit run src/app.py
```

Opens at `http://localhost:8501`

### CLI Agent (Testing)

```bash
uv run python src/agent.py
```

### Frontend (Next.js)

```bash
cd cba-frontend

# Install dependencies
npm install

# Set API URL for local development (choose your OS)
export NEXT_PUBLIC_API_URL=https://your-api-gateway-url.execute-api.us-west-2.amazonaws.com/prod

# Run development server
npm run dev
```

**Windows PowerShell:**
```powershell
$env:NEXT_PUBLIC_API_URL="https://your-api-gateway-url.execute-api.us-west-2.amazonaws.com/prod"
npm run dev
```

**Windows CMD:**
```cmd
set NEXT_PUBLIC_API_URL=https://your-api-gateway-url.execute-api.us-west-2.amazonaws.com/prod
npm run dev
```

Opens at `http://localhost:3000`

---

## 2. AgentCore Deployment (CDK)

The AgentCore agent runs in a Docker container on Bedrock AgentCore Runtime.

### Step 1: Navigate to CDK Directory

```bash
cd agentcore-cba/cbaindicatoragent/cdk
```

### Step 2: Install CDK Dependencies

```bash
npm install
```

### Step 3: Bootstrap CDK (First Time Only)

```bash
npx cdk bootstrap aws://<ACCOUNT_ID>/<REGION>
```

### Step 4: Synthesize and Deploy

```bash
# Synthesize CloudFormation templates
npm run cdk synth

# Deploy all stacks
npm run cdk:deploy
```

This creates:
- **ECR Repository** - Docker image storage
- **AgentCore Runtime** - Container-based agent
- **AgentCore Gateway** - MCP protocol endpoint
- **AgentCore Memory** - Session storage (30-day TTL)
- **Cognito User Pool** - JWT authentication

### Step 5: Note the Output ARNs

After deployment, note these values from the CDK output:

```
AgentCoreStack.RuntimeArn = arn:aws:bedrock-agentcore:us-west-2:XXXX:runtime/cbaindicatoragent_Agent-XXXX
AgentCoreStack.GatewayUrl = https://XXXX.execute-api.us-west-2.amazonaws.com
```

### Test AgentCore Deployment

```bash
# From the agentcore-cba/cbaindicatoragent directory
agentcore invoke '{"prompt": "What indicators do you have for coffee projects in Brazil?"}'
```

---

## 3. Lambda Function Deployment

The Lambda function (`lambda_function.py`) handles API requests and routes to AgentCore.

### Step 0: Set Your Values (replace placeholders)

You will use these values repeatedly:

- `<ACCOUNT_ID>`: Your AWS account ID  
  ```bash
  aws sts get-caller-identity --query Account --output text
  ```
- `<REGION>`: Use `us-west-2` unless you deployed elsewhere
- `<UPLOAD_BUCKET>`: Must be globally unique (example: `cba-indicator-uploads-<ACCOUNT_ID>`)

### Step 1: Build Lambda Layer

The Lambda requires `pypdf` for PDF processing. Build a layer:

**On Linux/Mac:**
```bash
chmod +x scripts/build_lambda_layer.sh
./scripts/build_lambda_layer.sh
```

**On Windows (PowerShell):**
```powershell
.\scripts\build_lambda_layer.ps1
```

**Using Docker (Recommended for Lambda Compatibility):**
```bash
docker run --rm -v ${PWD}:/var/task public.ecr.aws/sam/build-python3.12 \
  pip install -r lambda_requirements.txt -t lambda_layer/python

cd lambda_layer && zip -r ../cba-lambda-dependencies.zip python/
```

### Step 2: Publish Lambda Layer

```bash
aws lambda publish-layer-version \
  --layer-name cba-lambda-dependencies \
  --zip-file fileb://cba-lambda-dependencies.zip \
  --compatible-runtimes python3.12 python3.11 \
  --compatible-architectures x86_64
```

Note the `LayerVersionArn` from the output.

### Step 3: Create the Lambda IAM Role (one-time)

1) Create a trust policy file `lambda-trust-policy.json`:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "lambda.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

2) Create the role and attach basic logging:
```bash
aws iam create-role \
  --role-name cba-lambda-role \
  --assume-role-policy-document file://lambda-trust-policy.json

aws iam attach-role-policy \
  --role-name cba-lambda-role \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
```

3) Attach permissions for S3 + Bedrock + AgentCore:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    { "Effect": "Allow", "Action": ["s3:PutObject"], "Resource": "arn:aws:s3:::<UPLOAD_BUCKET>/*" },
    { "Effect": "Allow", "Action": ["bedrock:InvokeModel"], "Resource": "*" },
    { "Effect": "Allow", "Action": ["bedrock-agentcore:InvokeAgentRuntime"], "Resource": "*" }
  ]
}
```

Save this as `lambda-policy.json`, then run:
```bash
aws iam put-role-policy \
  --role-name cba-lambda-role \
  --policy-name cba-lambda-inline \
  --policy-document file://lambda-policy.json
```

### Step 4: Create or Update the Lambda Function

**Create the Lambda function:**

```bash
# Zip the Lambda code
zip lambda_function.zip lambda_function.py

# Create function
aws lambda create-function \
  --function-name cba-indicator-api \
  --runtime python3.12 \
  --role arn:aws:iam::<ACCOUNT_ID>:role/cba-lambda-role \
  --handler lambda_function.lambda_handler \
  --zip-file fileb://lambda_function.zip \
  --timeout 60 \
  --memory-size 512 \
  --layers <LAYER_VERSION_ARN> \
  --environment "Variables={BEDROCK_AGENTCORE_ARN=<AGENTCORE_RUNTIME_ARN>,UPLOAD_BUCKET_NAME=<UPLOAD_BUCKET>,AWS_REGION=<REGION>}"
```

**Or update existing function:**

```bash
zip lambda_function.zip lambda_function.py

aws lambda update-function-code \
  --function-name cba-indicator-api \
  --zip-file fileb://lambda_function.zip
```

If you need to update environment variables or layers later:
```bash
aws lambda update-function-configuration \
  --function-name cba-indicator-api \
  --layers <LAYER_VERSION_ARN> \
  --environment "Variables={BEDROCK_AGENTCORE_ARN=<AGENTCORE_RUNTIME_ARN>,UPLOAD_BUCKET_NAME=<UPLOAD_BUCKET>,AWS_REGION=<REGION>}"
```

### Step 5: Create S3 Bucket for Uploads

```bash
aws s3 mb s3://<UPLOAD_BUCKET> --region <REGION>
```

### Step 6: Create API Gateway (HTTP API)

**macOS/Linux:**
```bash
# Create HTTP API
API_ID=$(aws apigatewayv2 create-api \
  --name cba-indicator-api \
  --protocol-type HTTP \
  --cors-configuration AllowOrigins="*",AllowMethods="GET,POST,OPTIONS",AllowHeaders="Content-Type" \
  --query ApiId --output text)

# Create Lambda integration
INTEGRATION_ID=$(aws apigatewayv2 create-integration \
  --api-id $API_ID \
  --integration-type AWS_PROXY \
  --integration-uri arn:aws:lambda:<REGION>:<ACCOUNT_ID>:function:cba-indicator-api \
  --payload-format-version 2.0 \
  --query IntegrationId --output text)

# Create routes
aws apigatewayv2 create-route --api-id $API_ID --route-key "POST /chat" --target integrations/$INTEGRATION_ID
aws apigatewayv2 create-route --api-id $API_ID --route-key "POST /upload" --target integrations/$INTEGRATION_ID
aws apigatewayv2 create-route --api-id $API_ID --route-key "GET /recommendations" --target integrations/$INTEGRATION_ID
aws apigatewayv2 create-route --api-id $API_ID --route-key "OPTIONS /{proxy+}" --target integrations/$INTEGRATION_ID

# Create stage
aws apigatewayv2 create-stage --api-id $API_ID --stage-name prod --auto-deploy
```

**Windows PowerShell:**
```powershell
$apiId = aws apigatewayv2 create-api `
  --name cba-indicator-api `
  --protocol-type HTTP `
  --cors-configuration AllowOrigins="*",AllowMethods="GET,POST,OPTIONS",AllowHeaders="Content-Type" `
  --query ApiId --output text

$integrationId = aws apigatewayv2 create-integration `
  --api-id $apiId `
  --integration-type AWS_PROXY `
  --integration-uri arn:aws:lambda:<REGION>:<ACCOUNT_ID>:function:cba-indicator-api `
  --payload-format-version 2.0 `
  --query IntegrationId --output text

aws apigatewayv2 create-route --api-id $apiId --route-key "POST /chat" --target integrations/$integrationId
aws apigatewayv2 create-route --api-id $apiId --route-key "POST /upload" --target integrations/$integrationId
aws apigatewayv2 create-route --api-id $apiId --route-key "GET /recommendations" --target integrations/$integrationId
aws apigatewayv2 create-route --api-id $apiId --route-key "OPTIONS /{proxy+}" --target integrations/$integrationId

aws apigatewayv2 create-stage --api-id $apiId --stage-name prod --auto-deploy
```

Your API URL is:
```
https://<API_ID>.execute-api.<REGION>.amazonaws.com/prod
```

### Step 7: Configure Lambda Permissions

```bash
# Allow API Gateway to invoke Lambda
aws lambda add-permission \
  --function-name cba-indicator-api \
  --statement-id apigateway-invoke \
  --action lambda:InvokeFunction \
  --principal apigateway.amazonaws.com \
  --source-arn "arn:aws:execute-api:<REGION>:<ACCOUNT_ID>:<API_ID>/*/*"
```

If you see `ResourceConflictException`, the permission already exists.

---

## 4. Frontend Deployment

### Option A: Vercel (Recommended)

```bash
cd cba-frontend

# Install Vercel CLI
npm i -g vercel

# Link and deploy (first time)
vercel

# Set environment variable BEFORE production deploy
vercel env add NEXT_PUBLIC_API_URL production
# Enter: https://your-api-id.execute-api.us-west-2.amazonaws.com/prod

# Deploy to production
vercel --prod
```

### Option B: AWS Amplify

```bash
# Install Amplify CLI
npm install -g @aws-amplify/cli

# Initialize Amplify
amplify init

# Add hosting
amplify add hosting

# Set environment variable in Amplify Console:
# NEXT_PUBLIC_API_URL = https://your-api-id.execute-api.us-west-2.amazonaws.com/prod

# Deploy
amplify publish
```

### Option C: Static Export to S3 + CloudFront

```bash
cd cba-frontend

# Set API URL for the build
export NEXT_PUBLIC_API_URL=https://your-api-id.execute-api.us-west-2.amazonaws.com/prod

# Build static export
npm run build

# Sync to S3
aws s3 sync out/ s3://cba-frontend-bucket --delete

# Invalidate CloudFront cache
aws cloudfront create-invalidation --distribution-id XXXX --paths "/*"
```

**Windows PowerShell:**
```powershell
$env:NEXT_PUBLIC_API_URL="https://your-api-id.execute-api.us-west-2.amazonaws.com/prod"
npm run build
```

---

## 5. Environment Variables Reference

### Lambda Function

| Variable | Description | Example |
|----------|-------------|---------|
| `BEDROCK_AGENTCORE_ARN` | AgentCore Runtime ARN | `arn:aws:bedrock-agentcore:us-west-2:123456:runtime/cbaindicatoragent_Agent-xxx` |
| `UPLOAD_BUCKET_NAME` | S3 bucket for uploads | `cba-indicator-uploads` |
| `AWS_REGION` | AWS region | `us-west-2` |

### AgentCore Container

| Variable | Description | Example |
|----------|-------------|---------|
| `KNOWLEDGE_BASE_ID` | Bedrock KB ID | `0ZQBMXEKDI` |
| `AWS_REGION` | AWS region | `us-west-2` |
| `BEDROCK_AGENTCORE_MEMORY_ID` | Memory resource ID | (auto-set by CDK) |

### Frontend (Next.js)

| Variable | Description | Example |
|----------|-------------|---------|
| `NEXT_PUBLIC_API_URL` | API Gateway URL | `https://xxx.execute-api.us-west-2.amazonaws.com/prod` |

### Local Development

| Variable | Description | Required |
|----------|-------------|----------|
| `AWS_DEFAULT_REGION` | AWS region | Yes |
| `AWS_ACCESS_KEY_ID` | AWS access key | Yes |
| `AWS_SECRET_ACCESS_KEY` | AWS secret key | Yes |
| `AWS_SESSION_TOKEN` | Session token | If using temporary credentials |

---

## 6. Post-Deployment Verification

### Test API Endpoints

**Chat endpoint:**
```bash
curl -X POST https://YOUR_API_URL/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "What indicators do you have for coffee projects?"}'
```

You should see JSON with `response` and `session_id`.

**Recommendations endpoint:**
```bash
curl "https://YOUR_API_URL/recommendations?session_id=test-session"
```

You should see JSON with `indicators` (possibly empty).

### Test AgentCore

```bash
agentcore invoke '{"prompt": "Hello, what can you help me with?"}'
```

### Test Frontend

1. Open the frontend URL
2. Navigate to Chat page
3. Send a test message
4. Verify response is received

---

## 7. Troubleshooting

### Hackathon/Local Frontend Issues

#### Frontend can't connect to API

1. **Check internet connection** - The frontend needs to reach AWS
2. **Test API directly:**
   ```bash
   curl -X POST https://pjuuem2fn8.execute-api.us-west-2.amazonaws.com/prod/chat \
     -H "Content-Type: application/json" \
     -d '{"message": "hello"}'
   ```
3. **Check browser console** - Look for CORS or network errors
4. **Disable VPN/proxy** - Corporate networks may block the API

#### "Failed to fetch" errors

- The AWS backend may be cold-starting (wait 10-15 seconds, retry)
- Lambda has a 60-second timeout for longer conversations

#### Chat responses are slow

- First request after inactivity takes longer (cold start)
- Complex queries searching the Knowledge Base take 5-15 seconds
- This is normal for RAG-based AI systems

#### Upload not working

- File must be a PDF
- Maximum file size: 10MB
- The backend extracts text and sends to Claude for parsing

#### "Unknown route" from API

- Your API Gateway routes were not created or are pointing to the wrong integration
- Re-run the **Create API Gateway** step and confirm `/chat`, `/upload`, `/recommendations` routes exist

### Backend Deployment Issues

#### "Model access denied"

Request access to Claude models in the Bedrock Console:
1. Go to **Bedrock Console** â†’ **Model access**
2. Request access to Anthropic Claude models

#### "Knowledge Base not found"

Verify the Knowledge Base ID is correct:
```bash
aws bedrock-agent list-knowledge-bases --region us-west-2
```

#### "Lambda timeout"

Increase Lambda timeout to 60 seconds:
```bash
aws lambda update-function-configuration \
  --function-name cba-indicator-api \
  --timeout 60
```

#### "CORS errors in frontend"

Verify API Gateway CORS configuration:
```bash
aws apigatewayv2 get-api --api-id YOUR_API_ID
```

#### "PDF extraction failed"

Ensure Lambda layer includes `pypdf`:
```bash
aws lambda get-function --function-name cba-indicator-api
# Check Layers array includes the pypdf layer
```

### Logs

**Lambda logs:**
```bash
aws logs tail /aws/lambda/cba-indicator-api --follow
```

**AgentCore logs:**
```bash
# View in CloudWatch Logs
aws logs tail /aws/bedrock-agentcore/cbaindicatoragent --follow
```

---

## Quick Reference Commands

```bash
# Deploy AgentCore
cd agentcore-cba/cbaindicatoragent/cdk && npm run cdk:deploy

# Update Lambda code
zip lambda_function.zip lambda_function.py && \
aws lambda update-function-code --function-name cba-indicator-api --zip-file fileb://lambda_function.zip

# Deploy frontend (Vercel)
cd cba-frontend && vercel --prod

# View Lambda logs
aws logs tail /aws/lambda/cba-indicator-api --follow

# Test chat endpoint
curl -X POST https://YOUR_API_URL/chat -H "Content-Type: application/json" -d '{"message": "test"}'
```
</file>

<file path="lambda_requirements.txt">
# Lambda function dependencies
# Install these in a Lambda layer or include in deployment package

boto3>=1.34.0
pypdf>=4.0.0
</file>

<file path="scripts/build_lambda_layer.ps1">
# Build Lambda layer with pypdf for the lambda_function.py
# Run this script on Windows to create a Lambda layer zip file

$LAYER_NAME = "cba-lambda-dependencies"
$LAYER_DIR = "lambda_layer"

Write-Host "Building Lambda layer: $LAYER_NAME"

# Clean up previous build
if (Test-Path $LAYER_DIR) {
    Remove-Item -Recurse -Force $LAYER_DIR
}
New-Item -ItemType Directory -Path "$LAYER_DIR/python" -Force | Out-Null

# Install dependencies into the layer directory
# Note: For Lambda compatibility, you may need to build on Linux or use Docker
pip install --target "$LAYER_DIR/python" -r lambda_requirements.txt

# Create the zip file
Compress-Archive -Path "$LAYER_DIR/python" -DestinationPath "$LAYER_NAME.zip" -Force

Write-Host ""
Write-Host "Lambda layer created: $LAYER_NAME.zip"
Write-Host ""
Write-Host "IMPORTANT: For production, build the layer on Amazon Linux 2 or use Docker:"
Write-Host "  docker run --rm -v ${PWD}:/var/task public.ecr.aws/sam/build-python3.12 pip install -r lambda_requirements.txt -t lambda_layer/python"
Write-Host ""
Write-Host "To deploy this layer:"
Write-Host "  aws lambda publish-layer-version ``"
Write-Host "    --layer-name $LAYER_NAME ``"
Write-Host "    --zip-file fileb://$LAYER_NAME.zip ``"
Write-Host "    --compatible-runtimes python3.12 python3.11 ``"
Write-Host "    --compatible-architectures x86_64"
Write-Host ""
Write-Host "Then attach the layer to your Lambda function in the AWS Console or via CLI."
</file>

<file path="scripts/build_lambda_layer.sh">
#!/bin/bash
# Build Lambda layer with pypdf for the lambda_function.py
# Run this script to create a Lambda layer zip file

set -e

LAYER_NAME="cba-lambda-dependencies"
LAYER_DIR="lambda_layer"
PYTHON_VERSION="python3.12"

echo "Building Lambda layer: $LAYER_NAME"

# Clean up previous build
rm -rf $LAYER_DIR
mkdir -p $LAYER_DIR/python

# Install dependencies into the layer directory
pip install --target $LAYER_DIR/python -r lambda_requirements.txt --platform manylinux2014_x86_64 --only-binary=:all:

# Create the zip file
cd $LAYER_DIR
zip -r ../${LAYER_NAME}.zip python/
cd ..

echo "Lambda layer created: ${LAYER_NAME}.zip"
echo ""
echo "To deploy this layer:"
echo "  aws lambda publish-layer-version \\"
echo "    --layer-name $LAYER_NAME \\"
echo "    --zip-file fileb://${LAYER_NAME}.zip \\"
echo "    --compatible-runtimes python3.12 python3.11 \\"
echo "    --compatible-architectures x86_64"
echo ""
echo "Then attach the layer to your Lambda function in the AWS Console or via CLI."
</file>

<file path="src/__init__.py">

</file>

<file path="src/config.py">
"""Shared configuration for the CBA application."""

import os
from pathlib import Path

# AWS Bedrock configuration
MODEL_ID = "us.anthropic.claude-sonnet-4-5-20250929-v1:0"
KNOWLEDGE_BASE_ID = "0ZQBMXEKDI"
AWS_REGION = "us-west-2"

# Set environment variables
os.environ["AWS_DEFAULT_REGION"] = AWS_REGION
os.environ["STRANDS_KNOWLEDGE_BASE_ID"] = KNOWLEDGE_BASE_ID

# Load system prompt from text file
PROMPTS_DIR = Path(__file__).parent / "prompts"
SYSTEM_PROMPT = (PROMPTS_DIR / "system.txt").read_text()
</file>

<file path="src/prompts/prompt_original.txt">
// Use this to clearly define the task and job needed by the model
task_summary = f"""
## Task Summary:
Indicator Discovery & Selection

Purpose
This tool identifies and recommends the most appropriate indicator(s) to track progress toward a projectâ€™s expected outcomes, using the information stored in the Knowledge Base (KB). The selection is guided by existing use cases and optimized to balance accuracy, ease of use, and cost.

â¸»

Scope of the Knowledge Base (KB)

The Knowledge Base contains structured information on:
	1.	Indicators
	â€¢	Indicator definitions and intended use
	â€¢	Underlying methods
	â€¢	Attributes including:
	â€¢	Accuracy
	â€¢	Ease of use
	â€¢	Cost
	â€¢	Mappings to principles and criteria
	2.	Methods
	â€¢	Methodological descriptions underlying indicators
	â€¢	Links to scientific publications, i.e., one or more Digital Object Identifiers (DOIs) per method
	3.	Use Cases
	â€¢	Example project descriptions
	â€¢	Expected outcomes for those projects
	â€¢	A curated example of â€œgoodâ€ indicator sets used to track progress toward those outcomes

â¸»

Task Description

Given a new project description and its expected outcomes, the tool shall:
	1.	Identify Relevant Use Cases
	â€¢	Search the KB for the most relevant existing use case(s) based on similarity in:
	â€¢	Project objectives
	â€¢	Expected outcomes
	â€¢	Intervention type or thematic focus
	2.	Infer Suitable Indicators
	â€¢	Extract indicators used in the selected use case(s) as reference examples.
	â€¢	Identify additional indicators in the KB that are relevant to the projectâ€™s expected outcomes.
	3.	Apply Principle & Criteria Mapping
	â€¢	Indicators in the KB are mapped to Principles (1â€“7) and Criteria (e.g. 1.1, 1.2 â€¦ 7.4).
	â€¢	Mapping strength is encoded as:
	â€¢	P (Primary): Indicator is highly relevant and directly addresses the criterion.
	â€¢	S (Secondary): Indicator supports the criterion but is not the main measure.
	â€¢	x: Indicator is related and applicable, but at a lower degree.
	â€¢	Prioritize indicators with Primary (P) mappings to the most relevant criteria, followed by Secondary (S), and then x mappings where appropriate.
	4.	Optimize Indicator Selection
	â€¢	Evaluate candidate indicators based on:
	â€¢	Higher accuracy
	â€¢	Higher ease of use
	â€¢	Lower cost
	â€¢	Balance trade-offs where no single indicator is optimal across all attributes.
	â€¢	Prefer a concise, complementary set of indicators, e.g., covering all Principles.
    â€¢	Consider the project budget and ambition when selecting indicators.
	5.	Provide Supporting Evidence
	â€¢	For each recommended indicator, reference its underlying method(s).
	â€¢	Methods include links to scientific publications via one or more DOIs.
	â€¢	Note that:
	â€¢	In many cases, the full publication is openly available via the DOI landing page.
	â€¢	In some cases, only the abstract may be accessible.

â¸»

Expected Output

The tool should return:
	â€¢	A ranked list of recommended indicator(s) suitable for tracking progress toward the projectâ€™s expected outcomes
	â€¢	For each indicator:
	â€¢	Brief justification of relevance
	â€¢	Principle(s) and criterion/criteria mapping
	â€¢	Summary of accuracy, ease of use, and cost considerations
	â€¢	References to supporting methods and associated DOI(s)
"""

// Use this to provide contextual information related to the task
context_information = f"""
## Context Information:
- {{Context and content information 1}}
- {{Context and content information 2}}
...
"""

// Use this to provide any model instructions that you want model to adhere to
model_instructions = f"""
## Model Instructions:
- {{ Other Model Instructions }}
...
"""

// Use this to provide response style and formatting guidance
response_style  = f"""
## Response style and format requirements:
- {{Style and format requirement 1}}
- {{Style and format requirement 2}}
...
"""
final_prompt = f{task_summary}
{context_information}
{model_instructions}
response_style
</file>

<file path="tests/__init__.py">

</file>

<file path="tests/test_cba_ui.py">
#!/usr/bin/env python3
"""
Simple test to verify the CBA UI updates are working correctly.
"""

import os
from pathlib import Path

def test_cba_branding():
    """Test that CBA branding elements are properly implemented."""

    # Read the streamlit app file (relative to project root)
    project_root = Path(__file__).parent.parent
    app_path = project_root / "src" / "app.py"

    with open(app_path, 'r') as f:
        content = f.read()
    
    # Check for CBA-specific elements
    checks = [
        ("CBA Title", "Circular Bioeconomy Alliance" in content),
        ("Nature Icon", "ğŸŒ±" in content),
        ("CBA Color Palette", "--cba-main-background" in content and "--cba-accent-gold" in content),
        ("Mission Principles", "Re-Nature" in content and "Re-Think" in content and "Re-Activate" in content),
        ("King Charles Reference", "King Charles III" in content),
        ("Nature-focused messaging", "nature at the center" in content),
        ("CBA-specific responses", "circular bioeconomy" in content.lower()),
        ("Sustainability keywords", "sustainability" in content.lower()),
        ("New Conversation", "New Conversation" in content),
        ("Document Upload", "Document Upload" in content),
    ]
    
    print("ğŸ§ª Testing CBA UI Implementation")
    print("=" * 40)
    
    all_passed = True
    for check_name, result in checks:
        status = "âœ… PASS" if result else "âŒ FAIL"
        print(f"{status} {check_name}")
        if not result:
            all_passed = False
    
    print("=" * 40)
    if all_passed:
        print("ğŸ‰ All CBA branding checks passed!")
        print("\nâœ… UI Features Implemented:")
        print("  â€¢ CBA logo and branding in sidebar")
        print("  â€¢ Nature-inspired color palette")
        print("  â€¢ Mission principles (Re-Nature, Re-Think, Re-Activate)")
        print("  â€¢ King Charles III founding reference")
        print("  â€¢ CBA-focused chat responses")
        print("  â€¢ Sustainability-themed messaging")
        print("  â€¢ Professional document upload interface")
        return True
    else:
        print("âŒ Some checks failed. Please review the implementation.")
        return False

if __name__ == "__main__":
    import sys
    success = test_cba_branding()
    sys.exit(0 if success else 1)
</file>

<file path="tests/test_chat_app.py">
#!/usr/bin/env python3
"""
Test script for Streamlit Chat App functionality.
Tests session creation, switching, file upload, and message persistence.
"""

import sys
import os
import uuid
import datetime
import io
import tempfile

# Add the project root to Python path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Import the functions from our chat app
from src.app import (
    create_new_session,
    switch_session,
    generate_session_title,
    extract_file_content,
)

class MockSessionState:
    """Mock Streamlit session state for testing."""
    def __init__(self):
        self.sessions = {}
        self.current_session_id = None
        self.messages = []
        self.uploaded_file = None
        self.file_content = None

def test_session_creation():
    """Test session creation and switching functionality."""
    print("Testing Session Creation and Switching...")

    # Mock streamlit session state
    from src import app
    mock_st = MockSessionState()
    app.st.session_state = mock_st

    # Test 1: Create new session
    print("  - Testing session creation...")
    session_id = create_new_session()

    assert session_id is not None, "Session ID should not be None"
    assert session_id in mock_st.sessions, "Session should be added to sessions dict"
    assert mock_st.current_session_id == session_id, "Current session should be set"
    assert len(mock_st.messages) == 0, "New session should have empty messages"
    print(f"    Created session: {session_id[:8]}...")

    # Test 2: Add a message to current session
    test_message = {"role": "user", "content": "Hello, this is a test message"}
    mock_st.messages.append(test_message)
    mock_st.sessions[session_id]["messages"] = mock_st.messages.copy()

    # Test 3: Create another session
    print("  - Testing multiple sessions...")
    session_id_2 = create_new_session()

    assert session_id_2 != session_id, "New session should have different ID"
    assert len(mock_st.sessions) == 2, "Should have 2 sessions"
    assert mock_st.current_session_id == session_id_2, "Current session should be the new one"
    assert len(mock_st.messages) == 0, "New session should have empty messages"
    print(f"    Created second session: {session_id_2[:8]}...")

    # Test 4: Switch back to first session
    print("  - Testing session switching...")
    result = switch_session(session_id)

    assert result == True, "Session switch should succeed"
    assert mock_st.current_session_id == session_id, "Current session should be switched"
    assert len(mock_st.messages) == 1, "Should load previous messages"
    assert mock_st.messages[0]["content"] == "Hello, this is a test message", "Message content should match"
    print(f"    Switched back to session: {session_id[:8]}...")

    # Test 5: Test invalid session switch
    print("  - Testing invalid session handling...")
    invalid_result = switch_session("invalid-session-id")
    assert invalid_result == False, "Invalid session switch should fail"

    print("PASSED: Session Creation and Switching\n")

def test_session_title_generation():
    """Test session title generation from messages."""
    print("Testing Session Title Generation...")

    # Test cases for title generation
    test_cases = [
        ("Hello world", "Hello world"),
        ("This is a longer message with many words", "This is a longer message..."),
        ("", "New Chat"),
        ("   ", "New Chat"),
        ("A" * 60, "A" * 47 + "..."),
        ("One two three four five six seven", "One two three four five..."),
    ]

    for input_msg, expected in test_cases:
        result = generate_session_title(input_msg)
        print(f"  - '{input_msg[:20]}...' -> '{result}'")

        if expected.endswith("..."):
            assert result.endswith("..."), f"Long title should end with '...': {result}"
        else:
            assert result == expected, f"Expected '{expected}', got '{result}'"

        assert len(result) <= 50, f"Title should not exceed 50 chars: {len(result)}"

    print("PASSED: Session Title Generation\n")

def test_file_processing():
    """Test file upload and content extraction."""
    print("Testing File Processing...")

    # Test 1: TXT file processing
    print("  - Testing TXT file processing...")
    txt_content = "This is a test text file.\nWith multiple lines.\nFor testing purposes."

    class MockFile:
        def __init__(self, name, content):
            self.name = name
            self.content = content.encode('utf-8')
            self.position = 0

        def read(self):
            return self.content

        def seek(self, pos):
            self.position = pos

    txt_file = MockFile("test.txt", txt_content)
    extracted = extract_file_content(txt_file)

    assert extracted == txt_content, "TXT content should match exactly"
    print(f"    TXT extraction: {len(extracted)} characters")

    # Test 2: CSV file processing
    print("  - Testing CSV file processing...")
    csv_content = "Name,Age,City\nJohn,25,New York\nJane,30,Los Angeles\nBob,35,Chicago"
    csv_file = MockFile("test.csv", csv_content)

    extracted_csv = extract_file_content(csv_file)

    assert "CSV Headers: Name, Age, City" in extracted_csv, "Should contain headers"
    assert "Row 1: John, 25, New York" in extracted_csv, "Should contain data rows"
    print(f"    CSV extraction: {len(extracted_csv)} characters")

    # Test 3: PDF file (placeholder)
    print("  - Testing PDF file handling...")
    pdf_file = MockFile("test.pdf", "dummy content")
    extracted_pdf = extract_file_content(pdf_file)

    assert "PDF file 'test.pdf' uploaded" in extracted_pdf, "Should handle PDF files"
    print(f"    PDF handling: placeholder message")

    # Test 4: DOCX file (placeholder)
    print("  - Testing DOCX file handling...")
    docx_file = MockFile("test.docx", "dummy content")
    extracted_docx = extract_file_content(docx_file)

    assert "DOCX file 'test.docx' uploaded" in extracted_docx, "Should handle DOCX files"
    print(f"    DOCX handling: placeholder message")

    # Test 5: Unsupported file type
    print("  - Testing unsupported file type...")
    unsupported_file = MockFile("test.xyz", "dummy content")
    extracted_unsupported = extract_file_content(unsupported_file)

    assert "Unsupported file type: xyz" in extracted_unsupported, "Should handle unsupported types"
    print(f"    Unsupported file handling: error message")

    print("PASSED: File Processing\n")

def test_message_persistence():
    """Test that messages persist correctly across sessions."""
    print("Testing Message Persistence...")

    # Mock streamlit session state
    from src import app
    mock_st = MockSessionState()
    app.st.session_state = mock_st

    # Create first session and add messages
    print("  - Testing message persistence across sessions...")
    session1 = create_new_session()

    # Add messages to session 1
    messages_session1 = [
        {"role": "user", "content": "Hello from session 1"},
        {"role": "assistant", "content": "Hi there! This is session 1 response."}
    ]
    mock_st.messages = messages_session1.copy()
    mock_st.sessions[session1]["messages"] = messages_session1.copy()

    # Create second session and add different messages
    session2 = create_new_session()
    messages_session2 = [
        {"role": "user", "content": "Hello from session 2"},
        {"role": "assistant", "content": "Hi! This is session 2 response."}
    ]
    mock_st.messages = messages_session2.copy()
    mock_st.sessions[session2]["messages"] = messages_session2.copy()

    # Switch back to session 1 and verify messages
    switch_session(session1)
    assert len(mock_st.messages) == 2, "Session 1 should have 2 messages"
    assert mock_st.messages[0]["content"] == "Hello from session 1", "First message should match"
    assert mock_st.messages[1]["content"] == "Hi there! This is session 1 response.", "Second message should match"
    print(f"    Session 1 messages preserved: {len(mock_st.messages)} messages")

    # Switch to session 2 and verify messages
    switch_session(session2)
    assert len(mock_st.messages) == 2, "Session 2 should have 2 messages"
    assert mock_st.messages[0]["content"] == "Hello from session 2", "First message should match"
    assert mock_st.messages[1]["content"] == "Hi! This is session 2 response.", "Second message should match"
    print(f"    Session 2 messages preserved: {len(mock_st.messages)} messages")

    print("PASSED: Message Persistence\n")

def run_all_tests():
    """Run all tests and report results."""
    print("Starting Streamlit Chat App Tests\n")
    print("=" * 50)

    try:
        test_session_creation()
        test_session_title_generation()
        test_file_processing()
        test_message_persistence()

        print("=" * 50)
        print("ALL TESTS PASSED!")
        print("\nTest Summary:")
        print("  - Session creation and switching: PASSED")
        print("  - Session title generation: PASSED")
        print("  - File upload and processing: PASSED")
        print("  - Message persistence: PASSED")
        print("\nNote: Agent response tests skipped (requires AWS credentials)")

        return True

    except Exception as e:
        print("=" * 50)
        print(f"TEST FAILED: {str(e)}")
        import traceback
        traceback.print_exc()
        print("\nPlease check the implementation and try again.")
        return False

if __name__ == "__main__":
    success = run_all_tests()
    sys.exit(0 if success else 1)
</file>

<file path="tests/test_functions.py">
#!/usr/bin/env python3
"""
Test script for individual functions in the Streamlit Chat App.
Tests core functionality without Streamlit dependencies.
"""

import uuid
import datetime
import io

def test_session_title_generation():
    """Test session title generation from messages."""
    print("ğŸ§ª Testing Session Title Generation...")
    
    def generate_session_title(first_message):
        """Generate a readable session title from the first message."""
        if not first_message or not first_message.strip():
            return "New Chat"
        
        # Extract first few words from first message
        words = first_message.strip().split()
        
        # Create readable session title (limit to first 5 words, max 50 characters)
        if len(words) <= 5:
            title = " ".join(words)
        else:
            title = " ".join(words[:5]) + "..."
        
        # Ensure title doesn't exceed 50 characters
        if len(title) > 50:
            title = title[:47] + "..."
        
        return title
    
    # Test cases for title generation
    test_cases = [
        ("Hello world", "Hello world"),
        ("This is a longer message with many words", "This is a longer message..."),
        ("", "New Chat"),
        ("   ", "New Chat"),
        ("A" * 60, "A" * 47 + "..."),
        ("One two three four five six seven", "One two three four five..."),
    ]
    
    for input_msg, expected in test_cases:
        result = generate_session_title(input_msg)
        print(f"  âœ“ '{input_msg[:20]}...' -> '{result}'")
        
        if expected.endswith("..."):
            assert result.endswith("..."), f"Long title should end with '...': {result}"
        else:
            assert result == expected, f"Expected '{expected}', got '{result}'"
        
        assert len(result) <= 50, f"Title should not exceed 50 chars: {len(result)}"
    
    print("âœ… Session Title Generation: PASSED\n")

def test_file_processing():
    """Test file upload and content extraction."""
    print("ğŸ§ª Testing File Processing...")
    
    def extract_file_content(uploaded_file):
        """Extract text content from uploaded files of different types."""
        if uploaded_file is None:
            return ""
        
        try:
            file_extension = uploaded_file.name.split('.')[-1].lower()
            
            if file_extension == 'txt':
                # Handle TXT files
                content = uploaded_file.read().decode('utf-8')
                return content
                
            elif file_extension == 'csv':
                # Handle CSV files
                uploaded_file.seek(0)  # Reset file pointer
                content = uploaded_file.read().decode('utf-8')
                
                # Parse CSV and convert to readable text
                import csv
                csv_reader = csv.reader(io.StringIO(content))
                rows = list(csv_reader)
                
                if not rows:
                    return "Empty CSV file"
                
                # Format CSV as text with headers and data
                formatted_content = []
                if len(rows) > 0:
                    headers = rows[0]
                    formatted_content.append("CSV Headers: " + ", ".join(headers))
                    formatted_content.append("\nData:")
                    
                    # Include first 10 rows of data to avoid overwhelming context
                    for i, row in enumerate(rows[1:11], 1):
                        formatted_content.append(f"Row {i}: " + ", ".join(row))
                    
                    if len(rows) > 11:
                        formatted_content.append(f"... and {len(rows) - 11} more rows")
                
                return "\n".join(formatted_content)
                
            elif file_extension == 'pdf':
                return f"PDF file '{uploaded_file.name}' uploaded. PDF text extraction requires additional libraries (PyPDF2, pdfplumber). Content: [PDF content would be extracted here]"
                
            elif file_extension == 'docx':
                return f"DOCX file '{uploaded_file.name}' uploaded. DOCX text extraction requires additional libraries (python-docx). Content: [DOCX content would be extracted here]"
                
            else:
                return f"Unsupported file type: {file_extension}"
                
        except Exception as e:
            return f"Error processing file '{uploaded_file.name}': {str(e)}"
    
    # Test 1: TXT file processing
    print("  âœ“ Testing TXT file processing...")
    txt_content = "This is a test text file.\nWith multiple lines.\nFor testing purposes."
    
    class MockFile:
        def __init__(self, name, content):
            self.name = name
            self.content = content.encode('utf-8')
            self.position = 0
        
        def read(self):
            return self.content
        
        def seek(self, pos):
            self.position = pos
    
    txt_file = MockFile("test.txt", txt_content)
    extracted = extract_file_content(txt_file)
    
    assert extracted == txt_content, "TXT content should match exactly"
    print(f"    âœ… TXT extraction: {len(extracted)} characters")
    
    # Test 2: CSV file processing
    print("  âœ“ Testing CSV file processing...")
    csv_content = "Name,Age,City\nJohn,25,New York\nJane,30,Los Angeles\nBob,35,Chicago"
    csv_file = MockFile("test.csv", csv_content)
    
    extracted_csv = extract_file_content(csv_file)
    
    assert "CSV Headers: Name, Age, City" in extracted_csv, "Should contain headers"
    assert "Row 1: John, 25, New York" in extracted_csv, "Should contain data rows"
    print(f"    âœ… CSV extraction: {len(extracted_csv)} characters")
    
    # Test 3: PDF file (placeholder)
    print("  âœ“ Testing PDF file handling...")
    pdf_file = MockFile("test.pdf", "dummy content")
    extracted_pdf = extract_file_content(pdf_file)
    
    assert "PDF file 'test.pdf' uploaded" in extracted_pdf, "Should handle PDF files"
    print(f"    âœ… PDF handling: placeholder message")
    
    # Test 4: DOCX file (placeholder)
    print("  âœ“ Testing DOCX file handling...")
    docx_file = MockFile("test.docx", "dummy content")
    extracted_docx = extract_file_content(docx_file)
    
    assert "DOCX file 'test.docx' uploaded" in extracted_docx, "Should handle DOCX files"
    print(f"    âœ… DOCX handling: placeholder message")
    
    # Test 5: Unsupported file type
    print("  âœ“ Testing unsupported file type...")
    unsupported_file = MockFile("test.xyz", "dummy content")
    extracted_unsupported = extract_file_content(unsupported_file)
    
    assert "Unsupported file type: xyz" in extracted_unsupported, "Should handle unsupported types"
    print(f"    âœ… Unsupported file handling: error message")
    
    print("âœ… File Processing: PASSED\n")

def test_llm_response():
    """Test LLM response simulation."""
    print("ğŸ§ª Testing LLM Response Simulation...")
    
    def simulate_llm_response(user_message, file_content=None):
        """Simulate LLM response with placeholder functionality."""
        import time
        import random
        
        # Create a context-aware response
        base_responses = [
            f"I understand you said: '{user_message}'. That's an interesting point!",
            f"Thanks for sharing that. Regarding '{user_message}', I think...",
            f"That's a great question about '{user_message}'. Let me think about that...",
            f"I see you mentioned '{user_message}'. Here's my perspective on that..."
        ]
        
        # Select a base response
        response = random.choice(base_responses)
        
        # Add file context if available
        if file_content and file_content.strip():
            response += f"\n\nI also notice you've uploaded a file with content that includes: {file_content[:200]}{'...' if len(file_content) > 200 else ''}"
            response += "\n\nI can reference this file content in our conversation."
        
        # Add some additional context
        response += f"\n\nThis is a simulated response. In a real implementation, this would connect to an actual LLM API like OpenAI, Anthropic, or others."
        
        # Simulate streaming by yielding chunks
        words = response.split()
        for i in range(0, len(words), 3):  # Yield 3 words at a time
            chunk = " ".join(words[i:i+3]) + " "
            yield chunk
    
    # Test 1: Basic response without file content
    print("  âœ“ Testing basic LLM response...")
    user_message = "What is the weather like?"
    response_gen = simulate_llm_response(user_message)
    
    # Collect all chunks from the generator
    response_chunks = list(response_gen)
    full_response = "".join(response_chunks)
    
    assert len(full_response) > 0, "Response should not be empty"
    assert user_message in full_response, "Response should reference user message"
    assert "simulated response" in full_response.lower(), "Should indicate it's simulated"
    print(f"    âœ… Basic response: {len(full_response)} characters")
    
    # Test 2: Response with file content
    print("  âœ“ Testing LLM response with file content...")
    file_content = "This is some file content that should be referenced in the response."
    response_gen_with_file = simulate_llm_response(user_message, file_content)
    
    response_chunks_with_file = list(response_gen_with_file)
    full_response_with_file = "".join(response_chunks_with_file)
    
    assert len(full_response_with_file) > len(full_response), "Response with file should be longer"
    assert "uploaded a file" in full_response_with_file.lower(), "Should mention file upload"
    print(f"    âœ… Response with file: {len(full_response_with_file)} characters")
    
    print("âœ… LLM Response Simulation: PASSED\n")

def test_session_logic():
    """Test session creation and management logic."""
    print("ğŸ§ª Testing Session Management Logic...")
    
    # Simulate session state
    sessions = {}
    current_session_id = None
    messages = []
    
    def create_new_session():
        nonlocal sessions, current_session_id, messages
        
        # Generate UUID for new session
        new_session_id = str(uuid.uuid4())
        
        # Create session data structure with empty messages
        new_session = {
            "title": "New Chat",
            "created_at": datetime.datetime.now(),
            "messages": [],
            "uploaded_files": []
        }
        
        # Add to sessions dictionary
        sessions[new_session_id] = new_session
        
        # Set as current active session
        current_session_id = new_session_id
        messages = []
        
        return new_session_id
    
    def switch_session(session_id):
        nonlocal sessions, current_session_id, messages
        
        # Validate session exists
        if session_id not in sessions:
            return False
        
        # Load messages from selected session
        selected_session = sessions[session_id]
        
        # Update current session state
        current_session_id = session_id
        messages = selected_session["messages"].copy()
        
        return True
    
    # Test session creation
    print("  âœ“ Testing session creation...")
    session1 = create_new_session()
    assert session1 is not None, "Session ID should not be None"
    assert session1 in sessions, "Session should be added to sessions dict"
    assert current_session_id == session1, "Current session should be set"
    assert len(messages) == 0, "New session should have empty messages"
    print(f"    âœ… Created session: {session1[:8]}...")
    
    # Test adding messages
    print("  âœ“ Testing message handling...")
    test_message = {"role": "user", "content": "Hello, this is a test message"}
    messages.append(test_message)
    sessions[session1]["messages"] = messages.copy()
    
    # Test creating second session
    print("  âœ“ Testing multiple sessions...")
    session2 = create_new_session()
    assert session2 != session1, "New session should have different ID"
    assert len(sessions) == 2, "Should have 2 sessions"
    assert current_session_id == session2, "Current session should be the new one"
    assert len(messages) == 0, "New session should have empty messages"
    print(f"    âœ… Created second session: {session2[:8]}...")
    
    # Test session switching
    print("  âœ“ Testing session switching...")
    result = switch_session(session1)
    assert result == True, "Session switch should succeed"
    assert current_session_id == session1, "Current session should be switched"
    assert len(messages) == 1, "Should load previous messages"
    assert messages[0]["content"] == "Hello, this is a test message", "Message content should match"
    print(f"    âœ… Switched back to session: {session1[:8]}...")
    
    print("âœ… Session Management Logic: PASSED\n")

def run_all_tests():
    """Run all tests and report results."""
    print("ğŸš€ Starting Streamlit Chat App Function Tests\n")
    print("=" * 50)
    
    try:
        test_session_title_generation()
        test_file_processing()
        test_llm_response()
        test_session_logic()
        
        print("=" * 50)
        print("ğŸ‰ ALL FUNCTION TESTS PASSED!")
        print("\nâœ… Test Summary:")
        print("  â€¢ Session title generation: âœ…")
        print("  â€¢ File upload and processing: âœ…")
        print("  â€¢ LLM response simulation: âœ…")
        print("  â€¢ Session management logic: âœ…")
        print("\nğŸš€ Core functionality is working correctly!")
        
        return True
        
    except Exception as e:
        print("=" * 50)
        print(f"âŒ TEST FAILED: {str(e)}")
        import traceback
        traceback.print_exc()
        print("\nğŸ”§ Please check the implementation and try again.")
        return False

if __name__ == "__main__":
    import sys
    success = run_all_tests()
    sys.exit(0 if success else 1)
</file>

<file path="agentcore-cba/cbaindicatoragent/pyproject.toml">
[build-system]
requires = ["setuptools>=68", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "cbaindicatoragent"
version = "0.1.0"
requires-python = ">=3.10"

dependencies = [
    "bedrock-agentcore >= 1.0.3",
    "mcp >= 1.19.0",
    "pypdf >= 4.0.0",
    "pytest >= 7.0.0",
    "pytest-asyncio >= 0.21.0",
    "requests >= 2.32.5",
    "strands-agents >= 1.13.0",
    "strands-agents-tools >= 0.2.16"
]
</file>

<file path="agentcore-cba/cbaindicatoragent/src/main.py">
import os
import sys
from pathlib import Path

# Add src directory to path for imports
src_dir = Path(__file__).parent
if str(src_dir) not in sys.path:
    sys.path.insert(0, str(src_dir))

from strands import Agent, tool
from bedrock_agentcore import BedrockAgentCoreApp
from bedrock_agentcore.memory.integrations.strands.config import AgentCoreMemoryConfig, RetrievalConfig
from bedrock_agentcore.memory.integrations.strands.session_manager import AgentCoreMemorySessionManager

# Import MCP client
try:
    from mcp_client.client import get_streamable_http_mcp_client
except ImportError:
    from contextlib import nullcontext
    from types import SimpleNamespace
    def get_streamable_http_mcp_client():
        return nullcontext(SimpleNamespace(list_tools_sync=lambda: []))

# Import model loader
try:
    from model.load import load_model
except ImportError:
    from strands.models import BedrockModel
    def load_model():
        return BedrockModel(model_id="global.anthropic.claude-sonnet-4-5-20250929-v1:0")

# Import KB tools
try:
    from kb_tool import (
        search_cba_indicators,
        search_indicators_by_outcome,
        search_methods_by_budget,
        search_location_specific_indicators
    )
except ImportError:
    # Define stub tools if import fails
    @tool
    def search_cba_indicators(query: str, max_results: int = 10) -> str:
        return "KB tool not available"
    @tool
    def search_indicators_by_outcome(outcome: str) -> str:
        return "KB tool not available"
    @tool
    def search_methods_by_budget(budget_range: str, commodity: str = "") -> str:
        return "KB tool not available"
    @tool
    def search_location_specific_indicators(location: str, commodity: str = "") -> str:
        return "KB tool not available"

MEMORY_ID = os.getenv("BEDROCK_AGENTCORE_MEMORY_ID")
REGION = os.getenv("AWS_REGION", "us-west-2")
KNOWLEDGE_BASE_ID = os.getenv("KNOWLEDGE_BASE_ID", "0ZQBMXEKDI")

# Skip MCP client for now (no Gateway configured)
from contextlib import nullcontext
from types import SimpleNamespace
strands_mcp_client = nullcontext(SimpleNamespace(list_tools_sync=lambda: []))

# Session-scoped project profiles - prevents concurrent request conflicts
# Key: session_id, Value: profile dict
session_profiles = {}

def get_session_profile(session_id: str) -> dict:
    """Get or create profile for a session."""
    if session_id not in session_profiles:
        session_profiles[session_id] = {
            "location": None,
            "commodity": None,
            "budget": None,
            "outcomes": None,
            "capacity": None
        }
    return session_profiles[session_id]

def create_profile_tools(session_id: str):
    """Create session-scoped profile tools with captured session_id."""
    profile = get_session_profile(session_id)
    
    @tool
    def set_project_location(location: str) -> str:
        """Set the project location/region"""
        profile["location"] = location
        return f"Location set to: {location}"

    @tool
    def set_project_commodity(commodity: str) -> str:
        """Set the primary commodity/product"""
        profile["commodity"] = commodity
        return f"Commodity set to: {commodity}"

    @tool
    def set_project_budget(budget: str) -> str:
        """Set the project budget range"""
        profile["budget"] = budget
        return f"Budget set to: {budget}"

    @tool
    def set_project_outcomes(outcomes: str) -> str:
        """Set the desired project outcomes"""
        profile["outcomes"] = outcomes
        return f"Outcomes set to: {outcomes}"

    @tool
    def set_technical_capacity(capacity: str) -> str:
        """Set the technical capacity level (optional)"""
        profile["capacity"] = capacity
        return f"Technical capacity set to: {capacity}"

    @tool
    def get_project_profile() -> dict:
        """Get the current project profile"""
        return profile.copy()
    
    return [
        set_project_location,
        set_project_commodity,
        set_project_budget,
        set_project_outcomes,
        set_technical_capacity,
        get_project_profile
    ]

# Integrate with Bedrock AgentCore
app = BedrockAgentCoreApp()
log = app.logger

@app.entrypoint
async def invoke(payload, context):
    session_id = getattr(context, 'session_id', 'default')

    # Configure memory if available
    session_manager = None
    if MEMORY_ID:
        session_manager = AgentCoreMemorySessionManager(
            AgentCoreMemoryConfig(
                memory_id=MEMORY_ID,
                session_id=session_id,
                actor_id="cba-user",
                retrieval_config={
                    "/users/cba-user/profile": RetrievalConfig(top_k=5, relevance_score=0.5),
                }
            ),
            REGION
        )
    else:
        log.warning("MEMORY_ID is not set. Skipping memory session manager initialization.")

    with strands_mcp_client as client:
        # Get MCP Tools
        mcp_tools = client.list_tools_sync()
        
        # Create session-scoped profile tools (prevents concurrent request conflicts)
        profile_tools = create_profile_tools(session_id)

        # Create agent with Knowledge Base
        agent = Agent(
            model=load_model(),
            session_manager=session_manager,
            system_prompt=f"""
You are the CBA (Circular Bioeconomy Alliance) Indicator Selection Assistant. Your role is to help users identify the most relevant monitoring and evaluation indicators for their circular bioeconomy projects.

You have access to a knowledge base containing 801 methods and 224 indicators from the CBA M&E framework (Knowledge Base ID: {KNOWLEDGE_BASE_ID}).

Your workflow:
1. Gather project profile information through conversation:
   - Location/Region (required)
   - Primary Commodity/Product (required)
   - Budget Range (required)
   - Desired Outcomes (required)
   - Technical Capacity (optional - for filtering method complexity)

2. Use the provided tools to:
   - Store profile information as you collect it (set_project_* tools)
   - Search the knowledge base for relevant indicators (search_cba_indicators)
   - Find indicators aligned with outcomes (search_indicators_by_outcome)
   - Identify budget-appropriate methods (search_methods_by_budget)
   - Get location-specific considerations (search_location_specific_indicators)

3. Once you have the required information, use the KB search tools to recommend:
   - Relevant indicators aligned with their outcomes
   - Appropriate methods based on their budget and capacity
   - Location-specific considerations

4. Present recommendations clearly with:
   - Indicator names and descriptions
   - Why each is relevant to their project
   - Implementation considerations
   - Budget and capacity requirements

Be conversational, ask one question at a time, and confirm understanding before moving forward. After gathering all required information, actively search the knowledge base to provide specific, actionable recommendations.
            """,
            tools=profile_tools + [
                search_cba_indicators,
                search_indicators_by_outcome,
                search_methods_by_budget,
                search_location_specific_indicators
            ] + mcp_tools
        )

        # Execute and format response
        stream = agent.stream_async(payload.get("prompt"))

        async for event in stream:
            # Handle Text parts of the response
            if "data" in event and isinstance(event["data"], str):
                yield event["data"]

def format_response(result) -> str:
    """Format the agent response"""
    return str(result)

if __name__ == "__main__":
    app.run()
</file>

<file path="cba-frontend/app/chat/page.tsx">
"use client";

import { useState, useRef, useEffect, Suspense } from "react";
import { useSearchParams } from "next/navigation";
import { Send, Loader2, ArrowLeft, FileText, MapPin, DollarSign, Target } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import Link from "next/link";

interface Message {
  role: "user" | "assistant";
  content: string;
}

interface ProjectProfile {
  location?: string;
  commodity?: string;
  budget?: string;
  outcomes?: string;
  capacity?: string;
}

// Generate a unique session ID
function generateSessionId(): string {
  return `session-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
}

function ChatPageContent() {
  const searchParams = useSearchParams();
  
  // Pre-fill from URL params (from upload page)
  const initialProfile: ProjectProfile = {
    location: searchParams.get("location") || undefined,
    commodity: searchParams.get("commodity") || undefined,
    budget: searchParams.get("budget") || undefined,
  };

  // Session ID - use from URL or generate new one
  const [sessionId] = useState<string>(() => 
    searchParams.get("session_id") || generateSessionId()
  );

  const [messages, setMessages] = useState<Message[]>([
    {
      role: "assistant",
      content: initialProfile.location 
        ? `I see you uploaded a file! I found: Location: ${initialProfile.location}, Commodity: ${initialProfile.commodity}, Budget: ${initialProfile.budget}. Now, what are your main expected outcomes? What do you want to measure or improve?`
        : "Hello! I'll help you find the perfect indicators for your project. Let's start by understanding your project. Where is your project located?",
    },
  ]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [profile, setProfile] = useState<ProjectProfile>(initialProfile);
  const [hasRecommendations, setHasRecommendations] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleSend = async () => {
    if (!input.trim() || isLoading) return;

    const userMessage = input.trim();
    setInput("");
    setMessages((prev) => [...prev, { role: "user", content: userMessage }]);
    setIsLoading(true);

    try {
      const { api } = await import("@/lib/api");
      const response = await api.chat(userMessage, sessionId, profile);
      
      // Extract profile information from the conversation
      extractProfileFromMessage(userMessage, response.response);
      
      // Track if we have recommendations available
      if (response.has_recommendations) {
        setHasRecommendations(true);
      }
      
      setMessages((prev) => [...prev, { role: "assistant", content: response.response }]);
    } catch (error) {
      console.error("Chat failed:", error);
      setMessages((prev) => [...prev, { role: "assistant", content: "Sorry, I encountered an error. Please try again." }]);
    } finally {
      setIsLoading(false);
    }
  };

  // Extract profile fields from conversation context
  const extractProfileFromMessage = (userMessage: string, assistantResponse: string) => {
    const lowerUser = userMessage.toLowerCase();
    const lowerAssistant = assistantResponse.toLowerCase();
    
    setProfile(prev => {
      const updated = { ...prev };
      
      // If assistant confirms location was set, or asks about commodity (meaning location is done)
      if (!prev.location && (
        lowerAssistant.includes("location set") ||
        lowerAssistant.includes("commodity") ||
        lowerAssistant.includes("product") ||
        lowerAssistant.includes("what crop") ||
        lowerAssistant.includes("what are you growing")
      )) {
        // Extract location from user's previous message
        updated.location = userMessage;
      }
      
      // If assistant confirms commodity or asks about budget
      if (prev.location && !prev.commodity && (
        lowerAssistant.includes("commodity set") ||
        lowerAssistant.includes("budget") ||
        lowerAssistant.includes("funding") ||
        lowerAssistant.includes("how much")
      )) {
        updated.commodity = userMessage;
      }
      
      // If assistant confirms budget or asks about outcomes
      if (prev.commodity && !prev.budget && (
        lowerAssistant.includes("budget set") ||
        lowerAssistant.includes("outcome") ||
        lowerAssistant.includes("goal") ||
        lowerAssistant.includes("measure") ||
        lowerAssistant.includes("achieve")
      )) {
        updated.budget = userMessage;
      }
      
      // If assistant confirms outcomes or asks about capacity/provides recommendations
      if (prev.budget && !prev.outcomes && (
        lowerAssistant.includes("outcomes set") ||
        lowerAssistant.includes("capacity") ||
        lowerAssistant.includes("technical") ||
        lowerAssistant.includes("recommend") ||
        lowerAssistant.includes("indicator")
      )) {
        updated.outcomes = userMessage;
      }
      
      // If we got recommendations, mark capacity as skipped if not set
      if (prev.outcomes && !prev.capacity && (
        lowerAssistant.includes("indicator") ||
        lowerAssistant.includes("recommend") ||
        lowerAssistant.includes("based on your")
      )) {
        updated.capacity = updated.capacity || "Not specified";
      }
      
      return updated;
    });
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  // Count only filled profile fields (not undefined)
  const filledFields = [profile.location, profile.commodity, profile.budget, profile.outcomes].filter(Boolean).length;
  const requiredFields = 4;
  
  // Profile is complete when we have all 4 required fields OR we have recommendations
  const isComplete = filledFields >= requiredFields || hasRecommendations;

  return (
    <div className="min-h-screen flex flex-col">
      {/* Header */}
      <header className="border-b border-cba-navy-light bg-cba-navy-dark/50 backdrop-blur-sm sticky top-0 z-10">
        <div className="container mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/" className="text-gray-400 hover:text-white transition">
              <ArrowLeft className="w-5 h-5" />
            </Link>
            <div>
              <h1 className="text-lg font-bold">Build Your Project</h1>
              <p className="text-xs text-gray-400">Chat with AI Assistant</p>
            </div>
          </div>
          <div className="text-sm text-gray-400">
            {filledFields}/{requiredFields} required fields
          </div>
        </div>
      </header>

      <div className="flex-1 flex">
        {/* Sidebar - Project Profile */}
        <aside className="w-80 border-r border-cba-navy-light bg-cba-navy-dark/30 p-6">
          <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
            <FileText className="w-5 h-5 text-cba-gold" />
            Project Profile
          </h2>
          
          <div className="space-y-4">
            <ProfileField
              icon={<MapPin className="w-4 h-4" />}
              label="Location"
              value={profile.location}
            />
            <ProfileField
              icon={<span className="text-lg">ğŸŒ¾</span>}
              label="Commodity"
              value={profile.commodity}
            />
            <ProfileField
              icon={<DollarSign className="w-4 h-4" />}
              label="Budget"
              value={profile.budget}
            />
            <ProfileField
              icon={<Target className="w-4 h-4" />}
              label="Outcomes"
              value={profile.outcomes}
            />
            <ProfileField
              icon={<span className="text-lg">âš™ï¸</span>}
              label="Capacity (Optional)"
              value={profile.capacity}
            />
          </div>

          {/* Progress Bar */}
          <div className="mt-8">
            <div className="flex justify-between text-xs text-gray-400 mb-2">
              <span>Progress</span>
              <span>{Math.round((filledFields / requiredFields) * 100)}%</span>
            </div>
            <div className="h-2 bg-cba-navy-light rounded-full overflow-hidden">
              <motion.div
                className="h-full bg-gradient-to-r from-cba-gold to-cba-gold-light"
                initial={{ width: 0 }}
                animate={{ width: `${(filledFields / requiredFields) * 100}%` }}
                transition={{ duration: 0.5 }}
              />
            </div>
          </div>
        </aside>

        {/* Chat Area */}
        <main className="flex-1 flex flex-col">
          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-6 space-y-4">
            <AnimatePresence>
              {messages.map((message, index) => (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.3 }}
                  className={`flex ${message.role === "user" ? "justify-end" : "justify-start"}`}
                >
                  <div
                    className={`max-w-2xl rounded-2xl px-6 py-4 ${
                      message.role === "user"
                        ? "bg-cba-gold text-cba-navy"
                        : "bg-cba-navy-light border border-cba-gold/20"
                    }`}
                  >
                    <p className="whitespace-pre-wrap">{message.content}</p>
                  </div>
                </motion.div>
              ))}
            </AnimatePresence>

            {isLoading && (
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                className="flex justify-start"
              >
                <div className="bg-cba-navy-light border border-cba-gold/20 rounded-2xl px-6 py-4">
                  <Loader2 className="w-5 h-5 text-cba-gold animate-spin" />
                </div>
              </motion.div>
            )}

            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <div className="border-t border-cba-navy-light bg-cba-navy-dark/30 p-6">
            {isComplete ? (
              <div className="max-w-4xl mx-auto text-center">
                <div className="bg-gradient-to-r from-cba-gold/10 to-transparent border border-cba-gold/30 rounded-2xl p-6 mb-4">
                  <h3 className="text-lg font-bold mb-2">Profile Complete! ğŸ‰</h3>
                  <p className="text-gray-300 mb-4">
                    All information gathered. Ready to find your indicators.
                  </p>
                  <Link
                    href={`/results?session_id=${encodeURIComponent(sessionId)}`}
                    className="inline-flex items-center gap-2 bg-cba-gold hover:bg-cba-gold-light text-cba-navy font-semibold px-8 py-3 rounded-lg transition"
                  >
                    View Recommendations
                    <ArrowLeft className="w-4 h-4 rotate-180" />
                  </Link>
                </div>
              </div>
            ) : (
              <div className="max-w-4xl mx-auto flex gap-4">
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder="Type your answer..."
                  className="flex-1 bg-cba-navy-light border border-cba-gold/20 rounded-xl px-6 py-4 focus:outline-none focus:border-cba-gold/40 transition"
                  disabled={isLoading}
                />
                <button
                  onClick={handleSend}
                  disabled={!input.trim() || isLoading}
                  className="bg-cba-gold hover:bg-cba-gold-light disabled:opacity-50 disabled:cursor-not-allowed text-cba-navy font-semibold px-8 py-4 rounded-xl transition flex items-center gap-2"
                >
                  <Send className="w-5 h-5" />
                </button>
              </div>
            )}
          </div>
        </main>
      </div>
    </div>
  );
}

function ProfileField({ icon, label, value }: { icon: React.ReactNode; label: string; value?: string }) {
  return (
    <div className="bg-cba-navy-light/50 rounded-lg p-4 border border-cba-gold/10">
      <div className="flex items-center gap-2 text-xs text-gray-400 mb-2">
        {icon}
        <span>{label}</span>
      </div>
      <div className="text-sm font-medium">
        {value ? (
          <span className="text-white">{value}</span>
        ) : (
          <span className="text-gray-500 italic">Pending...</span>
        )}
      </div>
    </div>
  );
}


export default function ChatPage() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-gradient-to-br from-[#031f35] to-[#042d4a] flex items-center justify-center text-white">Loading...</div>}>
      <ChatPageContent />
    </Suspense>
  );
}
</file>

<file path="cba-frontend/app/compare/page.tsx">
"use client";

import { useSearchParams } from "next/navigation";
import { ArrowLeft, Download, X, Loader2, AlertCircle } from "lucide-react";
import { motion } from "framer-motion";
import Link from "next/link";
import { Suspense, useState, useEffect } from "react";
import { api, Indicator as ApiIndicator } from "@/lib/api";

interface Indicator {
  id: number;
  name: string;
  component: string;
  class: string;
  cost: string;
  accuracy: string;
  ease: string;
  principle: string;
  criterion: string;
  priority: string;
  methods: number;
  definition: string;
}

// Fallback mock data (same as results page)
const fallbackIndicators: Record<number, Indicator> = {
  47: {
    id: 47,
    name: "Species Diversity Index",
    component: "Biotic",
    class: "Biodiversity",
    cost: "Medium",
    accuracy: "High",
    ease: "Medium",
    principle: "Principle 2",
    criterion: "Criterion 2.1",
    priority: "Primary",
    methods: 3,
    definition: "Measures the variety and abundance of species in a given area.",
  },
  89: {
    id: 89,
    name: "Soil Organic Carbon",
    component: "Abiotic",
    class: "Soil Carbon",
    cost: "Low",
    accuracy: "Medium",
    ease: "High",
    principle: "Principle 1",
    criterion: "Criterion 1.2",
    priority: "Primary",
    methods: 3,
    definition: "Quantifies the amount of carbon stored in soil.",
  },
  12: {
    id: 12,
    name: "Water Quality Index",
    component: "Abiotic",
    class: "Water",
    cost: "High",
    accuracy: "High",
    ease: "Low",
    principle: "Principle 3",
    criterion: "Criterion 3.1",
    priority: "Secondary",
    methods: 2,
    definition: "Composite measure of water quality based on multiple parameters.",
  },
  34: {
    id: 34,
    name: "Crop Yield per Hectare",
    component: "Socioeconomic",
    class: "Productivity",
    cost: "Low",
    accuracy: "High",
    ease: "High",
    principle: "Principle 5",
    criterion: "Criterion 5.2",
    priority: "Primary",
    methods: 2,
    definition: "Measures agricultural productivity by quantifying crop output per unit area.",
  },
};

function ComparePageContent() {
  const searchParams = useSearchParams();
  const ids = searchParams.get("ids")?.split(",").map(Number) || [];
  const sessionId = searchParams.get("session_id");
  
  const [indicators, setIndicators] = useState<Indicator[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [usingFallback, setUsingFallback] = useState(false);

  useEffect(() => {
    async function fetchIndicators() {
      if (ids.length === 0) {
        setLoading(false);
        return;
      }

      // If we have a session ID, try to fetch from API
      if (sessionId) {
        try {
          setLoading(true);
          const response = await api.getRecommendations(sessionId);
          
          if (response.indicators && response.indicators.length > 0) {
            // Filter to only the selected IDs
            const filtered = response.indicators
              .filter((ind: ApiIndicator) => ids.includes(ind.id))
              .map((ind: ApiIndicator) => ({
                id: ind.id,
                name: ind.name,
                component: ind.component || "Unknown",
                class: ind.class || "Unknown",
                cost: ind.cost || "Medium",
                accuracy: ind.accuracy || "Medium",
                ease: ind.ease || "Medium",
                principle: ind.principle || "",
                criterion: ind.criterion || "",
                priority: ind.priority || "Primary",
                methods: ind.methods?.length || 0,
                definition: ind.definition || "",
              }));
            
            if (filtered.length > 0) {
              setIndicators(filtered);
              setUsingFallback(false);
              setLoading(false);
              return;
            }
          }
        } catch (err) {
          console.error("Failed to fetch recommendations:", err);
          setError(err instanceof Error ? err.message : "Failed to load");
        }
      }

      // Use fallback data
      const fallbackResults = ids
        .map((id) => fallbackIndicators[id])
        .filter(Boolean);
      setIndicators(fallbackResults);
      setUsingFallback(true);
      setLoading(false);
    }

    fetchIndicators();
  }, [ids.join(","), sessionId]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 text-cba-gold animate-spin mx-auto mb-4" />
          <p className="text-gray-400">Loading comparison...</p>
        </div>
      </div>
    );
  }

  if (indicators.length === 0) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <p className="text-gray-400 mb-4">No indicators selected for comparison</p>
          <Link href={sessionId ? `/results?session_id=${sessionId}` : "/results"} className="text-cba-gold hover:text-cba-gold-light">
            Go back to results
          </Link>
        </div>
      </div>
    );
  }

  const resultsUrl = sessionId ? `/results?session_id=${sessionId}` : "/results";

  return (
    <div className="min-h-screen">
      {/* Warning Banner */}
      {usingFallback && (
        <div className="bg-amber-600 border-b-2 border-amber-400 px-6 py-4">
          <div className="container mx-auto flex items-center gap-3 text-white">
            <div className="bg-amber-800 rounded-full p-2">
              <AlertCircle className="w-5 h-5" />
            </div>
            <div>
              <p className="font-bold text-lg">Comparing Example Data</p>
              <p className="text-amber-100 text-sm">These are sample indicators for demonstration. Complete a chat conversation to compare your personalized recommendations.</p>
            </div>
            <Link
              href="/chat"
              className="ml-auto bg-white text-amber-700 hover:bg-amber-50 font-semibold px-4 py-2 rounded-lg transition whitespace-nowrap"
            >
              Start Chat
            </Link>
          </div>
        </div>
      )}

      {/* Header */}
      <header className="border-b border-cba-navy-light bg-cba-navy-dark/50 backdrop-blur-sm sticky top-0 z-10">
        <div className="container mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href={resultsUrl} className="text-gray-400 hover:text-white transition">
              <ArrowLeft className="w-5 h-5" />
            </Link>
            <div>
              <h1 className="text-lg font-bold flex items-center gap-2">
                {usingFallback ? "Compare Example Indicators" : "Compare Indicators"}
                {usingFallback && (
                  <span className="text-xs font-normal bg-amber-600 text-white px-2 py-0.5 rounded-full">
                    DEMO DATA
                  </span>
                )}
              </h1>
              <p className="text-xs text-gray-400">
                {indicators.length} {usingFallback ? "example indicators" : "indicators"} selected
              </p>
            </div>
          </div>
          <button 
            className="flex items-center gap-2 bg-gray-600 text-gray-300 font-semibold px-4 py-2 rounded-lg cursor-not-allowed opacity-60"
            disabled
            title="Export coming soon"
          >
            <Download className="w-4 h-4" />
            Export (Coming Soon)
          </button>
        </div>
      </header>

      {/* Comparison Table */}
      <main className="container mx-auto px-6 py-8">
        <div className="overflow-x-auto">
          <table className="w-full border-collapse">
            <thead>
              <tr>
                <th className="sticky left-0 bg-cba-navy-dark z-10 p-4 text-left text-sm font-semibold text-gray-400 border-b border-cba-gold/20">
                  Attribute
                </th>
                {indicators.map((indicator) => (
                  <th
                    key={indicator.id}
                    className="p-4 text-left border-b border-cba-gold/20 min-w-[250px]"
                  >
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <div className="text-xs font-mono text-gray-400 mb-1">#{indicator.id}</div>
                        <div className="font-bold text-white">{indicator.name}</div>
                      </div>
                      <Link
                        href={`/results?remove=${indicator.id}`}
                        className="text-gray-400 hover:text-red-400 transition"
                      >
                        <X className="w-4 h-4" />
                      </Link>
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              <ComparisonRow
                label="Component"
                values={indicators.map((i) => i.component)}
                renderValue={(val) => (
                  <span className="px-2 py-1 rounded-full bg-cba-gold/10 text-cba-gold text-xs">
                    {val}
                  </span>
                )}
              />
              <ComparisonRow label="Class" values={indicators.map((i) => i.class)} />
              <ComparisonRow
                label="Cost"
                values={indicators.map((i) => i.cost)}
                renderValue={(val) => <CostBadge value={val} />}
              />
              <ComparisonRow
                label="Accuracy"
                values={indicators.map((i) => i.accuracy)}
                renderValue={(val) => <AccuracyBadge value={val} />}
              />
              <ComparisonRow
                label="Ease of Use"
                values={indicators.map((i) => i.ease)}
                renderValue={(val) => <EaseBadge value={val} />}
              />
              <ComparisonRow
                label="Methods Available"
                values={indicators.map((i) => `${i.methods} methods`)}
              />
              <ComparisonRow label="Principle" values={indicators.map((i) => i.principle)} />
              <ComparisonRow label="Criterion" values={indicators.map((i) => i.criterion)} />
              <ComparisonRow
                label="Priority"
                values={indicators.map((i) => i.priority)}
                renderValue={(val) => (
                  <span
                    className={`px-2 py-1 rounded-full text-xs ${
                      val === "Primary"
                        ? "bg-green-500/10 text-green-400"
                        : "bg-yellow-500/10 text-yellow-400"
                    }`}
                  >
                    {val}
                  </span>
                )}
              />
              <ComparisonRow
                label="Definition"
                values={indicators.map((i) => i.definition)}
                renderValue={(val) => <span className="text-sm text-gray-300">{val}</span>}
              />
            </tbody>
          </table>
        </div>

        {/* Actions */}
        <div className="mt-8 flex gap-4 justify-center">
          <Link
            href={resultsUrl}
            className="bg-cba-navy-light hover:bg-cba-navy text-white font-semibold px-6 py-3 rounded-lg transition"
          >
            Back to Results
          </Link>
          <button 
            className="bg-gray-600 text-gray-300 font-semibold px-6 py-3 rounded-lg cursor-not-allowed opacity-60"
            disabled
            title="Selection coming soon"
          >
            Select Indicators (Coming Soon)
          </button>
        </div>
      </main>
    </div>
  );
}

function ComparisonRow({
  label,
  values,
  renderValue,
}: {
  label: string;
  values: string[];
  renderValue?: (val: string) => React.ReactNode;
}) {
  return (
    <tr className="border-b border-cba-gold/10 hover:bg-cba-navy-light/30 transition">
      <td className="sticky left-0 bg-cba-navy-dark z-10 p-4 text-sm font-semibold text-gray-300">
        {label}
      </td>
      {values.map((value, index) => (
        <td key={index} className="p-4">
          {renderValue ? renderValue(value) : <span className="text-white">{value}</span>}
        </td>
      ))}
    </tr>
  );
}

function CostBadge({ value }: { value: string }) {
  const colors = {
    Low: "text-green-400",
    Medium: "text-yellow-400",
    High: "text-red-400",
  };
  return <span className={`font-semibold ${colors[value as keyof typeof colors]}`}>ğŸ’° {value}</span>;
}

function AccuracyBadge({ value }: { value: string }) {
  const colors = {
    Low: "text-red-400",
    Medium: "text-yellow-400",
    High: "text-green-400",
  };
  return <span className={`font-semibold ${colors[value as keyof typeof colors]}`}>ğŸ“Š {value}</span>;
}

function EaseBadge({ value }: { value: string }) {
  const colors = {
    Low: "text-red-400",
    Medium: "text-yellow-400",
    High: "text-green-400",
  };
  return <span className={`font-semibold ${colors[value as keyof typeof colors]}`}>ğŸ¯ {value}</span>;
}


export default function ComparePage() {
  return (
    <Suspense fallback={<div className="min-h-screen bg-gradient-to-br from-[#031f35] to-[#042d4a] flex items-center justify-center text-white">Loading...</div>}>
      <ComparePageContent />
    </Suspense>
  );
}
</file>

<file path="cba-frontend/app/page.tsx">
"use client";

import { useState } from "react";
import { Upload, MessageSquare, ArrowRight } from "lucide-react";
import { motion } from "framer-motion";

export default function Home() {
  const [selectedFlow, setSelectedFlow] = useState<"upload" | "chat" | null>(null);

  return (
    <main className="min-h-screen">
      {/* Header */}
      <header className="border-b border-cba-navy-light bg-cba-navy-dark/50 backdrop-blur-sm">
        <div className="container mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-cba-gold to-cba-gold-dark flex items-center justify-center">
              <span className="text-cba-navy font-bold text-xl">ğŸŒ</span>
            </div>
            <div>
              <h1 className="text-xl font-bold">CBA Indicator Selection</h1>
              <p className="text-xs text-gray-400">Circular Bioeconomy Alliance</p>
            </div>
          </div>
          <div className="flex gap-4 text-sm text-gray-400">
            <span>Circular Bioeconomy Alliance</span>
          </div>
        </div>
      </header>

      {/* Hero Section */}
      <section className="container mx-auto px-6 py-20">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          className="text-center max-w-4xl mx-auto mb-16"
        >
          <h2 className="text-5xl font-bold mb-6">
            Find the Perfect{" "}
            <span className="text-gradient">Indicators</span>
            <br />
            for Your Project
          </h2>
          <p className="text-xl text-gray-300">
            AI-powered recommendations for monitoring & evaluation indicators
            tailored to your sustainable agriculture project
          </p>
        </motion.div>

        {/* Entry Point Cards */}
        <div className="grid md:grid-cols-2 gap-8 max-w-5xl mx-auto">
          {/* Upload File Card */}
          <motion.div
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.6, delay: 0.2 }}
            className="group relative"
          >
            <div className="absolute inset-0 bg-gradient-to-br from-cba-gold/20 to-transparent rounded-2xl blur-xl group-hover:blur-2xl transition-all" />
            <div className="relative bg-cba-navy-light border border-cba-gold/20 rounded-2xl p-8 hover:border-cba-gold/40 transition-all card-glow-hover cursor-pointer">
              <div className="w-16 h-16 rounded-xl bg-cba-gold/10 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                <Upload className="w-8 h-8 text-cba-gold" />
              </div>
              <h3 className="text-2xl font-bold mb-3">Upload Project File</h3>
              <p className="text-gray-300 mb-6">
                Have a project document? Upload your PDF file and let AI
                analyze it to recommend the best indicators.
              </p>
              <ul className="space-y-2 mb-8 text-sm text-gray-400">
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 rounded-full bg-cba-gold" />
                  Instant analysis of project details
                </li>
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 rounded-full bg-cba-gold" />
                  Identifies missing information
                </li>
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 rounded-full bg-cba-gold" />
                  Guided completion process
                </li>
              </ul>
              <a href="/upload" className="w-full bg-cba-gold hover:bg-cba-gold-light text-cba-navy font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2 group-hover:gap-3">
                Upload File
                <ArrowRight className="w-5 h-5" />
              </a>
            </div>
          </motion.div>

          {/* Start from Scratch Card */}
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ duration: 0.6, delay: 0.3 }}
            className="group relative"
          >
            <div className="absolute inset-0 bg-gradient-to-br from-cba-gold/20 to-transparent rounded-2xl blur-xl group-hover:blur-2xl transition-all" />
            <div className="relative bg-cba-navy-light border border-cba-gold/20 rounded-2xl p-8 hover:border-cba-gold/40 transition-all card-glow-hover cursor-pointer">
              <div className="w-16 h-16 rounded-xl bg-cba-gold/10 flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                <MessageSquare className="w-8 h-8 text-cba-gold" />
              </div>
              <h3 className="text-2xl font-bold mb-3">Start from Scratch</h3>
              <p className="text-gray-300 mb-6">
                Building a new project? Chat with our AI assistant to define your
                project and get personalized indicator recommendations.
              </p>
              <ul className="space-y-2 mb-8 text-sm text-gray-400">
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 rounded-full bg-cba-gold" />
                  Conversational project builder
                </li>
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 rounded-full bg-cba-gold" />
                  Step-by-step guidance
                </li>
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 rounded-full bg-cba-gold" />
                  Real-time recommendations
                </li>
              </ul>
              <a href="/chat" className="w-full bg-cba-gold hover:bg-cba-gold-light text-cba-navy font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2 group-hover:gap-3">
                Start Chat
                <ArrowRight className="w-5 h-5" />
              </a>
            </div>
          </motion.div>
        </div>

        {/* Features */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.4 }}
          className="mt-20 text-center"
        >
          <p className="text-gray-400 mb-6">Powered by</p>
          <div className="flex items-center justify-center gap-8 text-sm text-gray-500">
            <span>Amazon Bedrock</span>
            <span>â€¢</span>
            <span>Claude AI</span>
            <span>â€¢</span>
            <span>801 Methods</span>
            <span>â€¢</span>
            <span>224 Indicators</span>
          </div>
        </motion.div>
      </section>
    </main>
  );
}
</file>

<file path="cba-frontend/app/results/page.tsx">
"use client";

import { useState, useEffect, Suspense } from "react";
import { useSearchParams } from "next/navigation";
import { ArrowLeft, Filter, Grid3x3, List, GitCompare, Download, ChevronDown, ChevronUp, DollarSign, Target, Zap, Loader2, AlertCircle } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import Link from "next/link";
import { api, Indicator as ApiIndicator } from "@/lib/api";

interface Indicator {
  id: number;
  name: string;
  component: string;
  class: string;
  cost: string;
  accuracy: string;
  ease: string;
  principle: string;
  criterion: string;
  priority: string;
  methods: Method[];
  definition: string;
}

interface Method {
  id: number;
  name: string;
  cost: string;
  accuracy: string;
  ease: string;
}

// Fallback data shown when no recommendations are available
const fallbackIndicators: Indicator[] = [
  {
    id: 47,
    name: "Species Diversity Index",
    component: "Biotic",
    class: "Biodiversity",
    cost: "Medium",
    accuracy: "High",
    ease: "Medium",
    principle: "Principle 2",
    criterion: "Criterion 2.1",
    priority: "Primary",
    definition: "Measures the variety and abundance of species in a given area, providing insights into ecosystem health and biodiversity.",
    methods: [
      { id: 1, name: "Random Walks", cost: "Low", accuracy: "Medium", ease: "High" },
      { id: 2, name: "Transect Sampling", cost: "Medium", accuracy: "High", ease: "Medium" },
      { id: 3, name: "Camera Traps", cost: "High", accuracy: "High", ease: "Low" },
    ],
  },
  {
    id: 89,
    name: "Soil Organic Carbon",
    component: "Abiotic",
    class: "Soil Carbon",
    cost: "Low",
    accuracy: "Medium",
    ease: "High",
    principle: "Principle 1",
    criterion: "Criterion 1.2",
    priority: "Primary",
    definition: "Quantifies the amount of carbon stored in soil, a key indicator of soil health and carbon sequestration potential.",
    methods: [
      { id: 4, name: "Walkley-Black Method", cost: "Low", accuracy: "Medium", ease: "High" },
      { id: 5, name: "Loss on Ignition", cost: "Low", accuracy: "Low", ease: "High" },
      { id: 6, name: "Dry Combustion", cost: "High", accuracy: "High", ease: "Medium" },
    ],
  },
  {
    id: 12,
    name: "Water Quality Index",
    component: "Abiotic",
    class: "Water",
    cost: "High",
    accuracy: "High",
    ease: "Low",
    principle: "Principle 3",
    criterion: "Criterion 3.1",
    priority: "Secondary",
    definition: "Composite measure of water quality based on multiple parameters including pH, dissolved oxygen, and contaminants.",
    methods: [
      { id: 7, name: "Field Test Kits", cost: "Medium", accuracy: "Medium", ease: "High" },
      { id: 8, name: "Laboratory Analysis", cost: "High", accuracy: "High", ease: "Low" },
    ],
  },
  {
    id: 34,
    name: "Crop Yield per Hectare",
    component: "Socioeconomic",
    class: "Productivity",
    cost: "Low",
    accuracy: "High",
    ease: "High",
    principle: "Principle 5",
    criterion: "Criterion 5.2",
    priority: "Primary",
    definition: "Measures agricultural productivity by quantifying crop output per unit area, essential for economic viability assessment.",
    methods: [
      { id: 9, name: "Harvest Weighing", cost: "Low", accuracy: "High", ease: "High" },
      { id: 10, name: "Crop Cutting", cost: "Low", accuracy: "High", ease: "Medium" },
    ],
  },
];

function ResultsContent() {
  const searchParams = useSearchParams();
  const sessionId = searchParams.get("session_id");

  const [indicators, setIndicators] = useState<Indicator[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [usingFallback, setUsingFallback] = useState(false);
  const [viewMode, setViewMode] = useState<"grid" | "list">("grid");
  const [expandedId, setExpandedId] = useState<number | null>(null);
  const [selectedForCompare, setSelectedForCompare] = useState<number[]>([]);
  const [filters, setFilters] = useState({
    component: "all",
    cost: "all",
    ease: "all",
  });

  // Fetch recommendations from API
  useEffect(() => {
    async function fetchRecommendations() {
      if (!sessionId) {
        // No session ID - use fallback data
        setIndicators(fallbackIndicators);
        setUsingFallback(true);
        setLoading(false);
        return;
      }

      try {
        setLoading(true);
        setError(null);
        const response = await api.getRecommendations(sessionId);

        if (response.indicators && response.indicators.length > 0) {
          // Transform API indicators to match our interface
          const transformedIndicators: Indicator[] = response.indicators.map((ind: ApiIndicator) => ({
            id: ind.id,
            name: ind.name,
            component: ind.component || "Unknown",
            class: ind.class || "Unknown",
            cost: ind.cost || "Medium",
            accuracy: ind.accuracy || "Medium",
            ease: ind.ease || "Medium",
            principle: ind.principle || "",
            criterion: ind.criterion || "",
            priority: ind.priority || "Primary",
            definition: ind.definition || "",
            methods: ind.methods || [],
          }));
          setIndicators(transformedIndicators);
          setUsingFallback(false);
        } else {
          // No recommendations found - use fallback
          setIndicators(fallbackIndicators);
          setUsingFallback(true);
        }
      } catch (err) {
        console.error("Failed to fetch recommendations:", err);
        setError(err instanceof Error ? err.message : "Failed to load recommendations");
        // Use fallback on error
        setIndicators(fallbackIndicators);
        setUsingFallback(true);
      } finally {
        setLoading(false);
      }
    }

    fetchRecommendations();
  }, [sessionId]);

  const toggleExpand = (id: number) => {
    setExpandedId(expandedId === id ? null : id);
  };

  const toggleCompare = (id: number) => {
    setSelectedForCompare((prev) =>
      prev.includes(id) ? prev.filter((i) => i !== id) : [...prev, id]
    );
  };

  const filteredIndicators = indicators.filter((ind) => {
    if (filters.component !== "all" && ind.component !== filters.component) return false;
    if (filters.cost !== "all" && ind.cost !== filters.cost) return false;
    if (filters.ease !== "all" && ind.ease !== filters.ease) return false;
    return true;
  });

  // Show loading state
  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 text-cba-gold animate-spin mx-auto mb-4" />
          <p className="text-gray-400">Loading recommendations...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen">
      {/* Error/Warning Banner */}
      {error && (
        <div className="bg-red-900/50 border-b border-red-700 px-6 py-3">
          <div className="container mx-auto flex items-center gap-2 text-red-200">
            <AlertCircle className="w-5 h-5" />
            <span>{error}</span>
          </div>
        </div>
      )}

      {usingFallback && !error && (
        <div className="bg-amber-600 border-b-2 border-amber-400 px-6 py-4">
          <div className="container mx-auto flex items-center gap-3 text-white">
            <div className="bg-amber-800 rounded-full p-2">
              <AlertCircle className="w-5 h-5" />
            </div>
            <div>
              <p className="font-bold text-lg">Showing Example Data</p>
              <p className="text-amber-100 text-sm">These are sample indicators for demonstration. Complete a chat conversation to get personalized recommendations for your project.</p>
            </div>
            <Link
              href="/chat"
              className="ml-auto bg-white text-amber-700 hover:bg-amber-50 font-semibold px-4 py-2 rounded-lg transition whitespace-nowrap"
            >
              Start Chat
            </Link>
          </div>
        </div>
      )}

      {/* Header */}
      <header className="border-b border-cba-navy-light bg-cba-navy-dark/50 backdrop-blur-sm sticky top-0 z-10">
        <div className="container mx-auto px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/chat" className="text-gray-400 hover:text-white transition">
              <ArrowLeft className="w-5 h-5" />
            </Link>
            <div>
              <h1 className="text-lg font-bold flex items-center gap-2">
                {usingFallback ? "Example Indicators" : "Recommended Indicators"}
                {usingFallback && (
                  <span className="text-xs font-normal bg-amber-600 text-white px-2 py-0.5 rounded-full">
                    DEMO DATA
                  </span>
                )}
              </h1>
              <p className="text-xs text-gray-400">
                {filteredIndicators.length} {usingFallback ? "example indicators shown" : "indicators found"}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="flex gap-2">
              <button
                onClick={() => setViewMode("grid")}
                className={`p-2 rounded-lg transition ${viewMode === "grid" ? "bg-cba-gold text-cba-navy" : "text-gray-400 hover:text-white"
                  }`}
              >
                <Grid3x3 className="w-5 h-5" />
              </button>
              <button
                onClick={() => setViewMode("list")}
                className={`p-2 rounded-lg transition ${viewMode === "list" ? "bg-cba-gold text-cba-navy" : "text-gray-400 hover:text-white"
                  }`}
              >
                <List className="w-5 h-5" />
              </button>
            </div>
            {selectedForCompare.length > 0 && (
              <Link
                href={`/compare?ids=${selectedForCompare.join(",")}${sessionId ? `&session_id=${sessionId}` : ""}`}
                className="flex items-center gap-2 bg-cba-gold hover:bg-cba-gold-light text-cba-navy font-semibold px-4 py-2 rounded-lg transition"
              >
                <GitCompare className="w-4 h-4" />
                Compare ({selectedForCompare.length})
              </Link>
            )}
            <button
              className="flex items-center gap-2 text-gray-500 cursor-not-allowed opacity-60"
              disabled
              title="Export coming soon"
            >
              <Download className="w-5 h-5" />
            </button>
          </div>
        </div>
      </header>

      <div className="flex">
        {/* Filters Sidebar */}
        <aside className="w-64 border-r border-cba-navy-light bg-cba-navy-dark/30 p-6">
          <h2 className="text-lg font-bold mb-6 flex items-center gap-2">
            <Filter className="w-5 h-5 text-cba-gold" />
            Filters
          </h2>

          <div className="space-y-6">
            <FilterSection
              label="Component"
              value={filters.component}
              onChange={(val) => setFilters({ ...filters, component: val })}
              options={["all", "Biotic", "Abiotic", "Socioeconomic"]}
            />
            <FilterSection
              label="Cost"
              value={filters.cost}
              onChange={(val) => setFilters({ ...filters, cost: val })}
              options={["all", "Low", "Medium", "High"]}
            />
            <FilterSection
              label="Ease of Use"
              value={filters.ease}
              onChange={(val) => setFilters({ ...filters, ease: val })}
              options={["all", "Low", "Medium", "High"]}
            />
          </div>

          <button
            onClick={() => setFilters({ component: "all", cost: "all", ease: "all" })}
            className="w-full mt-6 text-sm text-gray-400 hover:text-white transition"
          >
            Reset Filters
          </button>
        </aside>

        {/* Indicators Grid/List */}
        <main className="flex-1 p-6">
          <div className={viewMode === "grid" ? "grid md:grid-cols-2 gap-6" : "space-y-4"}>
            {filteredIndicators.map((indicator) => (
              <IndicatorCard
                key={indicator.id}
                indicator={indicator}
                isExpanded={expandedId === indicator.id}
                isSelected={selectedForCompare.includes(indicator.id)}
                onToggleExpand={() => toggleExpand(indicator.id)}
                onToggleCompare={() => toggleCompare(indicator.id)}
                viewMode={viewMode}
                isMockData={usingFallback}
              />
            ))}
          </div>
        </main>
      </div>
    </div>
  );
}

function FilterSection({
  label,
  value,
  onChange,
  options,
}: {
  label: string;
  value: string;
  onChange: (val: string) => void;
  options: string[];
}) {
  return (
    <div>
      <label className="text-sm font-semibold text-gray-300 mb-3 block">{label}</label>
      <div className="space-y-2">
        {options.map((option) => (
          <label key={option} className="flex items-center gap-2 cursor-pointer group">
            <input
              type="radio"
              name={label}
              checked={value === option}
              onChange={() => onChange(option)}
              className="w-4 h-4 text-cba-gold"
            />
            <span className="text-sm text-gray-400 group-hover:text-white transition capitalize">
              {option}
            </span>
          </label>
        ))}
      </div>
    </div>
  );
}

function IndicatorCard({
  indicator,
  isExpanded,
  isSelected,
  onToggleExpand,
  onToggleCompare,
  viewMode,
  isMockData = false,
}: {
  indicator: Indicator;
  isExpanded: boolean;
  isSelected: boolean;
  onToggleExpand: () => void;
  onToggleCompare: () => void;
  viewMode: "grid" | "list";
  isMockData?: boolean;
}) {
  return (
    <motion.div
      layout
      className={`bg-cba-navy-light border rounded-2xl overflow-hidden transition-all relative ${isSelected ? "border-cba-gold" : isMockData ? "border-amber-600/40 hover:border-amber-600/60" : "border-cba-gold/20 hover:border-cba-gold/40"
        }`}
    >
      {/* Mock Data Ribbon */}
      {isMockData && (
        <div className="absolute top-0 right-0 bg-amber-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-bl-lg">
          EXAMPLE
        </div>
      )}
      <div className="p-6">
        {/* Header */}
        <div className="flex items-start justify-between mb-4">
          <div className="flex-1">
            <div className="flex items-center gap-2 mb-2">
              <span className="text-xs font-mono text-gray-400">#{indicator.id}</span>
              <span className="text-xs px-2 py-1 rounded-full bg-cba-gold/10 text-cba-gold">
                {indicator.component}
              </span>
            </div>
            <h3 className="text-xl font-bold mb-1">{indicator.name}</h3>
            <p className="text-sm text-gray-400">{indicator.class}</p>
          </div>
        </div>

        {/* Attributes */}
        <div className="flex gap-4 mb-4">
          <AttributeBadge icon={<DollarSign className="w-3 h-3" />} label="Cost" value={indicator.cost} />
          <AttributeBadge icon={<Target className="w-3 h-3" />} label="Accuracy" value={indicator.accuracy} />
          <AttributeBadge icon={<Zap className="w-3 h-3" />} label="Ease" value={indicator.ease} />
        </div>

        {/* Mapping */}
        <div className="text-xs text-gray-400 mb-4">
          {indicator.principle} â€¢ {indicator.criterion} â€¢ {indicator.priority}
        </div>

        {/* Actions */}
        <div className="flex gap-2">
          <button
            onClick={onToggleExpand}
            className="flex-1 bg-cba-navy hover:bg-cba-navy-dark text-white px-4 py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm"
          >
            {isExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
            {isExpanded ? "Hide" : "View"} Methods ({indicator.methods.length})
          </button>
          <button
            onClick={onToggleCompare}
            className={`px-4 py-2 rounded-lg transition text-sm font-semibold ${isSelected
              ? "bg-cba-gold text-cba-navy"
              : "bg-cba-navy hover:bg-cba-navy-dark text-white"
              }`}
          >
            {isSelected ? "Selected" : "Compare"}
          </button>
        </div>

        {/* Expanded Content */}
        <AnimatePresence>
          {isExpanded && (
            <motion.div
              initial={{ height: 0, opacity: 0 }}
              animate={{ height: "auto", opacity: 1 }}
              exit={{ height: 0, opacity: 0 }}
              transition={{ duration: 0.3 }}
              className="mt-4 pt-4 border-t border-cba-gold/20"
            >
              <p className="text-sm text-gray-300 mb-4">{indicator.definition}</p>
              <h4 className="text-sm font-semibold mb-3">Available Methods:</h4>
              <div className="space-y-2">
                {indicator.methods.map((method) => (
                  <div
                    key={method.id}
                    className="bg-cba-navy/50 rounded-lg p-3 flex items-center justify-between"
                  >
                    <span className="text-sm font-medium">{method.name}</span>
                    <div className="flex gap-2 text-xs">
                      <span className="text-gray-400">ğŸ’° {method.cost}</span>
                      <span className="text-gray-400">ğŸ“Š {method.accuracy}</span>
                      <span className="text-gray-400">ğŸ¯ {method.ease}</span>
                    </div>
                  </div>
                ))}
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </motion.div>
  );
}

function AttributeBadge({ icon, label, value }: { icon: React.ReactNode; label: string; value: string }) {
  const colorMap: Record<string, string> = {
    Low: "text-green-400",
    Medium: "text-yellow-400",
    High: "text-red-400",
  };

  return (
    <div className="flex items-center gap-1.5 text-xs">
      <div className="text-gray-400">{icon}</div>
      <span className="text-gray-500">{label}:</span>
      <span className={`font-semibold ${colorMap[value] || "text-gray-300"}`}>{value}</span>
    </div>
  );
}

// Export with Suspense boundary for useSearchParams
export default function ResultsPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 text-cba-gold animate-spin mx-auto mb-4" />
          <p className="text-gray-400">Loading...</p>
        </div>
      </div>
    }>
      <ResultsContent />
    </Suspense>
  );
}
</file>

<file path="cba-frontend/app/upload/page.tsx">
"use client";

import { useState, useCallback } from "react";
import { Upload, FileText, ArrowLeft, CheckCircle, AlertCircle, Loader2 } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import Link from "next/link";

interface AnalysisResult {
  found: {
    location?: string;
    commodity?: string;
    budget?: string;
  };
  missing: string[];
}

export default function UploadPage() {
  const [file, setFile] = useState<File | null>(null);
  const [isDragging, setIsDragging] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysis, setAnalysis] = useState<AnalysisResult | null>(null);

  const handleDrag = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === "dragenter" || e.type === "dragover") {
      setIsDragging(true);
    } else if (e.type === "dragleave") {
      setIsDragging(false);
    }
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragging(false);

    const files = e.dataTransfer.files;
    if (files && files[0]) {
      handleFile(files[0]);
    }
  }, []);

  const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      handleFile(e.target.files[0]);
    }
  };

  const handleFile = async (selectedFile: File) => {
    // Only PDF is supported by the backend
    if (selectedFile.type !== "application/pdf") {
      alert("Please upload a PDF file");
      return;
    }

    setFile(selectedFile);
    analyzeFile(selectedFile);
  };

  const analyzeFile = async (file: File) => {
    setIsAnalyzing(true);

    try {
      const { api } = await import("@/lib/api");
      const result = await api.uploadFile(file);
      setAnalysis(result);
    } catch (error) {
      console.error("Upload failed:", error);
      alert("Failed to analyze file");
    } finally {
      setIsAnalyzing(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col">
      {/* Header */}
      <header className="border-b border-cba-navy-light bg-cba-navy-dark/50 backdrop-blur-sm">
        <div className="container mx-auto px-6 py-4 flex items-center gap-4">
          <Link href="/" className="text-gray-400 hover:text-white transition">
            <ArrowLeft className="w-5 h-5" />
          </Link>
          <div>
            <h1 className="text-lg font-bold">Upload Project File</h1>
            <p className="text-xs text-gray-400">AI will analyze your document</p>
          </div>
        </div>
      </header>

      <main className="flex-1 container mx-auto px-6 py-12">
        <div className="max-w-4xl mx-auto">
          {/* Upload Area */}
          {!file && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              onDragEnter={handleDrag}
              onDragLeave={handleDrag}
              onDragOver={handleDrag}
              onDrop={handleDrop}
              className={`relative border-2 border-dashed rounded-2xl p-12 text-center transition-all ${
                isDragging
                  ? "border-cba-gold bg-cba-gold/5"
                  : "border-cba-gold/30 hover:border-cba-gold/50"
              }`}
            >
              <div className="flex flex-col items-center gap-6">
                <div className="w-20 h-20 rounded-full bg-cba-gold/10 flex items-center justify-center">
                  <Upload className="w-10 h-10 text-cba-gold" />
                </div>
                
                <div>
                  <h2 className="text-2xl font-bold mb-2">Drop your file here</h2>
                  <p className="text-gray-400">or click to browse</p>
                </div>

                <input
                  type="file"
                  onChange={handleFileInput}
                  accept=".pdf"
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />

                <div className="flex gap-4 text-sm text-gray-500">
                  <span>ğŸ“„ PDF only</span>
                  <span>â€¢</span>
                  <span>Max 10MB</span>
                </div>
              </div>
            </motion.div>
          )}

          {/* File Uploaded */}
          {file && (
            <motion.div
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              className="space-y-6"
            >
              {/* File Info */}
              <div className="bg-cba-navy-light border border-cba-gold/20 rounded-2xl p-6 flex items-center gap-4">
                <div className="w-12 h-12 rounded-lg bg-cba-gold/10 flex items-center justify-center">
                  <FileText className="w-6 h-6 text-cba-gold" />
                </div>
                <div className="flex-1">
                  <h3 className="font-semibold">{file.name}</h3>
                  <p className="text-sm text-gray-400">
                    {(file.size / 1024 / 1024).toFixed(2)} MB
                  </p>
                </div>
                {isAnalyzing && (
                  <Loader2 className="w-6 h-6 text-cba-gold animate-spin" />
                )}
              </div>

              {/* Analysis Results */}
              <AnimatePresence>
                {analysis && (
                  <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    className="space-y-6"
                  >
                    {/* Found Information */}
                    <div className="bg-cba-navy-light border border-green-500/20 rounded-2xl p-6">
                      <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                        <CheckCircle className="w-5 h-5 text-green-500" />
                        Information Found
                      </h3>
                      <div className="grid md:grid-cols-3 gap-4">
                        {Object.entries(analysis.found).map(([key, value]) => (
                          <div key={key} className="bg-cba-navy/50 rounded-lg p-4">
                            <div className="text-xs text-gray-400 mb-1 capitalize">{key}</div>
                            <div className="font-semibold text-green-400">{value}</div>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Missing Information */}
                    {analysis.missing.length > 0 && (
                      <div className="bg-cba-navy-light border border-orange-500/20 rounded-2xl p-6">
                        <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                          <AlertCircle className="w-5 h-5 text-orange-500" />
                          Missing Information
                        </h3>
                        <p className="text-gray-300 mb-4">
                          We need a bit more information to recommend the best indicators:
                        </p>
                        <ul className="space-y-2 mb-6">
                          {analysis.missing.map((item, index) => (
                            <li key={index} className="flex items-center gap-2 text-gray-400">
                              <span className="w-1.5 h-1.5 rounded-full bg-orange-500" />
                              {item}
                            </li>
                          ))}
                        </ul>
                        <a
                          href={`/chat?location=${encodeURIComponent(analysis.found.location || "")}&commodity=${encodeURIComponent(analysis.found.commodity || "")}&budget=${encodeURIComponent(analysis.found.budget || "")}`}
                          className="inline-flex items-center gap-2 bg-cba-gold hover:bg-cba-gold-light text-cba-navy font-semibold px-6 py-3 rounded-lg transition"
                        >
                          Complete in Chat
                          <ArrowLeft className="w-4 h-4 rotate-180" />
                        </a>
                      </div>
                    )}

                    {/* All Complete */}
                    {analysis.missing.length === 0 && (
                      <div className="bg-gradient-to-r from-cba-gold/10 to-transparent border border-cba-gold/30 rounded-2xl p-6 text-center">
                        <CheckCircle className="w-12 h-12 text-cba-gold mx-auto mb-4" />
                        <h3 className="text-xl font-bold mb-2">All Set!</h3>
                        <p className="text-gray-300 mb-6">
                          We have all the information needed. Let's find your indicators.
                        </p>
                        <Link
                          href={`/chat?location=${encodeURIComponent(analysis.found.location || "")}&commodity=${encodeURIComponent(analysis.found.commodity || "")}&budget=${encodeURIComponent(analysis.found.budget || "")}`}
                          className="inline-block bg-cba-gold hover:bg-cba-gold-light text-cba-navy font-semibold px-8 py-3 rounded-lg transition"
                        >
                          Get Recommendations
                        </Link>
                      </div>
                    )}
                  </motion.div>
                )}
              </AnimatePresence>
            </motion.div>
          )}
        </div>
      </main>
    </div>
  );
}
</file>

<file path="cba-frontend/lib/api.ts">
// API URL from environment variable with fallback for development
const API_URL = process.env.NEXT_PUBLIC_API_URL || "https://pjuuem2fn8.execute-api.us-west-2.amazonaws.com/prod";

if (!process.env.NEXT_PUBLIC_API_URL && typeof window !== 'undefined') {
  console.warn("NEXT_PUBLIC_API_URL not set, using fallback. Set this in production.");
}

export interface Indicator {
  id: number;
  name: string;
  definition: string;
  component: string;
  class: string;
  cost: string;
  accuracy: string;
  ease: string;
  principle: string;
  criterion: string;
  priority: string;
  methods: Array<{
    id: number;
    name: string;
    cost: string;
    accuracy: string;
    ease: string;
  }>;
}

export interface ChatResponse {
  response: string;
  session_id: string;
  has_recommendations?: boolean;
}

export interface UploadResponse {
  found: {
    location?: string;
    commodity?: string;
    budget?: string;
  };
  missing: string[];
  s3_uri?: string;
}

export interface RecommendationsResponse {
  indicators: Indicator[];
  session_id?: string;
  message?: string;
}

export const api = {
  async chat(message: string, sessionId?: string, profile?: any): Promise<ChatResponse> {
    const res = await fetch(`${API_URL}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, session_id: sessionId, profile }),
    });
    if (!res.ok) {
      const error = await res.json().catch(() => ({ error: "Chat failed" }));
      throw new Error(error.error || "Chat failed");
    }
    return res.json();
  },

  async uploadFile(file: File): Promise<UploadResponse> {
    // Convert file to base64 for Lambda compatibility
    const buffer = await file.arrayBuffer();
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    const base64 = btoa(binary);

    const res = await fetch(`${API_URL}/upload`, {
      method: "POST",
      headers: {
        "Content-Type": "application/octet-stream",
      },
      body: base64,
    });
    if (!res.ok) {
      const error = await res.json().catch(() => ({ error: "Upload failed" }));
      throw new Error(error.error || "Upload failed");
    }
    return res.json();
  },

  async getRecommendations(sessionId: string): Promise<RecommendationsResponse> {
    const res = await fetch(`${API_URL}/recommendations?session_id=${encodeURIComponent(sessionId)}`, {
      method: "GET",
      headers: { "Content-Type": "application/json" },
    });
    if (!res.ok) {
      const error = await res.json().catch(() => ({ error: "Failed to fetch recommendations" }));
      throw new Error(error.error || "Failed to fetch recommendations");
    }
    return res.json();
  },
};
</file>

<file path="CLAUDE.md">
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Quick Start (Hackathon Demo)

```bash
# Run the production frontend (connects to pre-deployed AWS backend)
cd cba-frontend
npm install
npm run dev
# Open http://localhost:3000
```

## Project Structure

```
coffee-recipe/
â”œâ”€â”€ cba-frontend/                 # Production Next.js frontend
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ page.tsx              # Landing page
â”‚   â”‚   â”œâ”€â”€ chat/page.tsx         # Chat interface
â”‚   â”‚   â”œâ”€â”€ upload/page.tsx       # PDF upload
â”‚   â”‚   â”œâ”€â”€ results/page.tsx      # Indicator recommendations
â”‚   â”‚   â””â”€â”€ compare/page.tsx      # Side-by-side comparison
â”‚   â””â”€â”€ lib/api.ts                # API client
â”œâ”€â”€ lambda_function.py            # AWS Lambda API handler
â”œâ”€â”€ agentcore-cba/                # Bedrock AgentCore agent
â”‚   â””â”€â”€ cbaindicatoragent/
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ main.py           # Agent entry point
â”‚       â”‚   â”œâ”€â”€ kb_tool.py        # Knowledge Base search tools
â”‚       â”‚   â””â”€â”€ profile_tools.py  # Project profile management
â”‚       â””â”€â”€ cdk/                  # CDK deployment
â”œâ”€â”€ src/                          # Legacy (not production)
â”‚   â”œâ”€â”€ agent.py                  # CLI agent (dev only)
â”‚   â””â”€â”€ app.py                    # Streamlit UI (dev only)
â”œâ”€â”€ DEPLOYMENT.md                 # Full deployment guide
â”œâ”€â”€ CODE_REVIEW.md                # Architecture review
â””â”€â”€ PRESENTER_GUIDE.md            # Demo walkthrough
```

## Architecture

**Production stack:**
```
Next.js Frontend â†’ API Gateway â†’ Lambda â†’ AgentCore â†’ Knowledge Base
     (local)          (AWS)       (AWS)     (AWS)        (AWS)
```

### Frontend (`cba-frontend/`)

- **Framework:** Next.js 15 with React 19, TypeScript
- **Styling:** Tailwind CSS with CBA branding (#031f35 navy, #FBAD17 gold)
- **Animations:** Framer Motion
- **API URL:** Defaults to pre-deployed AWS backend; override with `NEXT_PUBLIC_API_URL`

Key pages:
- `/` - Landing with Upload/Chat entry points
- `/chat` - Conversational project builder with profile sidebar
- `/upload` - PDF drag-and-drop with auto-extraction
- `/results` - Indicator cards with filtering
- `/compare` - Side-by-side indicator comparison

### Lambda (`lambda_function.py`)

Routes:
- `POST /chat` - Proxies to AgentCore, extracts indicators from response
- `POST /upload` - Stores PDF to S3, extracts text with pypdf, analyzes with Claude
- `GET /recommendations?session_id=xxx` - Returns stored indicator recommendations

Environment variables:
- `BEDROCK_AGENTCORE_ARN` - AgentCore runtime ARN
- `UPLOAD_BUCKET_NAME` - S3 bucket for PDF uploads
- `AWS_REGION` - AWS region (default: us-west-2)

### AgentCore Agent (`agentcore-cba/`)

- **Framework:** Strands Agents on Bedrock AgentCore
- **Model:** Claude Sonnet 4
- **Knowledge Base:** 801 methods, 224 indicators (ID: `0ZQBMXEKDI`)

Tools:
- `search_cba_indicators()` - General indicator search
- `search_indicators_by_outcome()` - Outcome-aligned search
- `search_methods_by_budget()` - Budget-appropriate methods
- `search_location_specific_indicators()` - Region-specific search
- `set_project_*()` / `get_project_profile()` - Profile management

## Commands

```bash
# Frontend (production)
cd cba-frontend
npm install
npm run dev          # Development server at localhost:3000
npm run build        # Production build

# Legacy CLI agent (development only)
uv sync
uv run python src/agent.py

# Legacy Streamlit (development only)
uv run streamlit run src/app.py

# Deploy AgentCore
cd agentcore-cba/cbaindicatoragent/cdk
npm install
npm run cdk:deploy

# Update Lambda
zip lambda_function.zip lambda_function.py
aws lambda update-function-code --function-name cba-indicator-api --zip-file fileb://lambda_function.zip
```

## API Patterns

### Chat Request
```typescript
POST /chat
{
  "message": "I have a coffee project in Brazil",
  "session_id": "session-123",
  "profile": { "location": "Brazil" }
}
// Response: { "response": "...", "session_id": "...", "has_recommendations": true }
```

### Upload Request
```typescript
POST /upload
Content-Type: application/octet-stream
Body: <base64-encoded PDF>
// Response: { "found": { "location": "...", "commodity": "..." }, "missing": [...] }
```

### Recommendations Request
```typescript
GET /recommendations?session_id=session-123
// Response: { "indicators": [...], "session_id": "..." }
```

## Key Files to Edit

| Task | File(s) |
|------|---------|
| Change UI styling | `cba-frontend/tailwind.config.ts`, `app/globals.css` |
| Modify chat behavior | `cba-frontend/app/chat/page.tsx` |
| Update API routes | `lambda_function.py` |
| Change agent prompts | `agentcore-cba/cbaindicatoragent/src/main.py` |
| Add KB search tools | `agentcore-cba/cbaindicatoragent/src/kb_tool.py` |

## Known Limitations

- **In-memory recommendations:** Lambda stores recommendations in memory; lost on cold start
- **PDF only:** Upload accepts PDF files only (no Excel)
- **Export disabled:** Export buttons are placeholder (coming soon)
- **Profile heuristics:** Chat sidebar uses keyword matching to track profile state

## AWS Configuration

Required environment variables for local development with your own backend:
```bash
export NEXT_PUBLIC_API_URL=https://your-api.execute-api.us-west-2.amazonaws.com/prod
export AWS_DEFAULT_REGION=us-west-2
```

For the pre-deployed hackathon backend, no configuration is needed.
</file>

<file path="lambda_function.py">
import json
import boto3
import uuid
import base64
import os
import io
import logging

# Configure logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# PDF extraction - pypdf must be included in Lambda layer
try:
    from pypdf import PdfReader
    PDF_SUPPORT = True
except ImportError:
    logger.warning("pypdf not available - PDF text extraction disabled")
    PDF_SUPPORT = False

# Get configuration from environment variables (with fallbacks for local dev)
AGENT_ARN = os.environ.get('BEDROCK_AGENTCORE_ARN', 'arn:aws:bedrock-agentcore:us-west-2:687995992314:runtime/cbaindicatoragent_Agent-buoE288RIT')
UPLOAD_BUCKET = os.environ.get('UPLOAD_BUCKET_NAME', 'cba-indicator-uploads')
AWS_REGION = os.environ.get('AWS_REGION', 'us-west-2')

agentcore = boto3.client('bedrock-agentcore', region_name=AWS_REGION)
s3 = boto3.client('s3', region_name=AWS_REGION)
bedrock_runtime = boto3.client('bedrock-runtime', region_name=AWS_REGION)

# In-memory store for recommendations (in production, use DynamoDB)
recommendations_store = {}

def lambda_handler(event, context):
    path = event.get('rawPath', event.get('path', ''))
    method = event.get('requestContext', {}).get('http', {}).get('method', 'POST')
    
    # Handle CORS preflight
    if method == 'OPTIONS':
        return cors_response()
    
    # Route to appropriate handler (handle both /chat and /prod/chat)
    if '/chat' in path:
        return handle_chat(event)
    elif '/upload' in path:
        return handle_upload(event)
    elif '/recommendations' in path:
        return handle_recommendations(event)
    else:
        return {
            'statusCode': 404,
            'headers': cors_headers(),
            'body': json.dumps({'error': 'Not found'})
        }

def cors_headers():
    """Return standard CORS headers."""
    return {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type'
    }

def cors_response():
    """Return CORS preflight response."""
    return {
        'statusCode': 200,
        'headers': cors_headers(),
        'body': ''
    }

def error_response(message, status_code=400):
    """Return standardized error response."""
    return {
        'statusCode': status_code,
        'headers': cors_headers(),
        'body': json.dumps({'error': message})
    }

def handle_chat(event):
    try:
        body = json.loads(event.get('body', '{}'))
        message = body.get('message', '')
        session_id = body.get('session_id') or str(uuid.uuid4())
        
        # Input validation
        if not message or not message.strip():
            return error_response("Message is required", 400)
        if len(message) > 10000:
            return error_response("Message too long. Maximum 10000 characters.", 400)
        
        payload = json.dumps({"prompt": message}).encode()
        
        response = agentcore.invoke_agent_runtime(
            agentRuntimeArn=AGENT_ARN,
            runtimeSessionId=session_id,
            payload=payload,
            qualifier="DEFAULT"
        )
        
        content = []
        for chunk in response.get("response", []):
            decoded = chunk.decode('utf-8')
            for line in decoded.split('\n'):
                line = line.strip()
                if line.startswith('data: '):
                    text = line[6:].strip().strip('"')
                    if text:
                        content.append(text)
        
        # Join and clean up formatting
        response_text = ''.join(content)
        response_text = response_text.replace('\\n', '\n')  # Fix escaped newlines
        
        # Try to extract indicator recommendations from the response
        indicators = extract_indicators_from_response(response_text)
        if indicators:
            # Store recommendations for this session
            recommendations_store[session_id] = {
                'indicators': indicators,
                'timestamp': str(uuid.uuid1())  # For TTL tracking
            }
            logger.info(f"Stored {len(indicators)} indicators for session {session_id}")
        
        return {
            'statusCode': 200,
            'headers': cors_headers(),
            'body': json.dumps({
                'response': response_text,
                'session_id': session_id,
                'has_recommendations': len(indicators) > 0
            })
        }
    except Exception as e:
        logger.error(f"Chat handler error: {e}")
        return error_response(f"Chat processing failed: {str(e)}", 500)

def handle_upload(event):
    try:
        # Get base64 encoded file
        body = event.get('body', '')
        is_base64 = event.get('isBase64Encoded', False)
        
        if not body:
            return error_response("No file content provided", 400)
        
        if isinstance(body, str):
            if is_base64:
                file_bytes = base64.b64decode(body)
            else:
                # Some API Gateway configs pass base64 but don't set isBase64Encoded
                try:
                    file_bytes = base64.b64decode(body, validate=True)
                except Exception:
                    file_bytes = body.encode()
        else:
            file_bytes = body
        
        # Validate file size (max 10MB)
        if len(file_bytes) > 10 * 1024 * 1024:
            return error_response("File too large. Maximum size is 10MB.", 413)
        
        # Upload to S3
        file_key = f"uploads/{uuid.uuid4()}.pdf"
        s3.put_object(Bucket=UPLOAD_BUCKET, Key=file_key, Body=file_bytes)
        s3_uri = f"s3://{UPLOAD_BUCKET}/{file_key}"
        logger.info(f"File uploaded to {s3_uri}")
        
        # Extract text from PDF
        document_text = ""
        if PDF_SUPPORT:
            try:
                reader = PdfReader(io.BytesIO(file_bytes))
                text_parts = []
                for page in reader.pages:
                    page_text = page.extract_text()
                    if page_text:
                        text_parts.append(page_text)
                document_text = "\n".join(text_parts)
                logger.info(f"Extracted {len(document_text)} characters from PDF")
            except Exception as pdf_error:
                logger.error(f"PDF extraction failed: {pdf_error}")
                return error_response(f"Could not read PDF file: {str(pdf_error)}", 422)
        else:
            return error_response("PDF processing not available. Please contact support.", 503)
        
        if not document_text.strip():
            return error_response("PDF appears to be empty or contains no extractable text.", 422)
        
        # Use Claude to analyze the document content (truncate to avoid token limits)
        truncated_text = document_text[:15000]  # ~4k tokens
        prompt = """Analyze this project document and extract:
1. Location/Region
2. Primary Commodity/Product
3. Budget Range

Return ONLY a JSON object with these fields: {"location": "...", "commodity": "...", "budget": "..."}
If a field cannot be determined, use null for that field."""
        
        response = bedrock_runtime.invoke_model(
            modelId='us.anthropic.claude-sonnet-4-5-20250929-v1:0',
            body=json.dumps({
                "anthropic_version": "bedrock-2023-05-31",
                "max_tokens": 500,
                "messages": [{
                    "role": "user",
                    "content": f"{prompt}\n\nDocument content:\n{truncated_text}"
                }]
            })
        )
        
        result = json.loads(response['body'].read())
        extracted = result['content'][0]['text']
        
        # Try to parse JSON - handle markdown code blocks
        extracted_clean = extracted.strip()
        if extracted_clean.startswith('```'):
            # Remove markdown code block
            lines = extracted_clean.split('\n')
            extracted_clean = '\n'.join(lines[1:-1] if lines[-1] == '```' else lines[1:])
        
        try:
            data = json.loads(extracted_clean)
        except json.JSONDecodeError as e:
            logger.error(f"Failed to parse Claude response as JSON: {e}\nResponse: {extracted}")
            return error_response("Could not extract project information from document. Please ensure it contains location, commodity, and budget details.", 422)
        
        # Format response to match frontend expectations
        found = {}
        missing = []
        
        if data.get('location'):
            found['location'] = data['location']
        else:
            missing.append('Project Location')
            
        if data.get('commodity'):
            found['commodity'] = data['commodity']
        else:
            missing.append('Primary Commodity')
            
        if data.get('budget'):
            found['budget'] = data['budget']
        else:
            missing.append('Budget Range')
        
        return {
            'statusCode': 200,
            'headers': cors_headers(),
            'body': json.dumps({'found': found, 'missing': missing, 's3_uri': s3_uri})
        }
    except Exception as e:
        logger.error(f"Upload handler error: {e}")
        return error_response(f"Upload processing failed: {str(e)}", 500)

def extract_indicators_from_response(response_text):
    """
    Extract structured indicator data from agent response.
    Parses the formatted output to create indicator objects.
    """
    indicators = []
    
    # Look for indicator blocks in the response
    # Format: INDICATOR #X with ID, Name, Definition, Method, Attributes
    import re
    
    # Pattern to match indicator blocks
    indicator_pattern = r'INDICATOR #(\d+).*?ID:\s*([^\n]+).*?Name:\s*([^\n]+).*?(?:Full Definition|Definition):\s*([^\n]+(?:\n(?!Recommended|Why|Attributes|Mapping|DOI)[^\n]+)*)'
    
    matches = re.findall(indicator_pattern, response_text, re.DOTALL | re.IGNORECASE)
    
    for match in matches:
        try:
            indicator = {
                'id': int(match[1].strip()) if match[1].strip().isdigit() else hash(match[1].strip()) % 1000,
                'name': match[2].strip(),
                'definition': match[3].strip()[:500],  # Truncate long definitions
                'component': 'Unknown',  # Could be parsed if present
                'class': 'Unknown',
                'cost': 'Medium',
                'accuracy': 'Medium',
                'ease': 'Medium',
                'principle': '',
                'criterion': '',
                'priority': 'Primary',
                'methods': []
            }
            
            # Try to extract attributes if present
            attr_match = re.search(r'Accuracy:\s*(\w+)', response_text[response_text.find(match[2]):])
            if attr_match:
                indicator['accuracy'] = attr_match.group(1)
            
            cost_match = re.search(r'Cost:\s*(\w+)', response_text[response_text.find(match[2]):])
            if cost_match:
                indicator['cost'] = cost_match.group(1)
            
            ease_match = re.search(r'Ease[^:]*:\s*(\w+)', response_text[response_text.find(match[2]):])
            if ease_match:
                indicator['ease'] = ease_match.group(1)
            
            indicators.append(indicator)
        except Exception as e:
            logger.warning(f"Failed to parse indicator: {e}")
            continue
    
    return indicators

def handle_recommendations(event):
    """
    Handle GET /recommendations?session_id=xxx
    Returns stored indicator recommendations for a session.
    """
    try:
        # Get session_id from query parameters
        params = event.get('queryStringParameters', {}) or {}
        session_id = params.get('session_id')
        
        if not session_id:
            return error_response("session_id query parameter is required", 400)
        
        # Look up recommendations for this session
        session_data = recommendations_store.get(session_id)
        
        if not session_data:
            # Return empty array if no recommendations found
            return {
                'statusCode': 200,
                'headers': cors_headers(),
                'body': json.dumps({
                    'indicators': [],
                    'message': 'No recommendations found for this session. Please complete the chat conversation first.'
                })
            }
        
        return {
            'statusCode': 200,
            'headers': cors_headers(),
            'body': json.dumps({
                'indicators': session_data['indicators'],
                'session_id': session_id
            })
        }
    except Exception as e:
        logger.error(f"Recommendations handler error: {e}")
        return error_response(f"Failed to retrieve recommendations: {str(e)}", 500)
</file>

<file path="src/app.py">
"""
Circular Bioeconomy Alliance Chat App - A nature-focused chat application with session management and file upload capabilities.
"""

import streamlit as st
import uuid
import datetime
import io
import csv
import os
import sys
from pathlib import Path

# Add project root to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from strands import Agent
from strands.models import BedrockModel
from strands_tools import memory, use_llm
from pypdf import PdfReader
import openpyxl

# Import shared configuration
from config import MODEL_ID, KNOWLEDGE_BASE_ID, SYSTEM_PROMPT

# Set up page configuration
st.set_page_config(
    page_title="CBA Chat Assistant",
    page_icon="ğŸŒ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for CBA branding and color scheme
st.markdown("""
<style>
    /* CBA Color Palette - Official brand colors */
    :root {
        --cba-main-background: #031f35;
        --cba-accent-gold: #FBAD17;
        --cba-text-light: #FFFFFF;
        --cba-text-muted: #B0B0B0;
        --cba-card-background: #0a2a42;
        --cba-border-color: #1a3a52;
        --cba-hover-background: #FBAD17;
        --cba-selected-background: #FBAD17;
    }
    
    /* Main app styling */
    .main .block-container {
        background-color: var(--cba-main-background);
        padding-top: 2rem;
        color: var(--cba-text-light);
    }
    
    /* Sidebar styling */
    .css-1d391kg {
        background-color: var(--cba-main-background);
    }
    
    /* Override Streamlit's default styling */
    .stApp {
        background-color: var(--cba-main-background);
    }
    
    /* Chat input styling */
    .stChatInput > div > div > div > div {
        background-color: var(--cba-card-background);
        border: 1px solid var(--cba-border-color);
        color: var(--cba-text-light);
    }
    
    /* Text styling */
    .stMarkdown, .stText, p, div {
        color: var(--cba-text-light);
    }
    
    /* CBA Logo and Header Styling */
    .cba-header {
        text-align: center;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        border: 2px solid var(--cba-accent-gold);
    }
    
    .cba-logo-img {
        width: 100%;
        max-width: 280px;
        height: auto;
        border-radius: 8px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .cba-logo-img:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(251, 173, 23, 0.3);
    }
    
    /* Principles section styling */
    .cba-principles {
        background-color: var(--cba-card-background);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid var(--cba-accent-gold);
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .cba-principles h4 {
        color: var(--cba-accent-gold);
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }
    
    .cba-principles ul {
        margin: 0;
        padding-left: 1rem;
        font-size: 0.85rem;
        color: var(--cba-text-light);
    }
    
    .cba-principles li {
        margin-bottom: 0.3rem;
    }
    
    .cba-principles p {
        color: var(--cba-text-muted);
    }
    
    /* Button styling */
    .stButton > button {
        background-color: var(--cba-card-background);
        color: var(--cba-text-light);
        border: 1px solid var(--cba-border-color);
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .stButton > button:hover {
        background-color: var(--cba-hover-background);
        color: var(--cba-main-background);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(251, 173, 23, 0.3);
        border-color: var(--cba-accent-gold);
    }
    
    .stButton > button:active,
    .stButton > button:focus {
        background-color: var(--cba-selected-background);
        color: var(--cba-main-background);
        border-color: var(--cba-accent-gold);
    }
    
    /* Chat message styling */
    .stChatMessage {
        border-radius: 10px;
        margin-bottom: 1rem;
        background-color: var(--cba-card-background);
        border: 1px solid var(--cba-border-color);
    }
    
    /* File uploader styling */
    .stFileUploader {
        background-color: var(--cba-card-background);
        border-radius: 8px;
        padding: 1rem;
        border: 2px dashed var(--cba-accent-gold);
    }
    
    /* Success message styling */
    .stSuccess {
        background-color: var(--cba-card-background);
        color: var(--cba-text-light);
        border-radius: 6px;
        border-left: 4px solid var(--cba-accent-gold);
    }
    
    /* Info message styling */
    .stInfo {
        background-color: var(--cba-card-background);
        color: var(--cba-text-light);
        border-radius: 6px;
        border-left: 4px solid var(--cba-accent-gold);
    }
    
    /* Main title styling */
    h1 {
        color: var(--cba-accent-gold);
        text-align: center;
        margin-bottom: 2rem;
    }
    
    /* Section headers */
    h2, h3 {
        color: var(--cba-accent-gold);
    }
    
    /* Divider styling */
    hr {
        border-color: var(--cba-border-color);
        margin: 1.5rem 0;
    }
    
    /* Expander styling */
    .streamlit-expanderHeader {
        background-color: var(--cba-card-background);
        color: var(--cba-text-light);
    }
    
    .streamlit-expanderContent {
        background-color: var(--cba-card-background);
        border: 1px solid var(--cba-border-color);
    }
    
    /* Text area styling */
    .stTextArea > div > div > textarea {
        background-color: var(--cba-card-background);
        color: var(--cba-text-light);
        border: 1px solid var(--cba-border-color);
    }
</style>
""", unsafe_allow_html=True)

# Initialize session state
def initialize_session_state():
    """Initialize session state variables for the chat app."""
    
    # Initialize sessions dictionary in session state (Requirement 4.1)
    if "sessions" not in st.session_state:
        st.session_state.sessions = {}
    
    # Set up current_session_id tracking (Requirement 4.2)
    if "current_session_id" not in st.session_state:
        # Create initial session if none exists
        initial_session_id = str(uuid.uuid4())
        st.session_state.current_session_id = initial_session_id
        st.session_state.sessions[initial_session_id] = {
            "title": "New Conversation",
            "created_at": datetime.datetime.now(),
            "messages": [],
            "uploaded_files": []
        }
    
    # Initialize messages list for current session (Requirement 4.3)
    if "messages" not in st.session_state:
        current_session = st.session_state.sessions.get(st.session_state.current_session_id, {})
        st.session_state.messages = current_session.get("messages", [])

# Session management functions
def create_new_session():
    """
    Create a new chat session with unique ID and empty messages.
    Sets the new session as the current active session.
    Requirement 2.1: WHEN a user clicks new chat, THE Chat_App SHALL create a new session with unique ID
    """
    # Generate UUID for new session
    new_session_id = str(uuid.uuid4())
    
    # Create session data structure with empty messages
    new_session = {
        "title": "New Conversation",
        "created_at": datetime.datetime.now(),
        "messages": [],
        "uploaded_files": []
    }
    
    # Add to sessions dictionary
    st.session_state.sessions[new_session_id] = new_session
    
    # Set as current active session
    st.session_state.current_session_id = new_session_id
    st.session_state.messages = []
    
    return new_session_id

def switch_session(session_id):
    """
    Switch to a different session by loading its messages and updating current session state.
    Requirement 2.2: WHEN a user selects a session, THE Chat_App SHALL load that session's messages
    """
    # Validate session exists
    if session_id not in st.session_state.sessions:
        st.error(f"Session {session_id} not found")
        return False
    
    # Load messages from selected session
    selected_session = st.session_state.sessions[session_id]
    
    # Update current session state
    st.session_state.current_session_id = session_id
    st.session_state.messages = selected_session["messages"].copy()
    
    return True

def generate_session_title(first_message):
    """
    Generate a readable session title from the first message.
    Requirement 2.4: THE Chat_App SHALL auto-generate session titles from first message
    """
    if not first_message or not first_message.strip():
        return "New Conversation"
    
    # Extract first few words from first message
    words = first_message.strip().split()
    
    # Create readable session title (limit to first 5 words, max 50 characters)
    if len(words) <= 5:
        title = " ".join(words)
    else:
        title = " ".join(words[:5]) + "..."
    
    # Ensure title doesn't exceed 50 characters
    if len(title) > 50:
        title = title[:47] + "..."
    
    return title

def extract_file_content(uploaded_file):
    """
    Extract text content from uploaded files of different types.
    Handles TXT, PDF, DOCX, and CSV files.
    Requirement 3.3: THE Chat_App SHALL include file content in LLM context
    """
    if uploaded_file is None:
        return ""
    
    try:
        file_extension = uploaded_file.name.split('.')[-1].lower()
        
        if file_extension == 'txt':
            # Handle TXT files
            content = uploaded_file.read().decode('utf-8')
            return content
            
        elif file_extension == 'csv':
            # Handle CSV files
            uploaded_file.seek(0)  # Reset file pointer
            content = uploaded_file.read().decode('utf-8')
            
            # Parse CSV and convert to readable text
            csv_reader = csv.reader(io.StringIO(content))
            rows = list(csv_reader)
            
            if not rows:
                return "Empty CSV file"
            
            # Format CSV as text with headers and data
            formatted_content = []
            if len(rows) > 0:
                headers = rows[0]
                formatted_content.append("CSV Headers: " + ", ".join(headers))
                formatted_content.append("\nData:")
                
                # Include first 10 rows of data to avoid overwhelming context
                for i, row in enumerate(rows[1:11], 1):
                    formatted_content.append(f"Row {i}: " + ", ".join(row))
                
                if len(rows) > 11:
                    formatted_content.append(f"... and {len(rows) - 11} more rows")
            
            return "\n".join(formatted_content)
            
        elif file_extension == 'pdf':
            # Handle PDF files using pypdf
            try:
                uploaded_file.seek(0)
                reader = PdfReader(io.BytesIO(uploaded_file.read()))
                text = []
                for page in reader.pages:
                    page_text = page.extract_text()
                    if page_text:
                        text.append(page_text)
                return "\n".join(text) if text else "PDF file appears to be empty or contains no extractable text."
            except Exception as e:
                return f"Error extracting PDF content: {str(e)}"
            
        elif file_extension in ['xlsx', 'xls']:
            # Handle Excel files using openpyxl
            try:
                uploaded_file.seek(0)
                wb = openpyxl.load_workbook(io.BytesIO(uploaded_file.read()), data_only=True)
                text = []
                for sheet_name in wb.sheetnames:
                    sheet = wb[sheet_name]
                    text.append(f"=== Sheet: {sheet_name} ===")
                    for row in sheet.iter_rows(values_only=True):
                        row_text = [str(cell) if cell is not None else "" for cell in row]
                        if any(row_text):  # Skip empty rows
                            text.append(" | ".join(row_text))
                return "\n".join(text)
            except Exception as e:
                return f"Error extracting Excel content: {str(e)}"
            
        elif file_extension == 'docx':
            # DOCX requires python-docx which is not in dependencies
            return f"DOCX file '{uploaded_file.name}' uploaded. DOCX text extraction requires python-docx library."
            
        else:
            return f"Unsupported file type: {file_extension}"
            
    except Exception as e:
        return f"Error processing file '{uploaded_file.name}': {str(e)}"

@st.cache_resource
def get_agent():
    """
    Initialize and cache the Strands agent for the CBA chatbot.
    Uses st.cache_resource to ensure the agent is only created once per session.
    """
    bedrock_model = BedrockModel(
        model_id=MODEL_ID,
        temperature=0.2,  # Low temperature for more focused responses
    )
    agent = Agent(
        model=bedrock_model,
        system_prompt=SYSTEM_PROMPT,
        tools=[memory, use_llm],
    )
    return agent


def get_agent_response(user_message, file_content=None):
    """
    Get response from the Strands agent with CBA Knowledge Base integration.
    Requirement 1.2: WHEN the LLM responds, THE Chat_App SHALL stream the response
    Requirement 3.3: THE Chat_App SHALL include file content in LLM context
    """
    agent = get_agent()

    # Build the prompt with file context if available
    if file_content and file_content.strip():
        full_prompt = f"""User question: {user_message}

The user has also provided the following document content for context:
---
{file_content[:2000]}{'...[truncated]' if len(file_content) > 2000 else ''}
---

Please consider this document when answering."""
    else:
        full_prompt = user_message

    # Get response from agent
    result = agent(full_prompt)

    # Extract text response from agent result
    response_text = str(result)

    # Yield response in chunks for streaming effect
    words = response_text.split()
    for i in range(0, len(words), 3):  # Yield 3 words at a time
        chunk = " ".join(words[i:i+3]) + " "
        yield chunk

def main():
    """
    Main function that orchestrates the entire Streamlit chat application.
    
    This function:
    - Initializes session state (Requirement 4.1, 4.2, 4.3)
    - Renders sidebar components (Requirements 2.1, 2.3, 3.1, 3.2)
    - Renders main chat area (Requirements 1.1, 1.3)
    - Handles user interactions (Requirements 1.1, 1.2, 1.4)
    """
    
    # Set up main title
    st.title("ğŸŒ Circular Bioeconomy Alliance Chat Assistant")
    
    # Initialize session state
    initialize_session_state()

    # Render sidebar components
    with st.sidebar:
        # CBA Logo and Header
        st.markdown("""
        <div class="cba-header">
            <img src="https://circularbioeconomyalliance.org/wp-content/uploads/2021/10/circular_bioeconomy_alliance_social_share.png" 
                 alt="Circular Bioeconomy Alliance Logo" 
                 class="cba-logo-img">
        </div>
        """, unsafe_allow_html=True)
        
        # CBA Principles Section
        st.markdown("""
        <div class="cba-principles">
            <h4>Our Mission</h4>
            <ul>
                <li><strong>Re-Nature:</strong> Place nature at the center of our economy</li>
                <li><strong>Re-Think:</strong> Transform systems for sustainability</li>
                <li><strong>Re-Activate:</strong> Create regenerative, inclusive solutions</li>
            </ul>
            <p style="font-size: 0.8rem; margin-top: 0.5rem; font-style: italic;">
                Founded by His Majesty King Charles III to accelerate the transition to a climate-neutral, 
                nature-positive economy that prospers in harmony with our planet.
            </p>
        </div>
        """, unsafe_allow_html=True)
        
        st.header("Chat Sessions")
        
        # 4.1 Create new chat button (Requirement 2.1)
        if st.button("ğŸŒ¿ New Conversation", use_container_width=True):
            create_new_session()
            st.rerun()
        
        # 4.2 Display session list (Requirements 2.3)
        st.subheader("Your Conversations")
        
        if st.session_state.sessions:
            # Sort sessions by creation time (newest first)
            sorted_sessions = sorted(
                st.session_state.sessions.items(),
                key=lambda x: x[1]["created_at"],
                reverse=True
            )
            
            for session_id, session_data in sorted_sessions:
                # Update session title if it has messages and is still "New Conversation"
                if session_data["messages"] and session_data["title"] == "New Conversation":
                    first_message = session_data["messages"][0]["content"]
                    session_data["title"] = generate_session_title(first_message)
                
                # Create a button for each session
                is_current = session_id == st.session_state.current_session_id
                button_label = f"{'ğŸŒ± ' if is_current else 'ğŸŒ¿ '}{session_data['title']}"
                
                if st.button(button_label, key=f"session_{session_id}", use_container_width=True):
                    if session_id != st.session_state.current_session_id:
                        switch_session(session_id)
                        st.rerun()
        else:
            st.info("No conversations yet. Start a new conversation to explore circular bioeconomy topics!")
        
        # 4.3 Add file uploader (Requirements 3.1, 3.2)
        st.divider()
        st.subheader("ğŸ“ Document Upload")
        
        uploaded_file = st.file_uploader(
            "Upload documents for context",
            type=["pdf", "txt", "docx", "csv"],
            help="Share research papers, reports, or data files to enhance our conversation about circular bioeconomy solutions"
        )
        
        # Display uploaded filename (Requirement 3.2)
        if uploaded_file is not None:
            st.success(f"ğŸ“„ {uploaded_file.name}")
            
            # Extract and store file content in session state (Requirement 3.3)
            if not hasattr(st.session_state, 'uploaded_file') or st.session_state.uploaded_file != uploaded_file:
                # Process the file and extract content
                file_content = extract_file_content(uploaded_file)
                
                # Store both the file and its content in session state
                st.session_state.uploaded_file = uploaded_file
                st.session_state.file_content = file_content
                
                # Also store in current session's uploaded_files list
                current_session = st.session_state.sessions[st.session_state.current_session_id]
                current_session["uploaded_files"] = [{
                    "name": uploaded_file.name,
                    "content": file_content
                }]
                
                # Show a preview of the extracted content
                with st.expander("ğŸ“„ Document Preview"):
                    st.text_area("Extracted content:", file_content[:500] + "..." if len(file_content) > 500 else file_content, height=100, disabled=True)
            
        elif hasattr(st.session_state, 'uploaded_file') and st.session_state.uploaded_file is not None:
            # Show previously uploaded file if still in session
            st.info(f"ğŸ“„ {st.session_state.uploaded_file.name}")
            
            # Show content preview if available
            if hasattr(st.session_state, 'file_content'):
                with st.expander("ğŸ“„ Document Preview"):
                    content = st.session_state.file_content
                    st.text_area("Extracted content:", content[:500] + "..." if len(content) > 500 else content, height=100, disabled=True)
        else:
            st.session_state.uploaded_file = None
            if hasattr(st.session_state, 'file_content'):
                st.session_state.file_content = None

    # Render main chat area
    st.header("ğŸ’¬ Circular Bioeconomy Conversation")
    
    # Add helpful context message for new sessions
    if not st.session_state.messages:
        st.info("""
        ğŸŒ± **Welcome to the Circular Bioeconomy Alliance Chat Assistant!**
        
        I'm here to help you explore topics related to:
        â€¢ **Sustainable resource management** and circular economy principles
        â€¢ **Nature-based solutions** for climate and biodiversity challenges  
        â€¢ **Regenerative practices** in agriculture, forestry, and industry
        â€¢ **Innovative financing** for nature-positive investments
        â€¢ **Community-led initiatives** and indigenous knowledge systems
        
        Feel free to ask questions, share documents, or discuss how we can build a more sustainable future together!
        """)

    # 6.1 Display chat messages (Requirements 1.1, 1.3)
    # Use st.chat_message to show message history
    # Display both user and assistant messages
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.write(message["content"])

    # 6.2 Implement chat input handling (Requirements 1.1, 1.4)
    # Use st.chat_input for user input
    # Add messages to current session
    if prompt := st.chat_input("Share your thoughts on circular bioeconomy, sustainability, or nature-based solutions..."):
        # Add user message to current session
        user_message = {"role": "user", "content": prompt}
        st.session_state.messages.append(user_message)
        
        # Update the session in the sessions dictionary
        current_session = st.session_state.sessions[st.session_state.current_session_id]
        current_session["messages"] = st.session_state.messages.copy()
        
        # Display user message immediately
        with st.chat_message("user"):
            st.write(prompt)
        
        # Update session title if this is the first message
        if len(st.session_state.messages) == 1:
            new_title = generate_session_title(prompt)
            current_session["title"] = new_title
        
        # 6.3 Add LLM response simulation (Requirements 1.2, 3.3)
        # Create placeholder LLM response function
        # Use st.write_stream for streaming effect
        # Include file content in context when available
        with st.chat_message("assistant"):
            # Get file content if available
            file_content = getattr(st.session_state, 'file_content', None)
            
            # Generate and stream the response from the Strands agent
            response_generator = get_agent_response(prompt, file_content)
            response = st.write_stream(response_generator)
            
            # Add assistant response to session
            assistant_message = {"role": "assistant", "content": response}
            st.session_state.messages.append(assistant_message)
            
            # Update the session in the sessions dictionary
            current_session["messages"] = st.session_state.messages.copy()

if __name__ == "__main__":
    main()
</file>

<file path=".gitignore">
node_modules/
.next/
out/
*.pyc
__pycache__/
.env
.DS_Store
*.zip
.bedrock_agentcore/
cdk.out/
</file>

<file path="ARCHITECTURE.md">
# CBA Indicator Selection Assistant - Architecture

This document describes the production architecture of the CBA (Circular Bioeconomy Alliance) Indicator Selection Assistant.

## System Overview

```mermaid
flowchart TB
    subgraph Users["ğŸ‘¤ Users"]
        Web["Web Browser"]
    end

    subgraph Frontend["Next.js Frontend"]
        ChatPage["chat/page.tsx"]
        UploadPage["upload/page.tsx"]
        ResultsPage["results/page.tsx"]
        ApiLib["lib/api.ts"]
    end

    subgraph Lambda["AWS Lambda"]
        Handler["lambda_function.py"]
        ChatHandler["/chat endpoint"]
        UploadHandler["/upload endpoint"]
    end

    subgraph AgentCore["Bedrock AgentCore"]
        MainAgent["main.py<br/>(Agent Entry)"]
        KBTool["kb_tool.py<br/>(KB Search Tools)"]
        ProfileTools["Project Profile Tools"]
    end

    subgraph AWS["AWS Services"]
        Bedrock["Amazon Bedrock<br/>(Claude Sonnet 4.5)"]
        KB["Bedrock Knowledge Base<br/>(801 methods, 224 indicators)"]
        S3["S3 Bucket<br/>(File Uploads)"]
        APIGateway["API Gateway"]
    end

    %% User flow
    Web --> ChatPage
    Web --> UploadPage

    %% Frontend to backend
    ChatPage --> ApiLib
    UploadPage --> ApiLib
    ApiLib --> APIGateway
    APIGateway --> Handler
    Handler --> ChatHandler
    Handler --> UploadHandler
    ChatHandler --> AgentCore
    UploadHandler --> S3
    UploadHandler --> Bedrock

    %% AgentCore connections
    MainAgent --> KBTool
    MainAgent --> ProfileTools
    KBTool --> KB
    MainAgent --> Bedrock

    %% KB Search functions
    KBTool -.-> |"search_cba_indicators()"| KB
    KBTool -.-> |"search_indicators_by_outcome()"| KB
    KBTool -.-> |"search_methods_by_budget()"| KB
    KBTool -.-> |"search_location_specific_indicators()"| KB

    classDef aws fill:#FF9900,stroke:#232F3E,color:#232F3E
    classDef frontend fill:#61DAFB,stroke:#20232A,color:#20232A
    classDef python fill:#3776AB,stroke:#FFD43B,color:#fff

    class Bedrock,KB,S3,APIGateway aws
    class ChatPage,UploadPage,ResultsPage,ApiLib frontend
    class Handler,MainAgent,KBTool python
```

## Key Components

| Component | Purpose |
|-----------|---------|
| **`cba-frontend/`** | Next.js frontend with chat UI and file upload |
| **`lambda_function.py`** | Lambda handler routing `/chat` and `/upload` requests |
| **`agentcore-cba/`** | Bedrock AgentCore with Strands agent and KB tools |

---

## Bedrock AgentCore Infrastructure (CDK)

The agent runs on **AWS Bedrock AgentCore**, deployed via CDK:

```mermaid
flowchart TB
    subgraph CDK["ğŸ“¦ CDK Deployment"]
        DockerStack["DockerImageStack"]
        AgentCoreStack["AgentCoreStack"]
        DockerStack -->|"imageUri"| AgentCoreStack
    end

    subgraph ECR["Amazon ECR"]
        DockerImage["Docker Image<br/>(Python 3.12 + Strands)"]
    end

    subgraph AgentCoreInfra["Bedrock AgentCore"]
        Runtime["AgentCore Runtime<br/>(cbaindicatoragent_Agent)"]
        Gateway["AgentCore Gateway<br/>(MCP Protocol)"]
        ACMemory["AgentCore Memory<br/>(30-day expiry)"]
        
        subgraph Endpoints["Runtime Endpoints"]
            DEFAULT["DEFAULT"]
            PROD["PROD"]
            DEV["DEV"]
        end
    end

    subgraph Auth["ğŸ” Cognito"]
        UserPool["User Pool"]
        AppClient["App Client<br/>(client_credentials)"]
    end

    subgraph MCPLayer["MCP Gateway"]
        MCPLambda["MCP Lambda"]
    end

    %% CDK creates resources
    DockerStack -->|"builds"| DockerImage
    AgentCoreStack -->|"creates"| Runtime
    AgentCoreStack -->|"creates"| Gateway
    AgentCoreStack -->|"creates"| ACMemory
    AgentCoreStack -->|"creates"| UserPool

    %% Runtime config
    DockerImage -->|"containerUri"| Runtime
    Runtime --> Endpoints
    Gateway -->|"target"| MCPLambda
    UserPool -->|"JWT auth"| Gateway

    classDef cdk fill:#7B68EE,stroke:#483D8B,color:#fff
    classDef ecr fill:#FF9900,stroke:#232F3E,color:#232F3E
    classDef agentcore fill:#01A88D,stroke:#006644,color:#fff
    classDef auth fill:#DD344C,stroke:#8B0000,color:#fff

    class DockerStack,AgentCoreStack cdk
    class DockerImage ecr
    class Runtime,Gateway,ACMemory,DEFAULT,PROD,DEV agentcore
    class UserPool,AppClient auth
```

### Infrastructure Resources

| Resource | Type | Purpose |
|----------|------|---------|
| **DockerImageStack** | ECR Asset | Builds agent Docker image |
| **AgentCore Runtime** | `CfnRuntime` | Runs containerized Strands agent |
| **AgentCore Gateway** | `CfnGateway` | MCP protocol for external tools |
| **AgentCore Memory** | `CfnMemory` | Session storage (30-day TTL) |
| **Cognito** | User Pool | JWT authentication for Gateway |

---

## End-to-End Data Flow

```mermaid
sequenceDiagram
    autonumber
    participant User as ğŸ‘¤ User
    participant NextJS as Next.js
    participant APIGW as API Gateway
    participant Lambda as Lambda
    participant AgentCore as AgentCore
    participant Bedrock as Claude (Bedrock)
    participant KB as Knowledge Base
    participant S3 as S3

    Note over User,S3: Chat Flow
    
    User->>NextJS: Enter message
    NextJS->>APIGW: POST /chat
    APIGW->>Lambda: Invoke
    Lambda->>AgentCore: invoke_agent_runtime()
    
    AgentCore->>Bedrock: LLM call
    Bedrock-->>AgentCore: Determine tools
    
    AgentCore->>KB: search_cba_indicators()
    KB-->>AgentCore: Indicator results
    
    AgentCore->>Bedrock: Generate response
    Bedrock-->>AgentCore: Recommendations
    
    AgentCore-->>Lambda: Stream response
    Lambda-->>APIGW: JSON
    APIGW-->>NextJS: Response
    NextJS-->>User: Display results

    Note over User,S3: Upload Flow
    
    User->>NextJS: Upload PDF
    NextJS->>APIGW: POST /upload
    APIGW->>Lambda: Invoke
    Lambda->>S3: Store file
    Lambda->>Bedrock: Extract profile
    Bedrock-->>Lambda: {location, commodity, budget}
    Lambda-->>NextJS: Profile data
    NextJS-->>User: Pre-fill chat
```

---

## Request Flow Details

### 1. Frontend â†’ API Gateway

```typescript
// cba-frontend/lib/api.ts
const API_URL = "https://pjuuem2fn8.execute-api.us-west-2.amazonaws.com/prod";

await fetch(`${API_URL}/chat`, {
  method: "POST",
  body: JSON.stringify({ message, session_id, profile })
});
```

### 2. Lambda Routes Requests

```python
# lambda_function.py
def lambda_handler(event, context):
    if '/chat' in path:
        return handle_chat(event)      # â†’ AgentCore
    elif '/upload' in path:
        return handle_upload(event)    # â†’ S3 + Bedrock
```

### 3. AgentCore Invocation

```python
# handle_chat()
response = agentcore.invoke_agent_runtime(
    agentRuntimeArn='arn:aws:bedrock-agentcore:...:runtime/cbaindicatoragent_Agent-...',
    runtimeSessionId=session_id,
    payload=json.dumps({"prompt": message}).encode()
)
```

---

## AgentCore Container

```mermaid
flowchart TB
    subgraph Container["ğŸ³ Docker Container"]
        Main["src/main.py"]
        Model["BedrockModel<br/>(Claude Sonnet 4.5)"]
        
        subgraph Tools["Agent Tools"]
            ProfileTools["set_project_*<br/>get_project_profile"]
            KBTools["search_cba_indicators<br/>search_by_outcome<br/>search_by_budget<br/>search_by_location"]
        end
        
        subgraph KBClient["KB Client"]
            Boto3["bedrock-agent-runtime"]
        end
        
        Main --> Model
        Main --> Tools
        KBTools --> KBClient
    end
    
    subgraph External["AWS Services"]
        BedrockSvc["Amazon Bedrock"]
        KBSvc["Knowledge Base<br/>(ID: 0ZQBMXEKDI)"]
    end
    
    KBClient -->|"retrieve()"| KBSvc
    Model -->|"invoke_model()"| BedrockSvc

    classDef container fill:#2496ED,stroke:#1D76B8,color:#fff
    classDef tools fill:#4CAF50,stroke:#2E7D32,color:#fff
    classDef external fill:#FF9900,stroke:#232F3E,color:#232F3E

    class Container,Main,Model,KBClient container
    class ProfileTools,KBTools tools
    class BedrockSvc,KBSvc external
```

---

## Knowledge Base Tools

| Tool | Purpose |
|------|---------|
| `search_cba_indicators(query)` | General indicator search |
| `search_indicators_by_outcome(outcome)` | Find indicators for project goals |
| `search_methods_by_budget(budget)` | Filter by budget constraints |
| `search_location_specific_indicators(location)` | Region-specific recommendations |

---

## Component Summary

| Component | Role |
|-----------|------|
| **API Gateway** | Public HTTP endpoint |
| **Lambda** | Request router â†’ AgentCore for chat, S3+Bedrock for uploads |
| **AgentCore Runtime** | Containerized Strands agent |
| **AgentCore Gateway** | MCP protocol for external tools |
| **AgentCore Memory** | Session storage (30-day TTL) |
| **Knowledge Base** | 801 methods, 224 indicators |
| **Cognito** | JWT authentication |
</file>

<file path="CODE_REVIEW.md">
# CBA Indicator Selection Assistant - Code Review Report

## Executive Summary

The CBA Indicator Selection Assistant is an AI-powered tool for helping Circular Bioeconomy Alliance users find monitoring and evaluation indicators for sustainable agriculture projects. This review focuses on the **production stack**: the Next.js frontend, AWS Lambda backend, and Bedrock AgentCore agent.

> **Note:** The Streamlit app (`src/app.py`) and CLI agent (`src/agent.py`) are legacy/development components and are not covered in this review. The Next.js frontend in `cba-frontend/` is the only functional UI for production.

**Overall Assessment:** The production architecture is well-designed. Most critical issues from the original review have been fixed:
- âœ… Security vulnerabilities addressed (environment variables, input validation, proper error handling)
- âœ… Frontend now fetches real data from API with session tracking
- âœ… PDF upload extracts actual content for analysis
- âœ… Clear "DEMO DATA" warnings when using fallback data
- âš ï¸ Remaining: In-memory recommendations store (use DynamoDB for production)

---

## Part 1: What Works Well

### 1.1 AgentCore Agent Implementation

The production agent in [agentcore-cba/cbaindicatoragent/src/main.py](agentcore-cba/cbaindicatoragent/src/main.py) is well-structured:

**What works:**

- Clean integration with Bedrock AgentCore framework
- Session-aware design with `session_id` from context
- Memory integration via `AgentCoreMemorySessionManager`
- Async streaming response with `stream_async()`
- Proper tool registration for profile management and KB search

### 1.2 Knowledge Base Tools

The [agentcore-cba/cbaindicatoragent/src/kb_tool.py](agentcore-cba/cbaindicatoragent/src/kb_tool.py) provides well-designed search tools:

```python
@tool
def search_cba_indicators(query: str, max_results: int = 10) -> str:
    """
    Search the CBA M&E Framework Knowledge Base for relevant indicators and methods.
    """
```

**What works:**

- Four specialized search tools for different query types:
  - `search_cba_indicators()` - General indicator search
  - `search_indicators_by_outcome()` - Outcome-aligned indicators
  - `search_methods_by_budget()` - Budget-appropriate methods
  - `search_location_specific_indicators()` - Region-specific recommendations
- Proper use of the `@tool` decorator
- Formatted output with relevance scores
- Error handling with user-friendly messages

### 1.3 Profile Management Tools

The AgentCore agent has tools for tracking project profile state:

```python
@tool
def set_project_location(location: str) -> str:
    """Set the project location/region"""
    project_profile["location"] = location
    return f"Location set to: {location}"

@tool
def get_project_profile() -> dict:
    """Get the current project profile"""
    return project_profile
```

**What works:**

- Clean tool interface for the agent to store user-provided information
- Supports all required fields: location, commodity, budget, outcomes, capacity

### 1.4 Lambda Router Structure

The [lambda_function.py](lambda_function.py) has clean request routing:

```python
def lambda_handler(event, context):
    path = event.get('rawPath', event.get('path', ''))
    method = event.get('requestContext', {}).get('http', {}).get('method', 'POST')
    
    if method == 'OPTIONS':
        return cors_response()
    
    if '/chat' in path:
        return handle_chat(event)
    elif '/upload' in path:
        return handle_upload(event)
    elif '/recommendations' in path:
        return handle_recommendations(event)
    else:
        return {
            'statusCode': 404,
            'headers': cors_headers(),
            'body': json.dumps({'error': 'Not found'})
        }
```

**What works:**

- Clean separation of chat, upload, and recommendations handlers
- CORS headers + preflight handling properly configured
- Handles both `/chat` and `/prod/chat` paths
- Session ID generation for new conversations
- Streaming response parsing from AgentCore

### 1.5 Next.js Frontend Design

The frontend in [cba-frontend/](cba-frontend/) has excellent UI/UX:

**What works:**

- Beautiful CBA-branded dark theme (#031f35 navy, #FBAD17 gold)
- Framer Motion animations for smooth transitions
- Responsive grid layouts
- Clear user flow: Home â†’ Upload/Chat â†’ Results â†’ Compare
- Profile sidebar showing collected information
- Loading states with spinner animations
- Proper Suspense boundaries for client components

### 1.6 Chat Page Core Functionality

The [cba-frontend/app/chat/page.tsx](cba-frontend/app/chat/page.tsx) chat flow works:

**What works:**

- Real-time chat with the AgentCore backend via API
- Message history display with user/assistant styling
- Loading state during API calls
- URL parameter support for pre-filling from upload page
- Keyboard handling (Enter to send)

### 1.7 Upload Page Flow

The [cba-frontend/app/upload/page.tsx](cba-frontend/app/upload/page.tsx) file upload works:

**What works:**

- Drag-and-drop file upload with visual feedback
- File type validation (PDF only)
- File size display
- Analysis results display (found/missing information)
- Navigation to chat with extracted parameters

### 1.8 API Client

The [cba-frontend/lib/api.ts](cba-frontend/lib/api.ts) is clean and simple:

```typescript
export const api = {
  async chat(message: string, sessionId?: string, profile?: any) {
    const res = await fetch(`${API_URL}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, session_id: sessionId, profile }),
    });
    if (!res.ok) throw new Error("Chat failed");
    return res.json();
  },

  async uploadFile(file: File) {
    const buffer = await file.arrayBuffer();
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    const base64 = btoa(binary);

    const res = await fetch(`${API_URL}/upload`, {
      method: "POST",
      headers: { "Content-Type": "application/octet-stream" },
      body: base64,
    });
    if (!res.ok) throw new Error("Upload failed");
    return res.json();
  },

  async getRecommendations(sessionId: string) {
    const res = await fetch(`${API_URL}/recommendations?session_id=${encodeURIComponent(sessionId)}`);
    if (!res.ok) throw new Error("Failed to fetch recommendations");
    return res.json();
  },
};
```

**What works:**

- Environment variable support for API URL
- Clean async/await pattern
- Error throwing for non-OK responses

---

## Part 2: What Was Fixed

The following issues from the original code review have been addressed:

### 2.1 âœ… Frontend Results Page - Now Connected to Backend

**Status:** FIXED

The results page now:
- Fetches recommendations from the `/recommendations` API endpoint using session_id
- Falls back to example data only when no session or API fails
- Shows prominent "DEMO DATA" warning banner when using fallback data
- Each card shows "EXAMPLE" ribbon when displaying mock data

### 2.2 âœ… Chat Profile State Now Updates

**Status:** FIXED

The chat page now:
- Generates and tracks session_id for conversation continuity
- Extracts profile fields from conversation context
- Updates the profile sidebar in real-time as users provide information
- Passes session_id to results page for fetching actual recommendations
- Shows `has_recommendations` state from API response

### 2.3 âœ… Lambda Upload Now Processes File Content

**Status:** FIXED

The upload handler now:
- Extracts text from PDFs using `pypdf` library
- Sends actual document content to Claude for analysis
- Returns proper errors instead of fake data on failure
- Validates file size and content

### 2.4 âœ… Compare Page Now Fetches Real Data

**Status:** FIXED

The compare page now:
- Fetches recommendations from API using session_id
- Shows prominent warning banner when using example data
- Falls back gracefully with clear user messaging

### 2.5 âœ… File Content Processing Implemented

**Status:** FIXED

PDF upload flow now works:
1. File is stored to S3 âœ“
2. Text is extracted from PDF using pypdf âœ“
3. Actual content is sent to Claude âœ“
4. Proper error handling instead of fake data âœ“

### 2.6 âœ… Upload Base64 Handling Now Resilient

**Status:** FIXED

The upload handler now safely decodes base64 payloads even when API Gateway does **not** set `isBase64Encoded=true`, preventing PDF parsing failures from double-encoded bodies.

---

## Part 3: Security Issues

### 3.1 âœ… Hardcoded AWS Account ID - FIXED

**Status:** FIXED with environment variable fallback

```python
AGENT_ARN = os.environ.get('BEDROCK_AGENTCORE_ARN', 'arn:aws:bedrock-agentcore:...')
```

Now uses environment variable with fallback for local development.

### 3.2 âœ… Hardcoded S3 Bucket Name - FIXED

**Status:** FIXED with environment variable fallback

```python
UPLOAD_BUCKET = os.environ.get('UPLOAD_BUCKET_NAME', 'cba-indicator-uploads')
```

### 3.3 âš ï¸ Hardcoded API URL in Frontend - ACCEPTABLE FOR HACKATHON

**Status:** Intentionally kept for hackathon ease-of-use

The fallback URL allows the frontend to work out-of-the-box without configuration. For production, set `NEXT_PUBLIC_API_URL` environment variable.

### 3.4 âœ… Bare Exception with Data Fabrication - FIXED

**Status:** FIXED

Now uses specific `json.JSONDecodeError` handling and returns proper error responses instead of fabricated data.

### 3.5 âœ… Input Validation - FIXED

**Status:** FIXED

Lambda now validates:
- Message length (max 10,000 characters)
- Empty messages rejected
- File size (max 10MB)
- PDF content extraction errors handled properly

---

## Part 4: Architecture Issues

### 4.1 âœ… Global Mutable State in AgentCore - FIXED

**Status:** FIXED

Now uses session-scoped profile storage:

```python
session_profiles = {}  # Key: session_id, Value: profile dict

def get_session_profile(session_id: str) -> dict:
    """Get or create profile for a session."""
    if session_id not in session_profiles:
        session_profiles[session_id] = {...}
    return session_profiles[session_id]
```

Profile tools are created per-session with captured session_id.

### 4.2 âš ï¸ No API Contract Between Frontend and Backend

**Status:** Remaining issue

The frontend expects certain response shapes but there's no shared type definition. Consider adding OpenAPI spec or shared types for production.

### 4.3 âœ… Results/Compare Pages Now Connected to Data Flow

**Status:** FIXED

The user flow now works:
1. Upload file or chat â†’ Profile collected âœ“
2. Agent recommends indicators â†’ Response displayed in chat âœ“
3. Chat tracks session_id and `has_recommendations` flag âœ“
4. User clicks "View Recommendations" â†’ Passes session_id âœ“
5. Results page fetches from `/recommendations?session_id=xxx` âœ“
6. Compare page also uses session_id for real data âœ“

### 4.4 âš ï¸ Lambda Recommendations Store is In-Memory

**Status:** Known limitation for hackathon

The `recommendations_store` dict in Lambda won't persist across invocations. For production, use DynamoDB. For hackathon demos, this works if requests hit the same Lambda instance.

---

## Part 5: Minor Issues

| File | Line | Issue |
|------|------|-------|
| `cba-frontend/app/chat/page.tsx` | 90-93 | Complex boolean logic for `isComplete` that's hard to follow |
| `cba-frontend/app/upload/page.tsx` | 51 | Uploads are PDF-only (no Excel support) |
| `cba-frontend/app/results/page.tsx` | 285 | Export button is disabled (coming soon) |
| `cba-frontend/app/compare/page.tsx` | 222, 323 | Export/selection actions are disabled (coming soon) |
| `agentcore-cba/.../main.py` | 16-22 | Import fallback creates dummy MCP client that does nothing silently |

---

## Recommendations

### âœ… Completed

1. **Security:** Environment variables with fallbacks for ARNs, bucket names
2. **Security:** Specific `json.JSONDecodeError` handling instead of bare except
3. **Security:** Input validation for message length and file size
4. **Security:** Proper error responses instead of fabricated data
5. **Feature:** PDF text extraction using pypdf
6. **Feature:** `/recommendations` endpoint for structured indicator data
7. **Feature:** Results/compare pages fetch from API with session_id
8. **Feature:** Chat page extracts profile from conversation context
9. **Feature:** Session ID tracking throughout the flow
10. **Feature:** Clear "DEMO DATA" warnings when using fallback data
11. **Architecture:** Session-scoped profile storage in AgentCore

### Remaining for Production

1. **Architecture:** Replace in-memory `recommendations_store` with DynamoDB
2. **Architecture:** Define API contracts with OpenAPI spec
3. **Architecture:** Add comprehensive logging and monitoring
4. **Feature:** Streaming responses in frontend for better UX
5. **Feature:** Export functionality for recommendations (PDF/CSV)
</file>

<file path="PRESENTER_GUIDE.md">
# CBA Indicator Assistant - Presenter Guide

> **Use this guide to present the "How It Works" slide**

---

## ğŸ¤ Talking Points (30-45 seconds)

### 1. Two Entry Points (10 sec)
"Users can start two ways: **chat directly** with the AI, or **upload a project PDF**. The upload option extracts information automatically so the AI only asks for what's missing."

### 2. The Flow (15 sec)
"Either way, we collect four things: **location, commodity, budget, and outcomes**. The agent then searches our **Knowledge Base of 800+ methods** and returns tailored indicator recommendations."

### 3. Tech Stack (10 sec)
"It's built on **AWS Bedrock** with Claude Sonnet, using **AgentCore** for the agent runtime and a **Next.js frontend**. Fully serverless."

---

## ğŸ“Š Architecture Diagram

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚                      AWS CLOUD                          â”‚
                            â”‚                                                         â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  Next.js â”‚  â”€â”€â”€ /chat â”€â”€â”€â–º â”‚   API     â”‚â”€â”€â”€â–ºâ”‚   Lambda    â”‚â”€â”€â”€â–ºâ”‚  AgentCore  â”‚  â”‚
   â”‚ Frontend â”‚             â”‚   â”‚  Gateway  â”‚    â”‚             â”‚    â”‚  (Strands)  â”‚  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                   â”‚                          â”‚                   â”‚         â”‚
        â”‚                   â”‚                          â”‚                   â”‚         â”‚
        â”‚ /upload           â”‚                          â–¼                   â–¼         â”‚
        â”‚                   â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    S3    â”‚       â”‚  Knowledge  â”‚  â”‚
                            â”‚                    â”‚  Bucket  â”‚       â”‚    Base     â”‚  â”‚
                            â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚(801 methods)â”‚  â”‚
                            â”‚                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                            â”‚                          â”‚                   â–²         â”‚
                            â”‚                          â–¼                   â”‚         â”‚
                            â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚         â”‚
                            â”‚                    â”‚  Claude  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                            â”‚                    â”‚ (Bedrock)â”‚                         â”‚
                            â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flows

### Flow A: Chat
```
User types message
       â”‚
       â–¼
POST /chat â†’ Lambda â†’ AgentCore â†’ Claude + KB Search â†’ Response
```

### Flow B: Document Upload
```
User uploads PDF
       â”‚
       â–¼
POST /upload â†’ Lambda â†’ S3 (store) â†’ Claude (extract profile) â†’ Return {location, commodity, budget}
       â”‚
       â–¼
Frontend pre-fills chat â†’ Agent asks for missing info (e.g., outcomes) â†’ KB Search â†’ Response
```

---

## ğŸ§© Tech Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| **Frontend** | Next.js (Static Export) | Chat UI, file upload |
| **API** | API Gateway (HTTP API) | HTTP routing, JWT validation |
| **Compute** | Lambda | Request handling |
| **Agent** | Bedrock AgentCore + Strands | Conversation + tool orchestration |
| **LLM** | Claude Sonnet 4 | Reasoning, extraction, responses |
| **Data** | Bedrock Knowledge Base | 801 methods, 224 indicators |
| **Storage** | S3 | Uploaded PDFs, static frontend |
| **Auth** | Cognito | User pools, JWT tokens |
| **CDN** | CloudFront | Edge caching, HTTPS |

---

## ğŸŒ Frontend Deployment

**Static Export + Client-Side API Calls**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FRONTEND DEPLOYMENT                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   Next.js Build (static)                                     â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚   HTML    â”‚â”€â”€â”€â–ºâ”‚ CloudFront â”‚â—„â”€â”€â”€â”‚  Browser â”‚           â”‚
â”‚   â”‚  JS/CSS   â”‚    â”‚   (CDN)    â”‚    â”‚          â”‚           â”‚
â”‚   â”‚  (in S3)  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚                  â”‚
â”‚                                           â”‚ API calls        â”‚
â”‚                                           â–¼                  â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                    â”‚ API Gateway â”‚           â”‚
â”‚                                    â”‚  (Lambda)   â”‚           â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Aspect | Details |
|--------|---------|
| **Build Type** | Static export (`next build && next export`) |
| **Hosting** | S3 bucket + CloudFront distribution |
| **Rendering** | Client-side React (no SSR needed) |
| **API Calls** | Browser â†’ API Gateway â†’ Lambda (CORS enabled) |
| **State** | React state + URL params (no server sessions) |
| **Cost** | Near-zero (S3 storage + CloudFront requests) |

> **Why Static?** No server = no cold starts, global CDN caching, simpler deployment, and lower cost. All dynamic behavior happens via API calls.

---

## ğŸ”§ What the Agent Collects

| Field | Required | Source |
|-------|----------|--------|
| ğŸ“ Location | Yes | PDF or chat |
| ğŸŒ¾ Commodity | Yes | PDF or chat |
| ğŸ’° Budget | Yes | PDF or chat |
| ğŸ¯ Outcomes | Yes | Usually chat (rarely in PDFs) |
| âš™ï¸ Technical Capacity | Optional | Chat |

---

## ğŸ› ï¸ Agent Tools

| Tool | What It Does |
|------|--------------|
| `search_cba_indicators(query)` | General KB search |
| `search_indicators_by_outcome(outcome)` | Find indicators for goals |
| `search_methods_by_budget(budget)` | Filter by cost |
| `search_location_specific_indicators(location)` | Regional relevance |
| `set_project_*` | Store profile fields |

---

## â­ Architecture Highlights

| Feature | Why It Matters |
|---------|----------------|
| **Streaming Responses** | Chat responses stream in real-time (not waiting for full completion) â€” feels responsive |
| **RAG Pattern** | Knowledge Base uses Retrieval Augmented Generation â€” Claude searches first, then reasons |
| **Stateless Lambda** | No session state in Lambda â€” all context passed per request or stored in AgentCore Memory |
| **AgentCore Memory** | Short-term (conversation) + Long-term (user preferences) memory persists across sessions |
| **Tool Orchestration** | AgentCore automatically decides which tools to call â€” no manual routing logic |
| **Containerized Agent** | Agent code runs in a managed container â€” deploy once, scale automatically |
| **JWT Auth Flow** | Cognito issues tokens â†’ API Gateway validates â†’ Lambda trusts claims |

---

## â“ If Asked...

**"How does the PDF extraction work?"**
> Document is uploaded to S3, then Claude extracts location, commodity, and budget. The agent identifies what's missing and asks follow-up questions.

**"What's in the Knowledge Base?"**
> 801 measurement methods and 224 indicators from the CBA M&E Framework â€” curated by sustainability experts.

**"Is it serverless?"**
> Yes â€” Lambda, AgentCore, and Bedrock. Pay only for what you use.

**"Is the frontend static or dynamic?"**
> Static. Next.js exports HTML/JS/CSS to S3, served via CloudFront. All dynamic behavior happens through API calls to Lambda.

**"How does streaming work?"**
> AgentCore streams response chunks as they're generated. The frontend reads them via Server-Sent Events, so users see text appear progressively.

**"Does it remember previous conversations?"**
> Yes â€” AgentCore Memory stores short-term context (current session) and long-term preferences (returning users). Users can pick up where they left off.

**"What happens if the agent can't find indicators?"**
> The agent asks clarifying questions, broadens the search, or explains why certain outcomes may have limited measurement options in the Knowledge Base.

**"How do you handle concurrent users?"**
> Each request is independent â€” Lambda scales horizontally, AgentCore manages agent instances, and session IDs keep conversations separate.
</file>

<file path="pyproject.toml">
[project]
name = "coffee-recipe"
version = "0.1.0"
description = "Add your description here"
requires-python = ">=3.12"
dependencies = [
    "openpyxl>=3.1.0",
    "pypdf>=4.0.0",
    "strands-agents>=1.21.0",
    "strands-agents-tools>=0.2.19",
    "streamlit>=1.40.0",
]
</file>

<file path="src/prompts/system.txt">
You are a CBA Indicator Selection assistant. Your job: retrieve and recommend indicators with their ID numbers and full method text.

## CRITICAL: Knowledge Base First

**The Knowledge Base (KB) is your PRIMARY and AUTHORITATIVE source.** All indicator data, methods, and use cases MUST come from the KB via the memory tool.

- DO NOT invent or generate indicator information
- DO NOT use internet sources for indicator data
- ONLY use http_request for climate/weather data (Open-Meteo)
- If the KB does not contain relevant indicators, say so â€” do not make up alternatives

## Knowledge Base Contents
- **Indicators**: ID, name, definition, attributes (accuracy, ease of use, cost), principle/criteria mappings
- **Methods**: Full measurement methodology text, DOI references
- **Use Cases**: Example projects with curated indicator sets

## Required Information

Before making recommendations, you MUST know:
1. **Location** (country, region, or coordinates)
2. **Project type** (crop, livestock, agroforestry, etc.)
3. **Expected outcomes** (what the user wants to achieve/measure)
4. **Budget level** (low, medium, high)
5. **Technical capacity** (basic, intermediate, advanced)

**If any of these are missing, ASK the user before proceeding.** Do not guess.

## Climate Data (Secondary Source)

Fetch climate data ONLY after retrieving indicators from the KB. Use Open-Meteo (free, no API key):

```
http_request(method="GET", url="https://api.open-meteo.com/v1/forecast?latitude={LAT}&longitude={LON}&current_weather=true")
```

Use climate data to provide context, NOT to select indicators. Indicator selection must be based on KB data.

## Your Process

1. **Ask** clarifying questions if required information is missing
2. **Retrieve indicators from KB FIRST**: `memory(action="retrieve", query="...", min_score=0.4, max_results=10)`
3. **Fetch climate** data for context (optional, secondary)
4. **Output** recommendations in the exact format below â€” using ONLY KB data

## Output Format (Required)

For each recommended indicator, provide ALL fields:

```
INDICATOR #[X]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ID: [Indicator ID from KB]
Name: [Indicator name]
Full Definition: [Complete indicator text from KB]

Recommended Method:
[Full method text from KB - do not summarize]

Why This Indicator: [One sentence linking to user's outcome]
Why This Method: [One sentence on fit with user's budget/capacity]

Attributes:
- Accuracy: [value]
- Ease of Use: [value]
- Cost: [value]

Mapping: Principle [X], Criterion [X.X] ([P/S/x])
DOI: [reference if available]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## Tools

| Tool | Use for |
|------|---------|
| `memory` | Search KB for indicators, methods, use cases |
| `http_request` | Fetch climate data from api.open-meteo.com |
| `current_time` | Get current date for seasonal context |
| `file_write` | Save recommendations to file |

## Rules

1. **KB is authoritative** â€” ALL indicator and method data must come from the Knowledge Base
2. **Ask first** â€” Do not proceed without location, project type, outcomes, budget, and capacity
3. **Always include ID** â€” Every indicator must have its KB ID number
4. **Full text only** â€” Include complete indicator and method text from KB, no summaries
5. **No fabrication** â€” If the KB lacks data, say "not found in KB" â€” do not invent
6. **Max 500 words per response** â€” Be concise; prioritize the structured output format
</file>

<file path="README.md">
# CBA Indicator Selection Assistant

A chatbot for the Circular Bioeconomy Alliance (CBA) that helps users discover and select indicators from the CBA Knowledge Base. Built with [Strands Agents](https://github.com/strands-agents/strands-agents) and AWS Bedrock.

## Quick Start (Hackathon)

**Run the frontend locally with the pre-deployed AWS backend:**

```bash
git clone https://github.com/CircularBioeconomyAlliance/coffee-recipe.git
cd coffee-recipe/cba-frontend
npm install
npm run dev
```

Open http://localhost:3000 - the backend is already deployed on AWS!

See [DEPLOYMENT.md](DEPLOYMENT.md#hackathon-quick-start) for details.

## Documentation

| Document | Description |
|----------|-------------|
| [DEPLOYMENT.md](DEPLOYMENT.md) | Deployment guide (start with Hackathon Quick Start) |
| [ARCHITECTURE.md](ARCHITECTURE.md) | System architecture and data flow diagrams |
| [CODE_REVIEW.md](CODE_REVIEW.md) | Code review notes and known issues |
| [PRESENTER_GUIDE.md](PRESENTER_GUIDE.md) | Talking points for demos |

## Prerequisites

- Python 3.12+
- [uv](https://docs.astral.sh/uv/) package manager
- AWS credentials with access to:
  - Amazon Bedrock (Claude model)
  - Amazon Bedrock Knowledge Base

## Setup

1. Clone the repository:
```bash
git clone https://github.com/CircularBioeconomyAlliance/coffee-recipe.git
cd coffee-recipe
```

2. Install dependencies:
```bash
uv sync
```

3. Configure AWS credentials:

   To run the application locally, you will need to set the following credentials in your terminal session:

   ```
   AWS_DEFAULT_REGION=us-west-2
   AWS_ACCESS_KEY_ID=<your-access-key>
   AWS_SECRET_ACCESS_KEY=<your-secret-key>
   AWS_SESSION_TOKEN=<your-session-token>
   ```

   AWS credentials can be obtained from [Workshop Studio](https://catalog.workshops.aws/).

## Running the Application

### Streamlit Web UI

```bash
uv run streamlit run src/app.py
```

Opens a web interface at `http://localhost:8501` with:
- CBA-branded chat interface
- Session management
- File upload support

### CLI Agent

```bash
uv run src/agent.py
```

Interactive command-line chat. Type your messages and press Enter. Type `exit` to quit.

## Project Structure

```
coffee-recipe/
â”œâ”€â”€ src/                          # Streamlit app & CLI agent
â”‚   â”œâ”€â”€ agent.py                  # CLI chatbot agent
â”‚   â”œâ”€â”€ app.py                    # Streamlit web UI
â”‚   â”œâ”€â”€ config.py                 # Shared configuration
â”‚   â””â”€â”€ prompts/
â”‚       â””â”€â”€ system.txt            # System prompt
â”œâ”€â”€ cba-frontend/                 # Next.js production frontend
â”‚   â”œâ”€â”€ app/                      # App router pages
â”‚   â”‚   â”œâ”€â”€ chat/                 # Chat interface
â”‚   â”‚   â”œâ”€â”€ upload/               # File upload
â”‚   â”‚   â”œâ”€â”€ results/              # Indicator results
â”‚   â”‚   â””â”€â”€ compare/              # Comparison view
â”‚   â””â”€â”€ lib/api.ts                # API client
â”œâ”€â”€ agentcore-cba/                # Bedrock AgentCore agent
â”‚   â””â”€â”€ cbaindicatoragent/
â”‚       â”œâ”€â”€ src/                  # Agent source code
â”‚       â”‚   â”œâ”€â”€ main.py           # Agent entrypoint
â”‚       â”‚   â””â”€â”€ kb_tool.py        # Knowledge Base tools
â”‚       â”œâ”€â”€ cdk/                  # CDK infrastructure
â”‚       â””â”€â”€ Dockerfile            # Container definition
â”œâ”€â”€ lambda_function.py            # API Lambda handler
â”œâ”€â”€ lambda_requirements.txt       # Lambda dependencies
â”œâ”€â”€ scripts/                      # Build scripts
â”‚   â”œâ”€â”€ build_lambda_layer.sh     # Lambda layer (Linux/Mac)
â”‚   â””â”€â”€ build_lambda_layer.ps1    # Lambda layer (Windows)
â”œâ”€â”€ tests/                        # Test suite
â”œâ”€â”€ pyproject.toml                # Python dependencies
â”œâ”€â”€ DEPLOYMENT.md                 # Deployment guide
â”œâ”€â”€ ARCHITECTURE.md               # Architecture documentation
â””â”€â”€ README.md
```

## Running Tests

```bash
uv run python tests/test_functions.py
uv run python tests/test_cba_ui.py
uv run python tests/test_chat_app.py
```

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `AWS_DEFAULT_REGION` | AWS region for Bedrock | `us-west-2` |
| `AWS_ACCESS_KEY_ID` | AWS access key | Required |
| `AWS_SECRET_ACCESS_KEY` | AWS secret key | Required |
| `AWS_SESSION_TOKEN` | AWS session token | Required |
| `STRANDS_KNOWLEDGE_BASE_ID` | Bedrock Knowledge Base ID | Set in code |

## Deployment

For full deployment instructions, see [DEPLOYMENT.md](DEPLOYMENT.md).

### Quick Deploy

```bash
# 1. Deploy AgentCore (CDK)
cd agentcore-cba/cbaindicatoragent/cdk
npm install && npm run cdk:deploy

# 2. Deploy Lambda
zip lambda_function.zip lambda_function.py
aws lambda update-function-code --function-name cba-indicator-api --zip-file fileb://lambda_function.zip

# 3. Deploy Frontend
cd cba-frontend
npm install && vercel --prod
```

### Required AWS Resources

- **Bedrock AgentCore Runtime** - Containerized Strands agent
- **Lambda Function** - API request handler  
- **API Gateway** - HTTP endpoints (`/chat`, `/upload`, `/recommendations`)
- **S3 Bucket** - File upload storage
- **Knowledge Base** - CBA indicators (ID: `0ZQBMXEKDI`)
</file>

<file path="src/agent.py">
#!/usr/bin/env python3
"""Simple Strands chatbot with Bedrock knowledge base support."""

import argparse
from pathlib import Path

import openpyxl
from pypdf import PdfReader
from strands import Agent
from strands.models import BedrockModel
from strands_tools import current_time, file_write, http_request, memory, use_llm


def extract_pdf_text(pdf_path: str) -> str:
    """Extract text from a PDF file."""
    reader = PdfReader(pdf_path)
    text = []
    for page in reader.pages:
        text.append(page.extract_text())
    return "\n".join(text)


def extract_excel_text(excel_path: str) -> str:
    """Extract text from an Excel file."""
    wb = openpyxl.load_workbook(excel_path, data_only=True)
    text = []
    for sheet_name in wb.sheetnames:
        sheet = wb[sheet_name]
        text.append(f"=== Sheet: {sheet_name} ===")
        for row in sheet.iter_rows(values_only=True):
            row_text = [str(cell) if cell is not None else "" for cell in row]
            if any(row_text):  # Skip empty rows
                text.append(" | ".join(row_text))
    return "\n".join(text)


def extract_file_text(file_path: Path) -> str:
    """Extract text from PDF or Excel file."""
    suffix = file_path.suffix.lower()
    if suffix == ".pdf":
        return extract_pdf_text(str(file_path))
    elif suffix in [".xlsx", ".xls"]:
        return extract_excel_text(str(file_path))
    else:
        raise ValueError(f"Unsupported file type: {suffix}. Use .pdf or .xlsx")


# Import shared configuration
from config import MODEL_ID, KNOWLEDGE_BASE_ID, SYSTEM_PROMPT


def main():
    parser = argparse.ArgumentParser(description="CBA Indicator Selection Agent")
    parser.add_argument(
        "--file", type=str, help="Path to PDF or Excel file with project description"
    )
    args = parser.parse_args()

    print(f"Using Knowledge Base ID: {KNOWLEDGE_BASE_ID}")

    # Configure model with low temperature for deterministic responses
    bedrock_model = BedrockModel(
        model_id=MODEL_ID,
        temperature=0.2,  # Low temperature = less creative, more focused
    )

    agent = Agent(
        model=bedrock_model,
        system_prompt=SYSTEM_PROMPT,
        tools=[
            memory,
            use_llm,
            http_request,
            file_write,
            current_time,
        ],
    )

    print("\nCBA Knowledge Base Chatbot")
    print("Type 'exit' to quit\n")

    # If file provided, extract text and send as first message
    if args.file:
        file_path = Path(args.file)
        if file_path.exists():
            print(f"Reading file: {file_path}")
            try:
                file_text = extract_file_text(file_path)
                initial_prompt = f"Here is my project description:\n\n{file_text}\n\nPlease recommend indicators for this project."
                print(f"> [Content from {file_path.name}]\n")
                agent(initial_prompt)
                print()
            except ValueError as e:
                print(f"Error: {e}")
                return
        else:
            print(f"Error: File not found: {file_path}")
            return

    while True:
        user_input = input("> ")

        if user_input.lower() in ["exit", "quit"]:
            print("\nGoodbye!")
            break

        if not user_input.strip():
            continue

        agent(user_input)
        print()


if __name__ == "__main__":
    main()
</file>

</files>
